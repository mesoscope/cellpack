<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cellpack.autopack.ingredient.Ingredient &mdash; cellPack 0.2.4 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> cellPack
          </a>
              <div class="version">
                0.2.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../installation.html#stable-release">Stable release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../installation.html#from-sources">From sources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">Package modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../cellpack.html">cellpack package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../cellpack.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../cellpack.autopack.html">cellpack.autopack package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../cellpack.bin.html">cellpack.bin package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../cellpack.mgl_tools.html">cellpack.mgl_tools package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cellpack.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cellpack.html#module-cellpack.example">cellpack.example module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cellpack.html#module-cellpack">Module contents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../recipe-schema.html">Cellpack Recipe Schema 1.0</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../recipe-schema.html#recipe-definition-properties">Recipe definition properties</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#name">name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#version">version</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../recipe-schema.html#example">example:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../recipe-schema.html#options-properties">Options properties</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#saveresult">saveResult</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#resultfile">resultfile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#enviroonly">EnviroOnly</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#canceldialog">cancelDialog</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#pickweightedingr">pickWeightedIngr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#pickrandpt">pickRandPt</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#ingrlookforneighbours">ingrLookForNeighbours</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#overwriteplacemethod">overwritePlaceMethod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#boundingbox">boundingBox</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#smallestproteinsize">smallestProteinSize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#largestproteinsize">largestProteinSize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#computegridparams">computeGridParams</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#windowssize">windowsSize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#runtimedisplay">runTimeDisplay</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#placemethod">placeMethod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#use-gradient">use_gradient</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#gradients">gradients</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#innergridmethod">innerGridMethod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#freeptsupdatethreshold">freePtsUpdateThreshold</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#use-periodicity">use_periodicity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#timer">_timer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#hackfreepts">_hackFreepts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../recipe-schema.html#example-options">example <code class="docutils literal notranslate"><span class="pre">Options</span></code>:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../recipe-schema.html#ingredient-properties">Ingredient Properties</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#id81">name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#overwrite-nbmol-value">overwrite_nbMol_value</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#molarity">molarity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#nbmol">nbMol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#encapsulatingradius">encapsulatingRadius</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#radii">radii</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#positions">positions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#positions2">positions2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#spherefile">sphereFile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#packingpriority">packingPriority</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#pdb">pdb</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#color">color</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#meshfile">meshFile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#meshname">meshName</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#coordsystem">coordsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#principalvector">principalVector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#type">Type</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#offset">offset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#jittermax">jitterMax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#nbjitter">nbJitter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#perturbaxisamplitude">perturbAxisAmplitude</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#userotaxis">useRotAxis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#rotaxis">rotAxis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#rotrange">rotRange</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#useorientbias">useOrientBias</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#orientbiasrotrangemin">orientBiasRotRangeMin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#orientbiasrotrangemax">orientBiasRotRangeMax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#cutoff-boundary">cutoff_boundary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#cutoff-surface">cutoff_surface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#placetype">placeType</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#use-mesh-rb">use_mesh_rb</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#rejectionthreshold">rejectionThreshold</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#packingmode">packingMode</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#gradient">gradient</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#proba-binding">proba_binding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#proba-not-binding">proba_not_binding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#isattractor">isAttractor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#weight">weight</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#partners-name">partners_name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#excluded-partners-name">excluded_partners_name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#partners-position">partners_position</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#partners-weight">partners_weight</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#properties">properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#score">score</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#organism">organism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../recipe-schema.html#example-ingredient">example ingredient</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#get-started">Get Started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#deploying">Deploying</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">cellPack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../../cellpack.html">cellpack</a> &raquo;</li>
          <li><a href="../../autopack.html">cellpack.autopack</a> &raquo;</li>
      <li>cellpack.autopack.ingredient.Ingredient</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cellpack.autopack.ingredient.Ingredient</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">############################################################################</span>
<span class="c1">#</span>
<span class="c1"># autoPACK Authors: Graham T. Johnson, Mostafa Al-Alusi, Ludovic Autin,</span>
<span class="c1">#   and Michel Sanner</span>
<span class="c1">#   Based on COFFEE Script developed by Graham Johnson</span>
<span class="c1">#    between 2005 and 2010</span>
<span class="c1">#   with assistance from Mostafa Al-Alusi in 2009 and periodic input</span>
<span class="c1">#   from Arthur Olson&#39;s Molecular Graphics Lab</span>
<span class="c1">#</span>
<span class="c1"># Ingredient.py Authors: Graham Johnson &amp; Michel Sanner with</span>
<span class="c1">#  editing/enhancement from Ludovic Autin</span>
<span class="c1">#</span>
<span class="c1"># Translation to Python initiated March 1, 2010 by Michel Sanner</span>
<span class="c1">#  with Graham Johnson</span>
<span class="c1">#</span>
<span class="c1"># Class restructuring and organization: Michel Sanner</span>
<span class="c1">#</span>
<span class="c1"># Copyright: Graham Johnson ©2010</span>
<span class="c1">#</span>
<span class="c1"># This file &quot;Ingredient.py&quot; is part of autoPACK, cellPACK.</span>
<span class="c1">#</span>
<span class="c1">#    autoPACK is free software: you can redistribute it and/or modify</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#    (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    autoPACK is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with autoPACK (See &quot;CopyingGNUGPL&quot; in the installation.</span>
<span class="c1">#    If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">############################################################################</span>
<span class="c1"># @author: Graham Johnson, Ludovic Autin, &amp; Michel Sanner</span>


<span class="c1"># Hybrid version merged from Graham&#39;s Sept 2011 and Ludo&#39;s April 2012</span>
<span class="c1"># version on May 16, 2012</span>
<span class="c1"># Updated with Correct Sept 25, 2011 thesis version on July 5, 2012</span>

<span class="c1"># TODO: Describe Ingredient class here at high level</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
<span class="kn">from</span> <span class="nn">panda3d.bullet</span> <span class="kn">import</span> <span class="n">BulletRigidBodyNode</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">collada</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span> <span class="k">as</span> <span class="n">R</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">pi</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.upy.simularium.simularium_helper</span> <span class="kn">import</span> <span class="n">simulariumHelper</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">uniform</span><span class="p">,</span> <span class="n">gauss</span><span class="p">,</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ApplyMatrix</span><span class="p">,</span>
    <span class="n">getNormedVectorOnes</span><span class="p">,</span>
    <span class="n">rotVectToVect</span><span class="p">,</span>
    <span class="n">rotax</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">cellpack.autopack</span> <span class="k">as</span> <span class="nn">autopack</span>

<span class="n">helper</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
<span class="n">reporthook</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="n">helper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">reporthook</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">reporthook</span>

<span class="n">KWDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;molarity&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;molarity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;molarity&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;nbMol&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;nbMol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;nbMol&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;overwrite_nbMol_value&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;overwrite_nbMol_value&quot;</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;nbMol&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;encapsulatingRadius&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;encapsulatingRadius&quot;</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;encapsulatingRadius&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;radii&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">},</span>
    <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">},</span>
    <span class="s2">&quot;positions2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">},</span>
    <span class="s2">&quot;sphereFile&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="s2">&quot;packingPriority&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">},</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="s2">&quot;pdb&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">},</span>
    <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;offset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;offset&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;meshFile&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="s2">&quot;meshName&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="s2">&quot;use_mesh_rb&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;use_mesh_rb&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;use mesh for collision&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;coordsystem&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;coordsystem&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;coordinate system of the files&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="c1">#                        &quot;meshObject&quot;:{&quot;type&quot;:&quot;string&quot;},</span>
    <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="s2">&quot;jitterMax&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;jitterMax&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;jitterMax&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;nbJitter&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;nbJitter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;nbJitter&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;perturbAxisAmplitude&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;perturbAxisAmplitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;perturbAxisAmplitude&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;useRotAxis&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;useRotAxis&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;useRotAxis&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;rotAxis&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;rotAxis&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;rotAxis&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;rotRange&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;rotRange&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">6.2831</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">6.2831</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;rotRange&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;useOrientBias&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;useOrientBias&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;useOrientBias&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;orientBiasRotRangeMin&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;orientBiasRotRange&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">pi</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">pi</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">pi</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">pi</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;orientBiasRotRangeMin&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;orientBiasRotRangeMax&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;orientBiasRotRange&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">pi</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">pi</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">pi</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">pi</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;orientBiasRotRangeMax&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;rejectionThreshold&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;rejectionThreshold&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;rejectionThreshold&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;principalVector&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;principalVector&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;principalVector&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;cutoff_boundary&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;cutoff_boundary&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;cutoff_boundary&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;cutoff_surface&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;cutoff_surface&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;cutoff_surface&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;placeType&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;placeType&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;jitter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">autopack</span><span class="o">.</span><span class="n">LISTPLACEMETHOD</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;jitter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;liste&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;placeType&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;packingMode&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;packingMode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span>
        <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;random&quot;</span><span class="p">,</span>
            <span class="s2">&quot;close&quot;</span><span class="p">,</span>
            <span class="s2">&quot;closePartner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;randomPartner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gradient&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hexatile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;squaretile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;triangletile&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;liste&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;packingMode&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;useLength&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;useLength&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">},</span>
    <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">},</span>
    <span class="s2">&quot;uLength&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;uLength&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">},</span>
    <span class="s2">&quot;closed&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;closed&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">},</span>
    <span class="s2">&quot;biased&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;biased&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">},</span>
    <span class="s2">&quot;marge&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;marge&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">},</span>
    <span class="s2">&quot;constraintMarge&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;constraintMarge&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">},</span>
    <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;orientation&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">},</span>
    <span class="s2">&quot;partners_name&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;partners_name&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;liste_string&quot;</span><span class="p">},</span>
    <span class="s2">&quot;excluded_partners_name&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;excluded_partners_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;liste_string&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;[]&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;partners_position&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;partners_position&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;liste_float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;[]&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;partners_weight&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;partners_weight&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;walkingMode&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;walkingMode&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="s2">&quot;gradient&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;gradient&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;jitter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;liste&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;gradient name to use if histo.use_gradient&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;isAttractor&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;isAttractor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;isAttractor&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;proba_binding&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;proba_binding&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;proba_binding&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;proba_not_binding&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;proba_not_binding&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;proba_not_binding&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;compMask&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;compMask&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;allowed compartments&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;use_rbsphere&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;use_rbsphere&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;use sphere instead of cylinder for collision&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;properties&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;dic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;properties&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="s2">&quot;organism&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
<span class="p">}</span>


<div class="viewcode-block" id="Partner"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Partner">[docs]</a><span class="k">class</span> <span class="nc">Partner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ingr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ingr</span> <span class="o">=</span> <span class="n">ingr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distExpression</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>

    <span class="c1"># def setup(</span>
    <span class="c1">#     self,</span>
    <span class="c1"># ):</span>
    <span class="c1"># QUESTION: why is this commented out?</span>
    <span class="c1"># # setup the marge according the pt properties</span>
    <span class="c1"># pt1 = numpy.array(self.getProperties(&quot;pt1&quot;))</span>
    <span class="c1"># pt2 = numpy.array(self.getProperties(&quot;pt2&quot;))</span>
    <span class="c1"># pt3 = numpy.array(self.getProperties(&quot;pt3&quot;))</span>
    <span class="c1"># pt4 = numpy.array(self.getProperties(&quot;pt4&quot;))</span>

    <span class="c1"># # length = autopack.helper.measure_distance(pt2,pt3)#length</span>
    <span class="c1"># margein = math.degrees(</span>
    <span class="c1">#     autopack.helper.angle_between_vectors(pt2 - pt1, pt3 - pt2)</span>
    <span class="c1"># )  # 4</span>
    <span class="c1"># margeout = math.degrees(</span>
    <span class="c1">#     autopack.helper.angle_between_vectors(pt3 - pt2, pt4 - pt3)</span>
    <span class="c1"># )  # 113</span>
    <span class="c1"># dihedral = math.degrees(</span>
    <span class="c1">#     autopack.helper.angle_between_vectors(pt2 - pt1, pt4 - pt2)</span>
    <span class="c1"># )  # 79</span>
    <span class="c1"># dihedral = autopack.helper.dihedral(pt1, pt2, pt3, pt4)</span>
    <span class="c1"># self.properties[&quot;marge_in&quot;] = [margein - 1, margein + 1]</span>
    <span class="c1"># self.properties[&quot;marge_out&quot;] = [margeout - 1, margeout + 1]</span>
    <span class="c1"># self.properties[&quot;diehdral&quot;] = [dihedral - 1, dihedral + 1]</span>

<div class="viewcode-block" id="Partner.addProperties"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Partner.addProperties">[docs]</a>    <span class="k">def</span> <span class="nf">addProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Partner.getProperties"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Partner.getProperties">[docs]</a>    <span class="k">def</span> <span class="nf">getProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="c1"># if name == &quot;pt1&quot;:</span>
            <span class="c1">#    return [0,0,0]</span>
            <span class="c1"># if name == &quot;pt2&quot;:</span>
            <span class="c1">#    return [0,0,0]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Partner.distanceFunction"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Partner.distanceFunction">[docs]</a>    <span class="k">def</span> <span class="nf">distanceFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># default function that can be overwrite or</span>
        <span class="c1"># can provide an experssion which 1/d or 1/d^2 or d^2etc.w*expression</span>
        <span class="c1"># can provide directly a function that take as</span>
        <span class="c1"># arguments the w and the distance</span>
        <span class="k">if</span> <span class="n">expression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">expression</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d</span>
        <span class="k">return</span> <span class="n">val</span></div></div>


<div class="viewcode-block" id="IngredientInstanceDrop"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.IngredientInstanceDrop">[docs]</a><span class="k">class</span> <span class="nc">IngredientInstanceDrop</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptId</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">ingredient</span><span class="p">,</span> <span class="n">rb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptId</span> <span class="o">=</span> <span class="n">ptId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ingredient</span> <span class="o">=</span> <span class="n">ingredient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rigid_body</span> <span class="o">=</span> <span class="n">rb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ingredient</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptId</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">position</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">ingredient</span><span class="o">.</span><span class="n">encapsulatingRadius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bb</span> <span class="o">=</span> <span class="p">([</span><span class="n">x</span> <span class="o">-</span> <span class="n">rad</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">rad</span><span class="p">,</span> <span class="n">z</span> <span class="o">-</span> <span class="n">rad</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">rad</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">rad</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">rad</span><span class="p">])</span>
        <span class="c1"># maybe get bb from mesh if any ?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ingredient</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bb</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ingredient</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>


<div class="viewcode-block" id="Agent"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent">[docs]</a><span class="k">class</span> <span class="nc">Agent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">concentration</span><span class="p">,</span> <span class="n">packingMode</span><span class="o">=</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="n">placeType</span><span class="o">=</span><span class="s2">&quot;jitter&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="n">concentration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partners</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excluded_partners</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># the partner position is the local position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partners_position</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;partners_position&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partners_position</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;partners_position&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partners_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;partners_name&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partners_name</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;partners_name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners_position</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners_name</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">partners_position</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excluded_partners_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;excluded_partners_name&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">excluded_partners_name</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;excluded_partners_name&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">packingMode</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;random&quot;</span><span class="p">,</span>
            <span class="s2">&quot;close&quot;</span><span class="p">,</span>
            <span class="s2">&quot;closePartner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;randomPartner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gradient&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hexatile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;squaretile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;triangletile&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">=</span> <span class="n">packingMode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partners_weight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s2">&quot;partners_weight&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partners_weight</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;partners_weight&quot;</span><span class="p">]</span>
        <span class="c1"># assert placeType in [&#39;jitter&#39;, &#39;spring&#39;,&#39;rigid-body&#39;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">placeType</span> <span class="o">=</span> <span class="n">placeType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_3d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isAttractor</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;isAttractor&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isAttractor</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;isAttractor&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># use for affinity ie partner.weight</span>
        <span class="k">if</span> <span class="s2">&quot;weight&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proba_not_binding</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># chance to actually not bind</span>
        <span class="k">if</span> <span class="s2">&quot;proba_not_binding&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proba_not_binding</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;proba_not_binding&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proba_binding</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">if</span> <span class="s2">&quot;proba_binding&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proba_binding</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;proba_binding&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_random</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># avoid any binding</span>
        <span class="k">if</span> <span class="s2">&quot;force_random&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force_random</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;force_random&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distFunction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;distFunction&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distFunction</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;distFunction&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distExpression</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;distExpression&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distExpression</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;distExpression&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_distFunc</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># overWrite</span>
        <span class="k">if</span> <span class="s2">&quot;overwrite_distFunc&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_distFunc</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;overwrite_distFunc&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_distFunc</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># chance to actually bind to any partner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;gradient&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;gradient&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recipe</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># weak ref to recipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Agent.getProbaBinding"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.getProbaBinding">[docs]</a>    <span class="k">def</span> <span class="nf">getProbaBinding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># get a value between 0.0 and 1.0and return the weight and success ?</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Agent.getPartnerweight"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.getPartnerweight">[docs]</a>    <span class="k">def</span> <span class="nf">getPartnerweight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deprecated use self.weight&quot;</span><span class="p">)</span>
        <span class="n">partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPartner</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">getProperties</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">w</span></div>

<div class="viewcode-block" id="Agent.getPartnersName"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.getPartnersName">[docs]</a>    <span class="k">def</span> <span class="nf">getPartnersName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="Agent.getPartner"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.getPartner">[docs]</a>    <span class="k">def</span> <span class="nf">getPartner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Agent.addPartner"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.addPartner">[docs]</a>    <span class="k">def</span> <span class="nf">addPartner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Partner</span><span class="p">(</span>
                <span class="n">ingr</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="Agent.getExcludedPartnersName"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.getExcludedPartnersName">[docs]</a>    <span class="k">def</span> <span class="nf">getExcludedPartnersName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">excluded_partners</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="Agent.getExcludedPartner"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.getExcludedPartner">[docs]</a>    <span class="k">def</span> <span class="nf">getExcludedPartner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">excluded_partners</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">excluded_partners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Agent.addExcludedPartner"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.addExcludedPartner">[docs]</a>    <span class="k">def</span> <span class="nf">addExcludedPartner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excluded_partners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Partner</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">)</span></div>

<div class="viewcode-block" id="Agent.sortPartner"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.sortPartner">[docs]</a>    <span class="k">def</span> <span class="nf">sortPartner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listeP</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">listeP</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">listeP</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">listeP</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">ingr</span><span class="p">])</span>
        <span class="c1"># extract ing name unic</span>
        <span class="n">listeIngrInstance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">listeP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">listeIngrInstance</span><span class="p">:</span>
                <span class="n">listeIngrInstance</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="p">[]]</span>
            <span class="n">listeIngrInstance</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># sort according ingredient binding weight (proba to bind)</span>
        <span class="n">sortedListe</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">listeIngrInstance</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># sortedListe is [ingr,(weight,(instances indices))]</span>
        <span class="c1"># sort by weight/min-&gt;max</span>
        <span class="c1"># wIngrList = []</span>
        <span class="c1"># for i,ingr in listeP:</span>
        <span class="c1"># need to sort by ingr.weight</span>
        <span class="c1">#    wIngrList.append([i,ingr,ingr.weight])</span>
        <span class="c1"># sortedListe = sorted(wIngrList, key=lambda elem: elem[2])   # sort by weight/min-&gt;max</span>
        <span class="c1">#        print sortedListe</span>
        <span class="k">return</span> <span class="n">sortedListe</span></div>

<div class="viewcode-block" id="Agent.weightListByDistance"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.weightListByDistance">[docs]</a>    <span class="k">def</span> <span class="nf">weightListByDistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listePartner</span><span class="p">):</span>
        <span class="n">probaArray</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">listePartner</span><span class="p">:</span>
            <span class="c1"># print (&quot;i&quot;,part,dist,w,part.weight)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_distFunc</span><span class="p">:</span>
                <span class="n">wd</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">weight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wd</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">distanceFunction</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="n">part</span><span class="o">.</span><span class="n">distExpression</span><span class="p">)</span>
            <span class="c1"># print &quot;calc &quot;,dist, wd</span>
            <span class="n">probaArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="n">wd</span>
        <span class="c1"># probaArray.append(self.proba_not_binding)</span>
        <span class="c1"># w=w+self.proba_not_binding</span>
        <span class="k">return</span> <span class="n">probaArray</span><span class="p">,</span> <span class="n">w</span></div>

<div class="viewcode-block" id="Agent.getProbaArray"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.getProbaArray">[docs]</a>    <span class="k">def</span> <span class="nf">getProbaArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weightD</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
        <span class="n">probaArray</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">final</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weightD</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">total</span>
            <span class="c1">#            print &quot;norma &quot;,w,total,p</span>
            <span class="n">final</span> <span class="o">=</span> <span class="n">final</span> <span class="o">+</span> <span class="n">p</span>
            <span class="n">probaArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final</span><span class="p">)</span>
        <span class="n">probaArray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">probaArray</span></div>

<div class="viewcode-block" id="Agent.getSubWeighted"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.getSubWeighted">[docs]</a>    <span class="k">def</span> <span class="nf">getSubWeighted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From http://eli.thegreenplace.net/2010/01/22/weighted-random-generation-in-python/</span>
<span class="sd">        This method is about twice as fast as the binary-search technique,</span>
<span class="sd">        although it has the same complexity overall. Building the temporary</span>
<span class="sd">        list of totals turns out to be a major part of the functions runtime.</span>
<span class="sd">        This approach has another interesting property. If we manage to sort</span>
<span class="sd">        the weights in descending order before passing them to</span>
<span class="sd">        weighted_choice_sub, it will run even faster since the random</span>
<span class="sd">        call returns a uniformly distributed value and larger chunks of</span>
<span class="sd">        the total weight will be skipped in the beginning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
            <span class="n">rnd</span> <span class="o">-=</span> <span class="n">w</span>
            <span class="k">if</span> <span class="n">rnd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">rnd</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Agent.pickPartner"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.pickPartner">[docs]</a>    <span class="k">def</span> <span class="nf">pickPartner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mingrs</span><span class="p">,</span> <span class="n">listePartner</span><span class="p">,</span> <span class="n">currentPos</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># listePartner is (i,partner,d)</span>
        <span class="c1"># wieght using the distance function</span>
        <span class="c1">#        print &quot;len&quot;,len(listePartner)</span>
        <span class="n">targetPoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">weightD</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightListByDistance</span><span class="p">(</span><span class="n">listePartner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;w </span><span class="si">%r</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">weightD</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSubWeighted</span><span class="p">(</span><span class="n">weightD</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="c1"># probaArray = self.getProbaArray(weightD,total)</span>
        <span class="c1">#        print &quot;p&quot;,probaArray</span>
        <span class="c1">#        probaArray=numpy.array(probaArray)</span>
        <span class="c1">#        #where is random in probaArray-&gt;index-&gt;ingr</span>
        <span class="c1">#        b = random()</span>
        <span class="c1">#        test = b &lt; probaArray</span>
        <span class="c1">#        i = test.tolist().index(True)</span>
        <span class="c1">#        print &quot;proba&quot;,i,test,(len(probaArray)-1)</span>
        <span class="c1">#        if i == (len(probaArray)-1) :</span>
        <span class="c1">#            #no binding due to proba not binding....</span>
        <span class="c1">#            print (&quot;no binding due to proba&quot;)</span>
        <span class="c1">#            return None,b</span>

        <span class="n">ing_indice</span> <span class="o">=</span> <span class="n">listePartner</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># i,part,dist</span>
        <span class="n">ing</span> <span class="o">=</span> <span class="n">mingrs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ing_indice</span><span class="p">]</span>  <span class="c1"># [2]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;binding to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">ing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">mingrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ing_indice</span><span class="p">]</span>  <span class="c1"># [0]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#            organelle = self.env.compartments[abs(self.compNum)-1]</span>
            <span class="c1">#            dist,ind = organelle.OGsrfPtsBht.query(targetPoint)</span>
            <span class="c1">#            organelle.ogsurfacePoints[]</span>
            <span class="n">targetPoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getClosestFreeGridPoint</span><span class="p">(</span>
                <span class="n">targetPoint</span><span class="p">,</span>
                <span class="n">compId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compNum</span><span class="p">,</span>
                <span class="n">ball</span><span class="o">=</span><span class="p">(</span><span class="n">ing</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">),</span>
                <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;target point free tree is </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">targetPoint</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">,</span>
                <span class="n">ing</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get closestFreePoint using freePoint and masterGridPosition</span>
            <span class="c1"># if self.placeType == &quot;rigid-body&quot; or self.placeType == &quot;jitter&quot;:</span>
            <span class="c1"># the new point is actually tPt -normalise(tPt-current)*radius</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;tP </span><span class="si">%r</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ing_indice</span><span class="p">,</span> <span class="n">ing</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">targetPoint</span><span class="p">,</span> <span class="n">ing</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># what I need it the closest free point from the target ingredient</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">targetPoint</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">currentPos</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">ing</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span>
            <span class="p">)</span>  <span class="c1"># encapsulating radus ?</span>
            <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">targetPoint</span><span class="p">)</span> <span class="o">-</span> <span class="n">factor</span>

        <span class="k">return</span> <span class="n">targetPoint</span><span class="p">,</span> <span class="n">b</span></div>

<div class="viewcode-block" id="Agent.pickPartnerInstance"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Agent.pickPartnerInstance">[docs]</a>    <span class="k">def</span> <span class="nf">pickPartnerInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bindingIngr</span><span class="p">,</span> <span class="n">mingrs</span><span class="p">,</span> <span class="n">currentPos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># bindingIngr is ingr,(weight,(instances indices))</span>
        <span class="c1">#        print &quot;bindingIngr &quot;,bindingIngr,bindingIngr[1]</span>
        <span class="k">if</span> <span class="n">currentPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># random mode</span>
            <span class="n">picked_I</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bindingIngr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">bindingIngr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">picked_I</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pick closest one</span>
            <span class="n">mind</span> <span class="o">=</span> <span class="mf">99999999.9</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">bindingIngr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mingrs</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">currentPos</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">mind</span><span class="p">:</span>
                    <span class="n">mind</span> <span class="o">=</span> <span class="n">d</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">ind</span>
        <span class="k">return</span> <span class="n">i</span></div></div>


<span class="c1"># the ingredient should derive from a class of Agent</span>
<div class="viewcode-block" id="Ingredient"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient">[docs]</a><span class="k">class</span> <span class="nc">Ingredient</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="n">static_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for Ingredients that can be added to a Recipe.</span>
<span class="sd">    Ingredients provide:</span>
<span class="sd">        - a molarity used to compute how many to place</span>
<span class="sd">        - a generic density value</span>
<span class="sd">        - a unit associated with the density value</span>
<span class="sd">        - a jitter amplitude vector specifying by how much the jittering</span>
<span class="sd">        algorithm can move from the grid position.</span>
<span class="sd">        - a number of jitter attempts</span>
<span class="sd">        - an optional color used to draw the ingredient default (white)</span>
<span class="sd">        - an optional name</span>
<span class="sd">        - an optional pdb ID</span>
<span class="sd">        - an optional packing priority. If omitted the priority will be based</span>
<span class="sd">        on the radius with larger radii first</span>
<span class="sd">        ham here: (-)packingPriority object will pack from high to low one at a time</span>
<span class="sd">        (+)packingPriority will be weighted by assigned priority value</span>
<span class="sd">        (0)packignPriority will be weighted by complexity and appended to what is left</span>
<span class="sd">        of the (+) values</span>
<span class="sd">        - an optional principal vector used to align the ingredient</span>
<span class="sd">        - recipe will be a weakref to the Recipe this Ingredient belongs to</span>
<span class="sd">        - compNum is the compartment number (0 for cytoplasm, positive for compartment</span>
<span class="sd">        surface and negative compartment interior</span>
<span class="sd">        - Attributes used by the filling algorithm:</span>
<span class="sd">        - nbMol counts the number of placed ingredients during a fill</span>
<span class="sd">        - counter is the target number of ingredients to place</span>
<span class="sd">        - completion is the ratio of placed/target</span>
<span class="sd">        - rejectionCounter is used to eliminate ingredients after too many failed</span>
<span class="sd">        attempts</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">molarity</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">radii</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">positions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">positions2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sphereFile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">packingPriority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pdb</span><span class="o">=</span><span class="s2">&quot;????&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nbJitter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">jitterMax</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">perturbAxisAmplitude</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">principalVector</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">meshFile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">meshName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">packingMode</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span>
        <span class="n">placeType</span><span class="o">=</span><span class="s2">&quot;jitter&quot;</span><span class="p">,</span>
        <span class="n">meshObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nbMol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;MultiSphere&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">Agent</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">molarity</span><span class="p">,</span> <span class="n">packingMode</span><span class="o">=</span><span class="n">packingMode</span><span class="p">,</span> <span class="n">placeType</span><span class="o">=</span><span class="n">placeType</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ingredient&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">molarity</span> <span class="o">=</span> <span class="n">molarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packingPriority</span> <span class="o">=</span> <span class="n">packingPriority</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;packingPriority </span><span class="si">%d</span><span class="s2">,  self.packingPriority </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">packingPriority</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packingPriority</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">molarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;CREATE INGREDIENT </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;rejectionThreshold&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">Type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">pdb</span>  <span class="c1"># pmv ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_sources</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># offset to apply for membrane binding</span>
        <span class="k">if</span> <span class="s2">&quot;offset&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span>

        <span class="c1"># should deal with source of the object</span>
        <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;pdb&quot;</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">][</span><span class="s2">&quot;pdb&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;transform&quot;</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transform_sources</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">][</span><span class="s2">&quot;transform&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;offset&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">][</span><span class="s2">&quot;transform&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">][</span><span class="s2">&quot;transform&quot;</span><span class="p">][</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;pdb&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="p">,</span>
                <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]},</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform_sources</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>  <span class="c1"># color used for sphere display</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span> <span class="o">=</span> <span class="s2">&quot;Spheres&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rRot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tTrans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">htrans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moving</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moving_geom</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rb_nodes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># store rbnode. no more than X ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bullet_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># try only store 2, and move them when needd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_nb_nodes</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vi</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_distance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deepest_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_previous</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vnormals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># self._place = self.place</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sphereFile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># level 0 should be encapsulated sphere ?</span>
        <span class="k">if</span> <span class="n">sphereFile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">sphereFile</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">sphereFileo</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">retrieveFile</span><span class="p">(</span><span class="n">sphereFile</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;collisionTrees&quot;</span><span class="p">)</span>
            <span class="n">fileName</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">sphereFile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sphereTree </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sphereFileo</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sphereFileo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">sphereFileo</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sphereFile</span> <span class="o">=</span> <span class="n">sphereFile</span>
                <span class="n">sphereFile</span> <span class="o">=</span> <span class="n">sphereFileo</span>
                <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.mstr&quot;</span><span class="p">:</span>  <span class="c1"># BD_BOX format</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">sphereFileo</span><span class="p">,</span> <span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
                    <span class="n">positions</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">radii</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
                    <span class="c1"># np.apply_along_axis(np.linalg.norm, 1, c)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ij-&gt;i&quot;</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">positions</span><span class="p">))</span>
                    <span class="p">)</span>  <span class="c1"># shoud be max distance</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span>
                    <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">positions</span><span class="p">]</span>
                    <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">radii</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.sph&quot;</span><span class="p">:</span>
                    <span class="n">min_radius</span><span class="p">,</span> <span class="n">rM</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpheres</span><span class="p">(</span>
                        <span class="n">sphereFileo</span>
                    <span class="p">)</span>
                    <span class="c1"># if a user didn&#39;t set this properly before</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span> <span class="o">=</span> <span class="mf">1.0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># minRadius is used to compute grid spacing. It represents the</span>
                        <span class="c1"># smallest radius around the anchor point(i.e.</span>
                        <span class="c1"># the point where the</span>
                        <span class="c1"># ingredient is dropped that needs to be free</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span> <span class="o">=</span> <span class="n">min_radius</span>
                        <span class="c1"># encapsulatingRadius is the radius of the sphere</span>
                        <span class="c1"># centered at 0,0,0</span>
                        <span class="c1"># and encapsulate the ingredient</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">=</span> <span class="n">rM</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;sphere file extension not recognized </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fileExtension</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sphere_positions</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">positions2</span> <span class="o">=</span> <span class="n">positions2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rbnode</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># keep the rbnode if any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collisionLevel</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># self.deepest_level</span>
        <span class="c1"># first level used for collision detection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jitterMax</span> <span class="o">=</span> <span class="n">jitterMax</span>
        <span class="c1"># (1,1,1) means 1/2 grid spacing in all directions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">perturbAxisAmplitude</span> <span class="o">=</span> <span class="n">perturbAxisAmplitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">principalVector</span> <span class="o">=</span> <span class="n">principalVector</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">recipe</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># will be set when added to a recipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compId_accepted</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[]</span>
        <span class="p">)</span>  <span class="c1"># if this list is defined, point picked outise the list are rejected</span>
        <span class="c1"># should be self.compNum per default</span>
        <span class="c1"># will be set when recipe is added to HistoVol</span>
        <span class="c1"># added to a compartment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_nbMol</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_nbMol_value</span> <span class="o">=</span> <span class="n">nbMol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbMol</span> <span class="o">=</span> <span class="n">nbMol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_nbmol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># used by fill() to count placed molecules,overwrite if !=0</span>
        <span class="c1">#        if nbMol != 0:</span>
        <span class="c1">#            self.overwrite_nbMol = True</span>
        <span class="c1">#            self.overwrite_nbMol_value = nMol</span>
        <span class="c1">#            self.nbMol = nMol</span>

        <span class="c1"># Packing tracking values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbJitter</span> <span class="o">=</span> <span class="n">nbJitter</span>  <span class="c1"># number of jitter attempts for translation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbPts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allIngrPts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[]</span>
        <span class="p">)</span>  <span class="c1"># the list of available grid points for this ingredient to pack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># target number of molecules for a fill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># ratio of counter/nbMol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rad</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rapid_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1">#</span>
        <span class="c1"># TODO : geometry : 3d object or procedural from PDB</span>
        <span class="c1"># TODO : usekeyword resolution-&gt;options dictionary of res :</span>
        <span class="c1"># TODO : {&quot;simple&quot;:{&quot;cms&quot;:{&quot;parameters&quot;:{&quot;gridres&quot;:12}},</span>
        <span class="c1"># TODO :            &quot;obj&quot;:{&quot;parameters&quot;:{&quot;name&quot;:&quot;&quot;,&quot;filename&quot;:&quot;&quot;}}</span>
        <span class="c1"># TODO :            }</span>
        <span class="c1"># TODO : &quot;med&quot;:{&quot;method&quot;:&quot;cms&quot;,&quot;parameters&quot;:{&quot;gridres&quot;:30}}</span>
        <span class="c1"># TODO : &quot;high&quot;:{&quot;method&quot;:&quot;msms&quot;,&quot;parameters&quot;:{&quot;gridres&quot;:30}}</span>
        <span class="c1"># TODO : etc...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordsystem</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;coordsystem&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordsystem</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;coordsystem&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejectionThreshold</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">if</span> <span class="s2">&quot;rejectionThreshold&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rejectionThreshold </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;rejectionThreshold&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rejectionThreshold</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;rejectionThreshold&quot;</span><span class="p">]</span>

        <span class="c1"># get the collision mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshFile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshName</span> <span class="o">=</span> <span class="n">meshName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshObject</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshType</span> <span class="o">=</span> <span class="s2">&quot;file&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;meshType&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meshType</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;meshType&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">meshFile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;OK, meshFile is not none, it is = &quot;</span><span class="p">,</span>
                <span class="n">meshFile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordsystem</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">gname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshName</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshType</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMesh</span><span class="p">(</span><span class="n">meshFile</span><span class="p">,</span> <span class="n">gname</span><span class="p">)</span>  <span class="c1"># self.name)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OK got&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># display a message ?</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no geometries for ingredient &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># should we reparent it ?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meshFile</span> <span class="o">=</span> <span class="n">meshFile</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshType</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
                <span class="c1"># need to build the mesh from v,f,n</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buildMesh</span><span class="p">(</span><span class="n">meshFile</span><span class="p">,</span> <span class="n">gname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">meshObject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">meshObject</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getEncapsulatingRadius</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;encapsulatingRadius&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="c1"># we force the encapsulatingRadius</span>
            <span class="k">if</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">!=</span> <span class="s2">&quot;3dsmax&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;encapsulatingRadius&quot;</span><span class="p">]</span>

        <span class="c1"># need to build the basic shape if one provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_mesh_rb</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_resolution</span> <span class="o">=</span> <span class="s2">&quot;Low&quot;</span>  <span class="c1"># should come from data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_resolution</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Med&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">]</span>  <span class="c1"># 0,1,2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Low&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Med&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;resolution_dictionary&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;resolution_dictionary&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolution_dictionary</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;resolution_dictionary&quot;</span><span class="p">]</span>

        <span class="c1"># how to get the geom of different res?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">representation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">representation_file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">useRotAxis</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;useRotAxis&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">useRotAxis</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;useRotAxis&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotAxis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;rotAxis&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotAxis</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;rotAxis&quot;</span><span class="p">]</span>
            <span class="c1"># this could define the biased</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotRange</span> <span class="o">=</span> <span class="mf">6.2831</span>
        <span class="k">if</span> <span class="s2">&quot;rotRange&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotRange</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;rotRange&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">useOrientBias</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;useOrientBias&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">useOrientBias</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;useOrientBias&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orientBiasRotRangeMin</span> <span class="o">=</span> <span class="o">-</span><span class="n">pi</span>
        <span class="k">if</span> <span class="s2">&quot;orientBiasRotRangeMin&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orientBiasRotRangeMin</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;orientBiasRotRangeMin&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orientBiasRotRangeMax</span> <span class="o">=</span> <span class="o">-</span><span class="n">pi</span>
        <span class="k">if</span> <span class="s2">&quot;orientBiasRotRangeMax&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orientBiasRotRangeMax</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;orientBiasRotRangeMax&quot;</span><span class="p">]</span>

        <span class="c1"># cutoff are used for picking point far from surface and boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_boundary</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># self.encapsulatingRadius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_surface</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;cutoff_boundary&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_boundary</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;cutoff_boundary&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;cutoff_surface&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;cutoff_surface&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_surface</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s2">&quot;cutoff_surface&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># four tout</span>
        <span class="k">if</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartment</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartmentTolerance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartmentThreshold</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updateOwnFreePts</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># work for rer python not ??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">haveBeenRejected</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">distances_temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centT</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># transformed position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#        if self.mesh is not None :</span>
        <span class="c1">#            self.getData()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">Ingredient</span><span class="o">.</span><span class="n">static_id</span>
        <span class="n">Ingredient</span><span class="o">.</span><span class="n">static_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">organism</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># add tiling property ? as any ingredient coud tile as hexagon. It is just the packing type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">KWDS</span> <span class="o">=</span> <span class="n">KWDS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;meshObject&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;compareCompartment&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;compareCompartment&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;compareCompartment&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;compareCompartmentTolerance&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;compareCompartmentTolerance&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;compareCompartmentTolerance&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;compareCompartmentThreshold&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;compareCompartmentThreshold&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;compareCompartmentThreshold&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;partners_weight&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;partners_weight&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

<div class="viewcode-block" id="Ingredient.set_sphere_positions"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.set_sphere_positions">[docs]</a>    <span class="k">def</span> <span class="nf">set_sphere_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">):</span>
        <span class="c1"># positions and radii are passed to the constructor</span>
        <span class="c1"># check the format old nested array, new array of dictionary</span>
        <span class="n">nLOD</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nLOD</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLOD</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;coords&quot;</span><span class="p">])</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;radii&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">10</span><span class="p">]]</span>  <span class="c1"># some default value ?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deepest_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># regular nested</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">):</span>  <span class="c1"># [0][0]</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="p">[[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">radii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">rM</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="n">delta</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">)</span>
            <span class="c1"># if radii is not None and positions is not None:</span>
            <span class="c1"># for r, c in zip(radii, positions):</span>
            <span class="c1">#     assert len(r) == len(c)</span>
            <span class="k">if</span> <span class="n">radii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deepest_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">radii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">radii</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">radii</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">))</span></div>

<div class="viewcode-block" id="Ingredient.reset"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;reset the states of an ingredient&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbMol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span></div>

<div class="viewcode-block" id="Ingredient.setTilling"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.setTilling">[docs]</a>    <span class="k">def</span> <span class="nf">setTilling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">==</span> <span class="s2">&quot;hexatile&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cellpack.autopack.hexagonTile</span> <span class="kn">import</span> <span class="n">tileHexaIngredient</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span> <span class="o">=</span> <span class="n">tileHexaIngredient</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">,</span> <span class="n">init_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">seed_used</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">==</span> <span class="s2">&quot;squaretile&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cellpack.autopack.hexagonTile</span> <span class="kn">import</span> <span class="n">tileSquareIngredient</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span> <span class="o">=</span> <span class="n">tileSquareIngredient</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">,</span> <span class="n">init_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">seed_used</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">==</span> <span class="s2">&quot;triangletile&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cellpack.autopack.hexagonTile</span> <span class="kn">import</span> <span class="n">tileTriangleIngredient</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span> <span class="o">=</span> <span class="n">tileTriangleIngredient</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">,</span> <span class="n">init_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">seed_used</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.DecomposeMesh"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.DecomposeMesh">[docs]</a>    <span class="k">def</span> <span class="nf">DecomposeMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">helper</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
        <span class="n">m</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;dejavu&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getMesh</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getMesh</span><span class="p">(</span><span class="n">helper</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span><span class="n">poly</span><span class="p">))</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Decompose Mesh ingredient </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">helper</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span><span class="n">poly</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span>
        <span class="c1"># what about empty, hierarchical, should merged all the data?</span>
        <span class="n">faces</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">vnormals</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="n">edit</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="n">tri</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tr</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">faces</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">vnormals</span></div>

<div class="viewcode-block" id="Ingredient.getSpheres"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getSpheres">[docs]</a>    <span class="k">def</span> <span class="nf">getSpheres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sphereFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get spherical approximation of shape</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># file format is space separated</span>
        <span class="c1"># float:Rmin float:Rmax</span>
        <span class="c1"># int:number of levels</span>
        <span class="c1"># int: number of spheres in first level</span>
        <span class="c1"># x y z r i j k ...# first sphere in first level and 0-based indices</span>
        <span class="c1"># of spheres in next level covererd by this sphere</span>
        <span class="c1"># ...</span>
        <span class="c1"># int: number of spheres in second level</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sphereFile</span><span class="p">)</span>
        <span class="n">datao</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># strip comments</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">datao</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
        <span class="n">nblevels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblevels</span><span class="p">):</span>
            <span class="n">rl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">line</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbs</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">w</span><span class="p">[:</span><span class="mi">4</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">nblevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># get sub spheres indices</span>
                    <span class="n">ch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">:])))</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
                <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
            <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span>
            <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="c1"># we ignore the hierarchy for now</span>
        <span class="k">return</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">children</span></div>

<div class="viewcode-block" id="Ingredient.rejectOnce"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.rejectOnce">[docs]</a>    <span class="k">def</span> <span class="nf">rejectOnce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rbnode</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">afvi</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rbnode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">delRB</span><span class="p">,</span> <span class="p">(</span><span class="n">rbnode</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">afvi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">moving</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">deleteObject</span><span class="p">(</span><span class="n">moving</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">haveBeenRejected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rejectionThreshold</span>
        <span class="p">):</span>  <span class="c1"># Graham set this to 6000 for figure 13b (Results Fig 3 Test1) otherwise it fails to fill small guys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PREMATURE ENDING of ingredient rejectOnce&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span></div>

<div class="viewcode-block" id="Ingredient.addRBsegment"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.addRBsegment">[docs]</a>    <span class="k">def</span> <span class="nf">addRBsegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">):</span>
        <span class="c1"># ovewrite by grow ingredient</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Ingredient.add_rb_mesh"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.add_rb_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">add_rb_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worldNP</span><span class="p">):</span>
        <span class="n">inodenp</span> <span class="o">=</span> <span class="n">worldNP</span><span class="o">.</span><span class="n">attachNewNode</span><span class="p">(</span><span class="n">BulletRigidBodyNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span><span class="o">.</span><span class="n">setMass</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">inodenp</span>
        <span class="kn">from</span> <span class="nn">panda3d.core</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">GeomVertexFormat</span><span class="p">,</span>
            <span class="n">GeomVertexWriter</span><span class="p">,</span>
            <span class="n">GeomVertexData</span><span class="p">,</span>
            <span class="n">Geom</span><span class="p">,</span>
            <span class="n">GeomTriangles</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">panda3d.bullet</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">BulletTriangleMesh</span><span class="p">,</span>
            <span class="n">BulletTriangleMeshShape</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># step 1) create GeomVertexData and add vertex information</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="n">GeomVertexFormat</span><span class="o">.</span><span class="n">getV3</span><span class="p">()</span>
        <span class="n">vdata</span> <span class="o">=</span> <span class="n">GeomVertexData</span><span class="p">(</span><span class="s2">&quot;vertices&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">Geom</span><span class="o">.</span><span class="n">UHStatic</span><span class="p">)</span>
        <span class="n">vertexWriter</span> <span class="o">=</span> <span class="n">GeomVertexWriter</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span> <span class="s2">&quot;vertex&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">vertexWriter</span><span class="o">.</span><span class="n">addData3f</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">]</span>

        <span class="c1"># step 2) make primitives and assign vertices to them</span>
        <span class="n">tris</span> <span class="o">=</span> <span class="n">GeomTriangles</span><span class="p">(</span><span class="n">Geom</span><span class="o">.</span><span class="n">UHStatic</span><span class="p">)</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setGeomFaces</span><span class="p">(</span><span class="n">tris</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">]</span>

        <span class="c1"># step 3) make a Geom object to hold the primitives</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">Geom</span><span class="p">(</span><span class="n">vdata</span><span class="p">)</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">addPrimitive</span><span class="p">(</span><span class="n">tris</span><span class="p">)</span>
        <span class="c1"># step 4) create the bullet mesh and node</span>
        <span class="c1">#        if ingr.convex_hull:</span>
        <span class="c1">#            shape = BulletConvexHullShape()</span>
        <span class="c1">#            shape.add_geom(geom)</span>
        <span class="c1">#        else :</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">BulletTriangleMesh</span><span class="p">()</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">addGeom</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">BulletTriangleMeshShape</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># BulletConvexHullShape</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape ok&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
        <span class="c1"># inodenp = self.worldNP.attachNewNode(BulletRigidBodyNode(ingr.name))</span>
        <span class="c1"># inodenp.node().setMass(1.0)</span>
        <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span><span class="o">.</span><span class="n">addShape</span><span class="p">(</span>
            <span class="n">shape</span>
        <span class="p">)</span>  <span class="c1"># ,TransformState.makePos(Point3(0, 0, 0)))#, pMat)#TransformState.makePos(Point3(jtrans[0],jtrans[1],jtrans[2])))#rotation ?</span>
        <span class="k">return</span> <span class="n">inodenp</span></div>

<div class="viewcode-block" id="Ingredient.SetKw"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.SetKw">[docs]</a>    <span class="k">def</span> <span class="nf">SetKw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kw</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;nbMol&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_nbMol_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>

<div class="viewcode-block" id="Ingredient.Set"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.Set">[docs]</a>    <span class="k">def</span> <span class="nf">Set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbMol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s2">&quot;nbMol&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">nbMol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s2">&quot;nbMol&quot;</span><span class="p">])</span>
            <span class="c1">#            if nbMol != 0:</span>
            <span class="c1">#                self.overwrite_nbMol = True</span>
            <span class="c1">#                self.overwrite_nbMol_value = nbMol</span>
            <span class="c1">#                self.nbMol = nbMol</span>
            <span class="c1">#            else :</span>
            <span class="c1">#                self.overwrite_nbMol =False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_nbMol_value</span> <span class="o">=</span> <span class="n">nbMol</span>
            <span class="c1"># self.nbMol = nbMol</span>
        <span class="k">if</span> <span class="s2">&quot;molarity&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molarity</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;molarity&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;priority&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packingPriority</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;packingMode&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;packingMode&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;compMask&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s2">&quot;compMask&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compMask</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s2">&quot;compMask&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compMask</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;compMask&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Ingredient.getEncapsulatingRadius"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getEncapsulatingRadius">[docs]</a>    <span class="k">def</span> <span class="nf">getEncapsulatingRadius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">:</span>
                <span class="n">helper</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;3dsmax&quot;</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;getEncapsulatingRadius </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">vnormals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
                    <span class="n">mesh</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="c1"># encapsulating radius ?</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># FloatingPointError: underflow encountered in multiply</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">length</span><span class="p">))</span> <span class="o">+</span> <span class="mf">15.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.encapsulatingRadius </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>
            <span class="c1">#        if r != self.encapsulatingRadius:</span>
            <span class="c1">#            self.encapsulatingRadius = r</span>

<div class="viewcode-block" id="Ingredient.getData"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getData">[docs]</a>    <span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">:</span>
                <span class="n">helper</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;3dsmax&quot;</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnormals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.get_rb_model"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.get_rb_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_rb_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">alt</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">addRB</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">rtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Type</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span></div>

<div class="viewcode-block" id="Ingredient.getMesh"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getMesh">[docs]</a>    <span class="k">def</span> <span class="nf">getMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">geomname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a mesh representation from a filename for the ingredient</span>

<span class="sd">        @type  filename: string</span>
<span class="sd">        @param filename: the name of the input file</span>
<span class="sd">        @type  geomname: string</span>
<span class="sd">        @param geomname: the name of the ouput geometry</span>

<span class="sd">        @rtype:   DejaVu.IndexedPolygons/HostObjec</span>
<span class="sd">        @return:  the created mesh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># depending the extension of the filename, can be eitherdejaVu file, fbx or wavefront</span>
        <span class="c1"># no extension is DejaVu</span>
        <span class="n">helper</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
        <span class="c1"># should we try to see if it already exist in the scene</span>
        <span class="k">if</span> <span class="n">helper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">helper</span><span class="o">.</span><span class="n">nogui</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">geomname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;retrieve </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">geomname</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">o</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">o</span>
        <span class="c1"># identify extension</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fileName</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;retrieve </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fileExtension</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">tmpFileName1</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">retrieveFile</span><span class="p">(</span>
                <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.indpolface&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;geometries&quot;</span>
            <span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">tmpFileName1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">retrieveFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;geometries&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fileExtension</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;problem with </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fileExtension</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">fileName</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;found fileName </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fileExtension</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.fbx&quot;</span><span class="p">:</span>
            <span class="c1"># use the host helper if any to read</span>
            <span class="k">if</span> <span class="n">helper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># neeed the helper</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">geomname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;geom </span><span class="si">%r</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">geomname</span><span class="p">,</span> <span class="n">helper</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span>
                <span class="c1"># reparent to the fill parent</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;3dsmax&quot;</span> <span class="ow">or</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;blender&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">resetTransformation</span><span class="p">(</span>
                        <span class="n">geom</span>
                    <span class="p">)</span>  <span class="c1"># remove rotation and scale from importing</span>
                    <span class="c1"># helper.rotateObj(geom,[0.0,0.0,-math.pi/2.0])</span>
                    <span class="c1"># m = geom.GetNodeTM()</span>
                    <span class="c1"># m.PreRotateY(-math.pi/2.0)</span>
                    <span class="c1"># geom.SetNodeTM(m)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">!=</span> <span class="s2">&quot;c4d&quot;</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordsystem</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span>
                    <span class="ow">and</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">!=</span> <span class="s2">&quot;softimage&quot;</span>
                <span class="p">):</span>
                    <span class="c1"># need to rotate the transform that carry the shape</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">rotateObj</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;softimage&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordsystem</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">rotateObj</span><span class="p">(</span>
                        <span class="n">geom</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>  <span class="c1"># need to rotate the primitive</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;c4d&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordsystem</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">resetTransformation</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">rotateObj</span><span class="p">(</span>
                        <span class="n">geom</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">],</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                <span class="c1"># oldv = self.principalVector[:]</span>
                <span class="c1">#                    self.principalVector = [oldv[2],oldv[1],oldv[0]]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;autopackHider&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">newEmpty</span><span class="p">(</span><span class="s2">&quot;autopackHider&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;blender&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">helper</span><span class="o">.</span><span class="n">toggleDisplay</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">reParent</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">geom</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.dae&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;read dae withHelper&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">helper</span><span class="p">,</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="p">)</span>
            <span class="c1"># use the host helper if any to read</span>
            <span class="k">if</span> <span class="n">helper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># need to get the mesh directly. Only possible if dae or dejavu format</span>
                <span class="c1"># get the dejavu heper but without the View, and in nogui mode</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">simulariumHelper</span><span class="p">(</span><span class="n">vi</span><span class="o">=</span><span class="s2">&quot;nogui&quot;</span><span class="p">)</span>
                <span class="n">dgeoms</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="c1"># v,vn,f = dgeoms.values()[0][&quot;mesh&quot;]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnormals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">combineDaeMeshData</span><span class="p">(</span>
                    <span class="n">dgeoms</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vnormals</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[]</span>
                <span class="p">)</span>  <span class="c1"># helper.normal_array(self.vertices,numpy.array(self.faces))</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">createsNmesh</span><span class="p">(</span><span class="n">geomname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">geom</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># if helper is not None:#neeed the helper</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;dejavu&quot;</span> <span class="ow">and</span> <span class="n">helper</span><span class="o">.</span><span class="n">nogui</span><span class="p">:</span>
                    <span class="n">dgeoms</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">v</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dgeoms</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;mesh&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;vertices nb is </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnormals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">v</span><span class="p">,</span>
                        <span class="n">vn</span><span class="p">,</span>
                        <span class="n">f</span><span class="p">,</span>
                    <span class="p">)</span>  <span class="c1"># helper.combineDaeMeshData(dgeoms.values())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vnormals</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">[]</span>
                    <span class="p">)</span>  <span class="c1"># helper.normal_array(self.vertices,numpy.array(self.faces))</span>
                    <span class="n">geom</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">createsNmesh</span><span class="p">(</span>
                        <span class="n">geomname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnormals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">geom</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">!=</span> <span class="s2">&quot;dejavu&quot;</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">collada</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                            <span class="c1"># need to get the mesh directly. Only possible if dae or dejavu format</span>
                            <span class="c1"># get the dejavu heper but without the View, and in nogui mode</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="n">simulariumHelper</span><span class="p">(</span><span class="n">vi</span><span class="o">=</span><span class="s2">&quot;nogui&quot;</span><span class="p">)</span>
                            <span class="n">dgeoms</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                            <span class="c1"># should combine both</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">vnormals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">combineDaeMeshData</span><span class="p">(</span>
                                <span class="n">dgeoms</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="p">)</span>  <span class="c1"># dgeoms.values()[0][&quot;mesh&quot;]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">vnormals</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">normal_array</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span>
                            <span class="p">)</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="c1">#                helper.update()</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">geomname</span><span class="p">)</span>
                <span class="c1"># if geom is None, the name was probably wring lets try to use the default name which is</span>
                <span class="c1"># pdbNAme+_cms</span>
                <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">geom</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># rename it</span>
                    <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                <span class="c1"># rotate ?</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;3dsmax&quot;</span><span class="p">:</span>  <span class="c1"># or helper.host.find(&quot;blender&quot;) != -1:</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">resetTransformation</span><span class="p">(</span>
                        <span class="n">geom</span>
                    <span class="p">)</span>  <span class="c1"># remove rotation and scale from importing??maybe not?</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;blender&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">resetTransformation</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
                <span class="c1"># if self.coordsystem == &quot;left&quot; :</span>
                <span class="c1">#                        mA = helper.rotation_matrix(-math.pi/2.0,[1.0,0.0,0.0])</span>
                <span class="c1">#                        mB = helper.rotation_matrix(math.pi/2.0,[0.0,0.0,1.0])</span>
                <span class="c1">#                        m=matrix(mA)*matrix(mB)</span>
                <span class="c1">#                        helper.setObjectMatrix(geom,matrice=m)</span>
                <span class="c1">#                if helper.host != &quot;c4d&quot;  and helper.host != &quot;dejavu&quot; and self.coordsystem == &quot;left&quot; and helper.host != &quot;softimage&quot; and helper.host.find(&quot;blender&quot;) == -1:</span>
                <span class="c1"># what about softimage</span>
                <span class="c1"># need to rotate the transform that carry the shape, maya ? or not ?</span>
                <span class="c1">#                    helper.rotateObj(geom,[0.0,-math.pi/2.0,0.0])#wayfront as well euler angle</span>
                <span class="c1"># swicth the axe?</span>
                <span class="c1">#                    oldv = self.principalVector[:]</span>
                <span class="c1">#                    self.principalVector = [oldv[2],oldv[1],oldv[0]]</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;softimage&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordsystem</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">rotateObj</span><span class="p">(</span>
                        <span class="n">geom</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>  <span class="c1"># need to rotate the primitive</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;c4d&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordsystem</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">resetTransformation</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">rotateObj</span><span class="p">(</span>
                        <span class="n">geom</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">],</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;autopackHider&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">newEmpty</span><span class="p">(</span><span class="s2">&quot;autopackHider&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;blender&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">helper</span><span class="o">.</span><span class="n">toggleDisplay</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">reParent</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">geom</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># host specific file</span>
            <span class="k">if</span> <span class="n">helper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># neeed the helper</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                    <span class="n">filename</span>
                <span class="p">)</span>  <span class="c1"># doesnt get the regular file ? conver state to object</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">geomname</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;autopackHider&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">newEmpty</span><span class="p">(</span><span class="s2">&quot;autopackHider&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;blender&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">helper</span><span class="o">.</span><span class="n">toggleDisplay</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">reParent</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">geom</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Ingredient.buildMesh"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.buildMesh">[docs]</a>    <span class="k">def</span> <span class="nf">buildMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geomname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a polygon mesh object from a dictionary verts,faces,normals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;verts&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;faces&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;verts&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nv</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;faces&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="c1"># self.normals = data.normals</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">createsNmesh</span><span class="p">(</span><span class="n">geomname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">)[</span>
            <span class="mi">0</span>
        <span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;autopackHider&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">newEmpty</span><span class="p">(</span><span class="s2">&quot;autopackHider&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;blender&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">toggleDisplay</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">reParent</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshFile</span> <span class="o">=</span> <span class="n">geomname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshName</span> <span class="o">=</span> <span class="n">geomname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshType</span> <span class="o">=</span> <span class="s2">&quot;file&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">geom</span>
        <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">saveDejaVuMesh</span><span class="p">(</span>
            <span class="n">autopack</span><span class="o">.</span><span class="n">cache_geoms</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">geomname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span>
        <span class="p">)</span>
        <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">saveObjMesh</span><span class="p">(</span>
            <span class="n">autopack</span><span class="o">.</span><span class="n">cache_geoms</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">geomname</span> <span class="o">+</span> <span class="s2">&quot;.obj&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span>
        <span class="p">)</span>
        <span class="c1"># self.saveObjMesh(autopack.cache_geoms + os.sep + geomname + &quot;.obj&quot;)</span>
        <span class="k">return</span> <span class="n">geom</span></div>

<div class="viewcode-block" id="Ingredient.jitterPosition"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.jitterPosition">[docs]</a>    <span class="k">def</span> <span class="nf">jitterPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">normal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        position are the 3d coordiantes of the grid point</span>
<span class="sd">        spacing is the grid spacing</span>
<span class="sd">        this will jitter gauss(0., 0.3) * Ingredient.jitterMax</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">principalVector</span>
            <span class="c1"># surfacePointsNormals problem here</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">normal</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rotMat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rotVectToVect</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">rotMat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">jx</span><span class="p">,</span> <span class="n">jy</span><span class="p">,</span> <span class="n">jz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jitterMax</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">jx</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">*</span> <span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># This needs to use the same rejection if outside of the sphere that the uniform cartesian jitters have.  Shoiuld use oneJitter instead?</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">jy</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">*</span> <span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">jz</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">*</span> <span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="c1">#        d2 = dx*dx + dy*dy + dz*dz</span>
        <span class="c1">#        if d2 &lt; jitter2:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># jitter less among normal</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotMat</span><span class="p">,</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span>
        <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span>
        <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz</span>
        <span class="k">return</span> <span class="n">position</span></div>

<div class="viewcode-block" id="Ingredient.getMaxJitter"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getMaxJitter">[docs]</a>    <span class="k">def</span> <span class="nf">getMaxJitter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spacing</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jitterMax</span><span class="p">)</span> <span class="o">*</span> <span class="n">spacing</span></div>

<div class="viewcode-block" id="Ingredient.swap"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.swap">[docs]</a>    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.deleteblist"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.deleteblist">[docs]</a>    <span class="k">def</span> <span class="nf">deleteblist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">n</span><span class="p">]</span></div>

<div class="viewcode-block" id="Ingredient.get_cuttoff_value"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.get_cuttoff_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_cuttoff_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spacing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the min value a grid point needs to be away from a surfance</span>
<span class="sd">        in order for this ingredient to pack. Only needs to be calculated once</span>
<span class="sd">        per ingredient once the jitter is set.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_distance</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxJitter</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">==</span> <span class="s2">&quot;close&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span> <span class="o">==</span> <span class="s2">&quot;Cylinders&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">useLength</span><span class="p">:</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">jitter</span>
            <span class="c1">#            if ingr.modelType==&#39;Cube&#39; : #radius iactually the size</span>
            <span class="c1">#                cut = min(self.radii[0]/2.)-jitter</span>
            <span class="c1">#            elif ingr.cutoff_boundary is not None :</span>
            <span class="c1">#                #this mueay work if we have the distance from the border</span>
            <span class="c1">#                cut  = radius+ingr.cutoff_boundary-jitter</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">jitter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cut</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">jitter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_distance</span> <span class="o">=</span> <span class="n">cut</span>
        <span class="k">return</span> <span class="n">cut</span></div>

<div class="viewcode-block" id="Ingredient.checkIfUpdate"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.checkIfUpdate">[docs]</a>    <span class="k">def</span> <span class="nf">checkIfUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if we need to update the distance array. Part of the hack free points&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;nbPts&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;firstTimeUpdate&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstTimeUpdate</span><span class="p">:</span>
                <span class="c1"># if it has been updated before</span>
                <span class="c1"># check the number of inside points for this ingredient over the total</span>
                <span class="c1"># number of free points left</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPts</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nbFreePoints</span><span class="p">)</span>
                <span class="c1"># threshold defaults to zero. It&#39;s set by the env, `freePtsUpdateThreshold`</span>
                <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">haveBeenRejected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">haveBeenRejected</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="c1"># do we check to total freepts? or crowded state ?</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstTimeUpdate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Ingredient.get_list_of_free_indices"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.get_list_of_free_indices">[docs]</a>    <span class="k">def</span> <span class="nf">get_list_of_free_indices</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">distances</span><span class="p">,</span>
        <span class="n">free_points</span><span class="p">,</span>
        <span class="n">nbFreePoints</span><span class="p">,</span>
        <span class="n">spacing</span><span class="p">,</span>
        <span class="n">comp_ids</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">allIngrPts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allIngrDist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_comp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span>
        <span class="c1"># gets min distance an object has to be away to allow packing for this object</span>
        <span class="n">cuttoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cuttoff_value</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">==</span> <span class="s2">&quot;close&quot;</span><span class="p">:</span>
            <span class="c1"># Get an array of free points where the distance is greater than half the cuttoff value</span>
            <span class="c1"># and less than the cutoff. Ie an array where the distances are all very small.</span>
            <span class="c1"># this also masks the array to only include points in the current commpartment</span>
            <span class="n">all_distances</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances</span><span class="p">)[</span><span class="n">free_points</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">all_distances</span><span class="p">,</span> <span class="n">cuttoff</span><span class="p">),</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">all_distances</span><span class="p">,</span> <span class="n">cuttoff</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># mask compartments Id as well</span>
            <span class="n">mask_comp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">comp_ids</span><span class="p">)[</span><span class="n">free_points</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_comp_id</span>
            <span class="n">mask_ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_comp</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">allIngrPts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">free_points</span><span class="p">)[</span><span class="n">mask_ind</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">allIngrDist</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances</span><span class="p">)[</span><span class="n">mask_ind</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">starting_array</span> <span class="o">=</span> <span class="n">free_points</span>
            <span class="n">array_length</span> <span class="o">=</span> <span class="n">nbFreePoints</span>
            <span class="c1"># if this ingredient has a grid point array already from a previous pass, and it&#39;s shorter</span>
            <span class="c1"># than the total number of free points, start there for picking points, because it means</span>
            <span class="c1"># we&#39;ve already filtered out some points that are too close to surfaces for this ingredient to</span>
            <span class="c1"># pack and we don&#39;t want to have to filter them out again.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allIngrPts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allIngrPts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nbFreePoints</span><span class="p">:</span>
                <span class="n">starting_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allIngrPts</span>
                <span class="n">array_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allIngrPts</span><span class="p">)</span>

            <span class="c1"># use periodic update according size ratio grid</span>
            <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkIfUpdate</span><span class="p">(</span><span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                <span class="c1"># Only return points that aren&#39;t so close to a surface that we know the</span>
                <span class="c1"># ingredient won&#39;t fit</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array_length</span><span class="p">):</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="n">starting_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">comp_ids</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_comp_id</span> <span class="ow">and</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="n">cuttoff</span><span class="p">:</span>
                        <span class="n">allIngrPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">allIngrPts</span> <span class="o">=</span> <span class="n">allIngrPts</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allIngrPts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">allIngrPts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allIngrPts</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">allIngrPts</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[:</span><span class="n">nbFreePoints</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">allIngrPts</span> <span class="o">=</span> <span class="n">allIngrPts</span>
        <span class="k">return</span> <span class="n">allIngrPts</span><span class="p">,</span> <span class="n">allIngrDist</span></div>

<div class="viewcode-block" id="Ingredient.perturbAxis"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.perturbAxis">[docs]</a>    <span class="k">def</span> <span class="nf">perturbAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">):</span>
        <span class="c1"># modify axis using gaussian distribution but clamp</span>
        <span class="c1"># at amplitutde</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">principalVector</span>
        <span class="n">stddev</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stddev</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dx</span> <span class="o">&gt;</span> <span class="n">amplitude</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">amplitude</span>
        <span class="k">elif</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">amplitude</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="n">amplitude</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stddev</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dy</span> <span class="o">&gt;</span> <span class="n">amplitude</span><span class="p">:</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">amplitude</span>
        <span class="k">elif</span> <span class="n">dy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">amplitude</span><span class="p">:</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="o">-</span><span class="n">amplitude</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stddev</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dz</span> <span class="o">&gt;</span> <span class="n">amplitude</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">amplitude</span>
        <span class="k">elif</span> <span class="n">dz</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">amplitude</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="o">-</span><span class="n">amplitude</span>
        <span class="c1"># if self.name==&#39;2bg9 ION CHANNEL/RECEPTOR&#39;:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">dz</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.transformPoints"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.transformPoints">[docs]</a>    <span class="k">def</span> <span class="nf">transformPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
        <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">trans</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">rot</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">rot</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ys</span> <span class="o">+</span> <span class="n">rot</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">zs</span> <span class="o">+</span> <span class="n">tx</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">rot</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">rot</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ys</span> <span class="o">+</span> <span class="n">rot</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">zs</span> <span class="o">+</span> <span class="n">ty</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ys</span> <span class="o">+</span> <span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">zs</span> <span class="o">+</span> <span class="n">tz</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.apply_rotation"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.apply_rotation">[docs]</a>    <span class="k">def</span> <span class="nf">apply_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">([</span><span class="n">rot</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span> <span class="n">rot</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span> <span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="mi">3</span><span class="p">]])</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_pos</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.alignRotation"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.alignRotation">[docs]</a>    <span class="k">def</span> <span class="nf">alignRotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">):</span>
        <span class="c1"># for surface points we compute the rotation which</span>
        <span class="c1"># aligns the principalVector with the surface normal</span>
        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">principalVector</span>
        <span class="c1"># surfacePointsNormals problem here</span>
        <span class="n">gradient_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gradient</span><span class="p">]</span><span class="o">.</span><span class="n">direction</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gradient_center</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jtrans</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rotMat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rotVectToVect</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">rotMat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rotMat</span></div>

<div class="viewcode-block" id="Ingredient.getAxisRotation"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getAxisRotation">[docs]</a>    <span class="k">def</span> <span class="nf">getAxisRotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        combines a rotation about axis to incoming rot.</span>
<span class="sd">        rot aligns the principalVector with the surface normal</span>
<span class="sd">        rot aligns the principalVector with the biased diretion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbAxisAmplitude</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbAxis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perturbAxisAmplitude</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">principalVector</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span>
        <span class="n">rrot</span> <span class="o">=</span> <span class="n">rotax</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span> <span class="n">rrot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rot</span></div>

<div class="viewcode-block" id="Ingredient.getBiasedRotation"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getBiasedRotation">[docs]</a>    <span class="k">def</span> <span class="nf">getBiasedRotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        combines a rotation about axis to incoming rot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># -30,+30 ?</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">pi</span> <span class="o">*</span> <span class="n">weight</span><span class="p">,</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">weight</span><span class="p">)</span>  <span class="c1"># (-pi, pi)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orientBiasRotRangeMin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientBiasRotRangeMax</span>
            <span class="p">)</span>  <span class="c1"># (-pi, pi)</span>
        <span class="n">rrot</span> <span class="o">=</span> <span class="n">rotax</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotAxis</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span> <span class="n">rrot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rot</span></div>

<div class="viewcode-block" id="Ingredient.correctBB"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.correctBB">[docs]</a>    <span class="k">def</span> <span class="nf">correctBB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">radc</span><span class="p">):</span>
        <span class="c1"># unprecised</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">p1</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">p2</span>
        <span class="c1">#        bb = ( [x1-radc, y1-radc, z1-radc], [x2+radc, y2+radc, z2+radc] )</span>
        <span class="n">mini</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">maxi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">mini</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">radc</span><span class="p">)</span>
            <span class="n">maxi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">radc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mini</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">maxi</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span></div>
        <span class="c1"># precised:</span>

<div class="viewcode-block" id="Ingredient.checkDistSurface"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.checkDistSurface">[docs]</a>    <span class="k">def</span> <span class="nf">checkDistSurface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;histoVol&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">compNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span>
        <span class="k">if</span> <span class="n">compNum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sfpts</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfacePointsCoords</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sfpts</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">*=</span> <span class="n">delta</span>
            <span class="n">distA</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">distA</span> <span class="o">&lt;</span> <span class="n">cutoff</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">test</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="n">sfpts</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">surfacePointsCoords</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sfpts</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="n">delta</span> <span class="o">*=</span> <span class="n">delta</span>
                <span class="n">distA</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">distA</span> <span class="o">&lt;</span> <span class="n">cutoff</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">test</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Ingredient.getListCompFromMask"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getListCompFromMask">[docs]</a>    <span class="k">def</span> <span class="nf">getListCompFromMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cId</span><span class="p">,</span> <span class="n">ptsInSphere</span><span class="p">):</span>
        <span class="c1"># cID ie [-2,-1,-2,0...], ptsinsph = [519,300,etc]</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># inside</span>
            <span class="n">ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cId</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">current</span><span class="p">]</span>
            <span class="c1"># surf=[i for i,x in enumerate(cId) if x == -current]</span>
            <span class="n">liste</span> <span class="o">=</span> <span class="n">ins</span>  <span class="c1"># +surf</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># surface</span>
            <span class="n">ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cId</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">current</span><span class="p">]</span>
            <span class="n">surf</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cId</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="o">-</span><span class="n">current</span><span class="p">]</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cId</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">liste</span> <span class="o">=</span> <span class="n">ins</span> <span class="o">+</span> <span class="n">surf</span> <span class="o">+</span> <span class="n">extra</span>
        <span class="k">elif</span> <span class="n">current</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># extracellular</span>
            <span class="n">liste</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cId</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">current</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">liste</span></div>

<div class="viewcode-block" id="Ingredient.isInGoodComp"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.isInGoodComp">[docs]</a>    <span class="k">def</span> <span class="nf">isInGoodComp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pId</span><span class="p">,</span> <span class="n">nbs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># cID ie [-2,-1,-2,0...], ptsinsph = [519,300,etc]</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span>
        <span class="n">cId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridPtId</span><span class="p">[</span><span class="n">pId</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># inside</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">cId</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># surface</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">cId</span> <span class="ow">and</span> <span class="o">-</span><span class="n">current</span> <span class="o">!=</span> <span class="n">cId</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Ingredient.compareCompartmentPrimitive"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.compareCompartmentPrimitive">[docs]</a>    <span class="k">def</span> <span class="nf">compareCompartmentPrimitive</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">gridPointsCoords</span><span class="p">,</span> <span class="n">distance</span>
    <span class="p">):</span>
        <span class="n">collisionComp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collides_with_compartment</span><span class="p">(</span>
            <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">gridPointsCoords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">collisionComp</span></div>

<div class="viewcode-block" id="Ingredient.checkCompartment"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.checkCompartment">[docs]</a>    <span class="k">def</span> <span class="nf">checkCompartment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptsInSphere</span><span class="p">,</span> <span class="n">nbs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartment</span><span class="p">:</span>
            <span class="n">cId</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridPtId</span><span class="p">,</span> <span class="n">ptsInSphere</span><span class="p">,</span> <span class="mi">0</span>
            <span class="p">)</span>  <span class="c1"># shoud be the same ?</span>
            <span class="k">if</span> <span class="n">nbs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nbs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">trigger</span><span class="p">,</span> <span class="kc">True</span>
            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getListCompFromMask</span><span class="p">(</span><span class="n">cId</span><span class="p">,</span> <span class="n">ptsInSphere</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cId</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">trigger</span><span class="p">,</span> <span class="kc">True</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">cId</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># ratio accepted compId / totalCompId-&gt; want 1.0</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartmentTolerance</span><span class="p">:</span>
                <span class="n">trigger</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">trigger</span><span class="p">,</span> <span class="kc">True</span>
            <span class="c1"># threshold</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartmentThreshold</span> <span class="o">!=</span> <span class="mf">0.0</span>
                <span class="ow">and</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartmentThreshold</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">trigger</span><span class="p">,</span> <span class="kc">True</span>
                <span class="c1"># reject the ingr</span>
        <span class="k">return</span> <span class="n">trigger</span><span class="p">,</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Ingredient.collision_jitter"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.collision_jitter">[docs]</a>    <span class="k">def</span> <span class="nf">collision_jitter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">jtrans</span><span class="p">,</span>
        <span class="n">rotMat</span><span class="p">,</span>
        <span class="n">level</span><span class="p">,</span>
        <span class="n">gridPointsCoords</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">,</span>
        <span class="n">histoVol</span><span class="p">,</span>
        <span class="n">dpad</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check spheres for collision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
        <span class="c1"># should we also check for outside the main grid ?</span>
        <span class="c1"># wouldnt be faster to do sphere-sphere distance test ? than points/points from the grid</span>
        <span class="n">centT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformPoints</span><span class="p">(</span><span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">centers</span><span class="p">)</span>  <span class="c1"># centers)</span>
        <span class="c1"># sphNum = 0  # which sphere in the sphere tree we&#39;re checking</span>
        <span class="c1"># self.distances_temp = []</span>
        <span class="n">insidePoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">newDistPoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">at_max_level</span> <span class="o">=</span> <span class="n">level</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepest_level</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">radius_of_ing_being_packed</span><span class="p">,</span> <span class="n">posc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">centT</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">posc</span>
            <span class="n">radius_of_area_to_check</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">radius_of_ing_being_packed</span> <span class="o">+</span> <span class="n">dpad</span>
            <span class="p">)</span>  <span class="c1"># extends the packing ingredient&#39;s bounding box to be large enough to include masked gridpoints of the largest possible ingrdient in the receipe</span>
            <span class="c1">#  TODO: add realtime render here that shows all the points being checked by the collision</span>

            <span class="n">pointsToCheck</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getPointsInSphere</span><span class="p">(</span>
                <span class="n">posc</span><span class="p">,</span> <span class="n">radius_of_area_to_check</span>
            <span class="p">)</span>  <span class="c1"># indices</span>
            <span class="c1"># check for collisions by looking at grid points in the sphere of radius radc</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">gridPointsCoords</span><span class="p">,</span> <span class="n">pointsToCheck</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">posc</span>
            <span class="n">delta</span> <span class="o">*=</span> <span class="n">delta</span>
            <span class="n">distA</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">pti</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pointsToCheck</span><span class="p">)):</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="n">pointsToCheck</span><span class="p">[</span>
                    <span class="n">pti</span>
                <span class="p">]</span>  <span class="c1"># index of master grid point that is inside the sphere</span>
                <span class="n">distance_to_packing_location</span> <span class="o">=</span> <span class="n">distA</span><span class="p">[</span>
                    <span class="n">pti</span>
                <span class="p">]</span>  <span class="c1"># is that point&#39;s distance from the center of the sphere (packing location)</span>
                <span class="c1"># distance is an array of distance of closest contact to anything currently in the grid</span>
                <span class="n">collision</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">distance</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">+</span> <span class="n">distance_to_packing_location</span>
                    <span class="o">&lt;=</span> <span class="n">radius_of_ing_being_packed</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">collision</span><span class="p">:</span>
                    <span class="c1"># an object is too close to the sphere at this level</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">at_max_level</span><span class="p">:</span>
                        <span class="c1"># if we haven&#39;t made it all the way down the sphere tree,</span>
                        <span class="c1"># check a level down</span>
                        <span class="n">new_level</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="c1"># NOTE: currently with sphere trees, no children seem present</span>
                        <span class="c1"># get sphere that are children of this one</span>
                        <span class="c1"># ccenters = []</span>
                        <span class="c1"># cradii = []</span>
                        <span class="c1"># for sphInd in self.children[level][sphNum]:</span>
                        <span class="c1">#     ccenters.append(nxtLevelSpheres[sphInd])</span>
                        <span class="c1">#     cradii.append(nxtLevelRadii[sphInd])</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collision_jitter</span><span class="p">(</span>
                            <span class="n">jtrans</span><span class="p">,</span>
                            <span class="n">rotMat</span><span class="p">,</span>
                            <span class="n">new_level</span><span class="p">,</span>
                            <span class="n">gridPointsCoords</span><span class="p">,</span>
                            <span class="n">distance</span><span class="p">,</span>
                            <span class="n">histoVol</span><span class="p">,</span>
                            <span class="n">dpad</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;grid point already occupied </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">distance</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
                        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">at_max_level</span><span class="p">:</span>
                    <span class="c1"># we don&#39;t want to calculate new distances if we are not</span>
                    <span class="c1"># at the highest geo</span>
                    <span class="c1"># but getting here means there was no collision detected</span>
                    <span class="c1"># so the loop can continue</span>
                    <span class="k">continue</span>

                <span class="n">signed_distance_to_sphere_surface</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">distance_to_packing_location</span> <span class="o">-</span> <span class="n">radius_of_ing_being_packed</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">signed_distance_to_sphere_surface</span> <span class="o">&lt;=</span> <span class="mi">0</span>
                <span class="p">):</span>  <span class="c1"># point is inside dropped sphere</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">histoVol</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridPtId</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&lt;=</span> <span class="mi">0</span>
                    <span class="p">):</span>  <span class="c1"># did this jitter outside of it&#39;s compartment</span>
                        <span class="c1"># in wrong compartment, reject this packing position</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;checked pt that is not in container&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">insidePoints</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">signed_distance_to_sphere_surface</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span>
                            <span class="n">insidePoints</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">insidePoints</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">signed_distance_to_sphere_surface</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">insidePoints</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">signed_distance_to_sphere_surface</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">signed_distance_to_sphere_surface</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
                <span class="p">):</span>  <span class="c1"># point in region of influence</span>
                    <span class="c1"># need to update the distances of the master grid with new smaller distance</span>
                    <span class="k">if</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">newDistPoints</span><span class="p">:</span>
                        <span class="n">newDistPoints</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                            <span class="n">signed_distance_to_sphere_surface</span><span class="p">,</span> <span class="n">newDistPoints</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">newDistPoints</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">signed_distance_to_sphere_surface</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">at_max_level</span><span class="p">:</span>
                <span class="c1"># we didn&#39;t find any colisions with the this level, but we still want</span>
                <span class="c1"># the inside points to be based on the most detailed geom</span>
                <span class="n">new_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepest_level</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collision_jitter</span><span class="p">(</span>
                    <span class="n">jtrans</span><span class="p">,</span>
                    <span class="n">rotMat</span><span class="p">,</span>
                    <span class="n">new_level</span><span class="p">,</span>
                    <span class="n">gridPointsCoords</span><span class="p">,</span>
                    <span class="n">distance</span><span class="p">,</span>
                    <span class="n">histoVol</span><span class="p">,</span>
                    <span class="n">dpad</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span></div>

<div class="viewcode-block" id="Ingredient.checkPointComp"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.checkPointComp">[docs]</a>    <span class="k">def</span> <span class="nf">checkPointComp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="c1"># if grid too sparse this will not work.</span>
        <span class="c1"># ptID = self.env.grid.getPointFrom3D(point)</span>
        <span class="n">cID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">getPointCompartmentId</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>  <span class="c1"># offset ?</span>
        <span class="c1"># dist,ptID = self.env.grid.getClosestGridPoint(point)</span>
        <span class="c1"># cID = self.env.grid.gridPtId[ptID]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">organelle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">organelle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># surface ingredient</span>
            <span class="c1"># print (&quot;surface ingr of type &quot;,self.Type)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                <span class="c1"># need a list of accepted compNum</span>
                <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compMask</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compMask</span><span class="p">:</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># if cID &gt; 0 : #surface point look at surface cutoff</span>
                <span class="c1">#                    if dist &lt; self.cutoff_surface :</span>
                <span class="c1">#                        check = False</span>
                <span class="c1">#                    else :</span>
                <span class="c1">#                        check = True #grid probably too sparse, need to check where we are</span>
                <span class="k">return</span> <span class="n">check</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># for i,o in self.env.compartments:</span>
        <span class="c1">#        if self.compNum != cID:</span>
        <span class="c1">#            return False</span>
        <span class="c1">#        else :</span>
        <span class="c1">#            return True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">organelle</span><span class="o">.</span><span class="n">checkPointInside</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">diag</span><span class="p">,</span> <span class="n">ray</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inside</span><span class="p">:</span>  <span class="c1"># and cID &lt; 0:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
                <span class="c1">#            if inside and self.compNum &gt;=0 :</span>
                <span class="c1">#                return False</span>
                <span class="c1">#            if not inside and self.compNum &lt; 0 :</span>
                <span class="c1">#                return False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># shouldnt be in any compartments</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="n">inside</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">checkPointInside</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">diag</span><span class="p">,</span> <span class="n">ray</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inside</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">!=</span> <span class="n">cID</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Ingredient.checkPointSurface"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.checkPointSurface">[docs]</a>    <span class="k">def</span> <span class="nf">checkPointSurface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;histoVol&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">compNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">compartment</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;test compartment </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">OGsrfPtsBht</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">OGsrfPtsBht</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point</span><span class="p">])))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># pt=res[1][0]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;distance is </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">cutoff</span>
                <span class="p">)</span>  <span class="c1"># d can be wrond for some reason,</span>
                <span class="c1"># d = autopack.helper.measure_distance(point,o.vertices[pt])</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">compNum</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">compartment</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">inside</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">checkPointInside</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">diag</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;inside ? </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">inside</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">inside</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Ingredient.point_is_not_available"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.point_is_not_available">[docs]</a>    <span class="k">def</span> <span class="nf">point_is_not_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes in a vector returns a boolean&quot;&quot;&quot;</span>
        <span class="n">inComp</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">closeS</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">checkPointInside</span><span class="p">(</span>
            <span class="n">newPt</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff_boundary</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="n">getNormedVectorOnes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jitterMax</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">inside</span><span class="p">:</span>
            <span class="n">inComp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkPointComp</span><span class="p">(</span><span class="n">newPt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inComp</span><span class="p">:</span>
                <span class="c1"># check how far from surface ?</span>
                <span class="n">closeS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkPointSurface</span><span class="p">(</span><span class="n">newPt</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff_surface</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">inside</span> <span class="ow">or</span> <span class="n">closeS</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">inComp</span></div>

<div class="viewcode-block" id="Ingredient.oneJitter"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.oneJitter">[docs]</a>    <span class="k">def</span> <span class="nf">oneJitter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">):</span>
        <span class="n">jtrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize_translation</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">)</span>
        <span class="n">rotMatj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize_rotation</span><span class="p">(</span><span class="n">rotMat</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span></div>

<div class="viewcode-block" id="Ingredient.get_new_jitter_location_and_rotation"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.get_new_jitter_location_and_rotation">[docs]</a>    <span class="k">def</span> <span class="nf">get_new_jitter_location_and_rotation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">starting_pos</span><span class="p">,</span> <span class="n">starting_rotation</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;tile&quot;</span><span class="p">:</span>
            <span class="n">packing_location</span> <span class="o">=</span> <span class="n">starting_pos</span>
            <span class="n">packing_rotation</span> <span class="o">=</span> <span class="n">starting_rotation</span><span class="p">[:]</span>
            <span class="k">return</span> <span class="n">packing_location</span><span class="p">,</span> <span class="n">packing_rotation</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oneJitter</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">starting_pos</span><span class="p">,</span> <span class="n">starting_rotation</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.getInsidePoints"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getInsidePoints">[docs]</a>    <span class="k">def</span> <span class="nf">getInsidePoints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">grid</span><span class="p">,</span>
        <span class="n">gridPointsCoords</span><span class="p">,</span>
        <span class="n">dpad</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">,</span>
        <span class="n">centT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">jtrans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rotMatj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_distance_values</span><span class="p">(</span>
            <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">gridPointsCoords</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">dpad</span>
        <span class="p">)</span></div>
        <span class="c1"># return self.get_new_distance_values(</span>
        <span class="c1">#    grid, gridPointsCoords, dpad, distance, centT, jtrans, rotMatj, dpad</span>
        <span class="c1"># )</span>

<div class="viewcode-block" id="Ingredient.getIngredientsInBox"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getIngredientsInBox">[docs]</a>    <span class="k">def</span> <span class="nf">getIngredientsInBox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">histoVol</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">compartment</span><span class="p">,</span> <span class="n">afvi</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">windowsSize_overwrite</span><span class="p">:</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">windowsSize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#            rad = self.minRadius*2.0# + histoVol.largestProteinSize + \</span>
            <span class="c1"># histoVol.smallestProteinSize + histoVol.windowsSize</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span>
                <span class="o">+</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">largestProteinSize</span>
                <span class="o">+</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">smallestProteinSize</span>
                <span class="o">+</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">windowsSize</span>
            <span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">jtrans</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="p">([</span><span class="n">x</span> <span class="o">-</span> <span class="n">rad</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">rad</span><span class="p">,</span> <span class="n">z</span> <span class="o">-</span> <span class="n">rad</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">rad</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">rad</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">rad</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span> <span class="o">==</span> <span class="s2">&quot;Cylinders&quot;</span><span class="p">:</span>
            <span class="n">cent1T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformPoints</span><span class="p">(</span>
                <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deepest_level</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">cent2T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformPoints</span><span class="p">(</span>
                <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deepest_level</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">bbs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">radc</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span> <span class="n">cent1T</span><span class="p">,</span> <span class="n">cent2T</span><span class="p">):</span>
                <span class="n">bb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctBB</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">radc</span><span class="p">)</span>
                <span class="n">bbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
            <span class="c1"># get min and max from all bbs</span>
            <span class="n">maxBB</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">minBB</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">9999</span><span class="p">,</span> <span class="mi">9999</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">bbs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minBB</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">minBB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxBB</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">maxBB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minBB</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">minBB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxBB</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">maxBB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">bb</span> <span class="o">=</span> <span class="p">[</span><span class="n">minBB</span><span class="p">,</span> <span class="n">maxBB</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">runTimeDisplay</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;partBox&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="s2">&quot;partBox&quot;</span><span class="p">,</span> <span class="n">cornerPoints</span><span class="o">=</span><span class="n">bb</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">toggleDisplay</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">updateBox</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">cornerPoints</span><span class="o">=</span><span class="n">bb</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                <span class="c1">#            sleep(1.0)</span>
        <span class="n">pointsInCube</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getPointsInCube</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rad</span><span class="p">)</span>
        <span class="c1"># should we got all ingre from all recipes?</span>
        <span class="c1"># can use the kdtree for it...</span>
        <span class="c1"># maybe just add the surface if its not already the surface</span>
        <span class="n">mingrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">compartment</span><span class="o">.</span><span class="n">molecules</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pointsInCube</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mingrs</span></div>

<div class="viewcode-block" id="Ingredient.getIngredientsInTree"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getIngredientsInTree">[docs]</a>    <span class="k">def</span> <span class="nf">getIngredientsInTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close_indice</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">):</span>
            <span class="n">ingrs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">close_indice</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]]</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">)[</span><span class="n">close_indice</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]],</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rRot</span><span class="p">)[</span><span class="n">close_indice</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]],</span>
                <span class="n">ingrs</span><span class="p">,</span>
                <span class="n">close_indice</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Ingredient.getListePartners"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getListePartners">[docs]</a>    <span class="k">def</span> <span class="nf">getListePartners</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">histoVol</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">organelle</span><span class="p">,</span> <span class="n">afvi</span><span class="p">,</span> <span class="n">close_indice</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">close_indice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mingrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngredientsInBox</span><span class="p">(</span><span class="n">histoVol</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">organelle</span><span class="p">,</span> <span class="n">afvi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># mingrs = zip(*mingrs)</span>
            <span class="n">mingrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngredientsInTree</span><span class="p">(</span><span class="n">close_indice</span><span class="p">)</span>
        <span class="n">listePartner</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">mingrs</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">mingrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no close ingredient found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;nb close ingredient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">listePartner</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mingrs</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
            <span class="n">ing</span> <span class="o">=</span> <span class="n">mingrs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">mingrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">==</span> <span class="s2">&quot;closePartner&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ing</span><span class="o">.</span><span class="n">o_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners_name</span> <span class="ow">or</span> <span class="n">ing</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners_name</span><span class="p">:</span>
                    <span class="c1">#                    print (&quot;is a partner of&quot;+self.name)</span>
                    <span class="n">listePartner</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners</span><span class="p">[</span><span class="n">ing</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">mingrs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
                    <span class="c1">#                                         autopack.helper.measure_distance(jtrans,mingrs[0][i])])</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ing</span><span class="o">.</span><span class="n">isAttractor</span>
            <span class="p">):</span>  <span class="c1"># and self.compNum &lt;= 0: #always attract! or rol a dice ?sself.excluded_partners.has_key(name)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">ing</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners_name</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ing</span><span class="o">.</span><span class="n">excluded_partners_name</span>
                    <span class="ow">and</span> <span class="n">ing</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">excluded_partners_name</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;shoul attract </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPartner</span><span class="p">(</span><span class="n">ing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">part</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addPartner</span><span class="p">(</span><span class="n">ing</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">ing</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ing</span><span class="o">.</span><span class="n">distExpression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">part</span><span class="o">.</span><span class="n">distExpression</span> <span class="o">=</span> <span class="n">ing</span><span class="o">.</span><span class="n">distExpression</span>
                    <span class="c1"># print &quot;new Partner&quot;, part,part.name,part.weight</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">measure_distance</span><span class="p">(</span><span class="n">jtrans</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="n">listePartner</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">listePartner</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no partner found in close ingredient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mingrs</span><span class="p">,</span> <span class="n">listePartner</span></div>

<div class="viewcode-block" id="Ingredient.getTransform"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getTransform">[docs]</a>    <span class="k">def</span> <span class="nf">getTransform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tTrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">ToVec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">htrans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tTrans</span><span class="p">)</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">htrans</span><span class="p">))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">measure_distance</span><span class="p">(</span><span class="n">tTrans</span><span class="p">,</span> <span class="n">avg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Ingredient.get_new_pos"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.get_new_pos">[docs]</a>    <span class="k">def</span> <span class="nf">get_new_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">positions_to_adjust</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes positions_to_adjust, such as an array of spheres at a level in a</span>
<span class="sd">        sphere tree, and adjusts them relative to the given position and rotation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">positions_to_adjust</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">positions_to_adjust</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformPoints</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">positions_to_adjust</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.check_against_one_packed_ingr"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.check_against_one_packed_ingr">[docs]</a>    <span class="k">def</span> <span class="nf">check_against_one_packed_ingr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">search_tree</span><span class="p">):</span>
        <span class="n">overlapped_ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">positions_of_packed_ingr_spheres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_pos</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rRot</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
            <span class="n">overlapped_ingr</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">level</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># check distances between the spheres at this level in the ingr we are packing</span>
        <span class="c1"># to the spheres at this level in the ingr already placed</span>
        <span class="c1"># return the number of distances for the spheres we are trying to place</span>
        <span class="n">dist_from_packed_spheres_to_new_spheres</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">search_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">positions_of_packed_ingr_spheres</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">level</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="c1"># return index of sph1 closest to pos of packed ingr</span>
        <span class="n">cradii</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">level</span><span class="p">])[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">oradii</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">level</span><span class="p">])</span>
        <span class="n">sumradii</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cradii</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">oradii</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">sD</span> <span class="o">=</span> <span class="n">dist_from_packed_spheres_to_new_spheres</span> <span class="o">-</span> <span class="n">sumradii</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">sD</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Ingredient.np_check_collision"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.np_check_collision">[docs]</a>    <span class="k">def</span> <span class="nf">np_check_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packing_location</span><span class="p">,</span> <span class="n">rotation</span><span class="p">):</span>
        <span class="n">has_collision</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># no ingredients packed yet</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">has_collision</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span>
                <span class="p">)</span>
        <span class="c1"># starting at level 0, check encapsulating radii</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">distances_from_packing_location_to_all_ingr</span><span class="p">,</span>
            <span class="n">ingr_indexes</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">close_ingr_bhtree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">packing_location</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">))</span>
        <span class="n">radii_of_placed_ingr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ing</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="k">for</span> <span class="n">ing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">]</span>
        <span class="p">)[</span><span class="n">ingr_indexes</span><span class="p">]</span>
        <span class="n">overlap_distance</span> <span class="o">=</span> <span class="n">distances_from_packing_location_to_all_ingr</span> <span class="o">-</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">+</span> <span class="n">radii_of_placed_ingr</span>
        <span class="p">)</span>
        <span class="c1"># if overlap_distance is negative, the encapsualting radii are overlapping</span>
        <span class="n">overlap_indexes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">overlap_distance</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_indexes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># single sphere ingr will exit here.</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">total_levels</span><span class="p">:</span>
                <span class="n">has_collision</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># for each packed ingredient that had a collision, we want to check the more</span>
            <span class="c1"># detailed geometry, ie walk down the sphere tree file.</span>
            <span class="k">while</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">total_levels</span><span class="p">:</span>
                <span class="n">pos_of_attempting_ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_pos</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">packing_location</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">search_tree_for_new_ingr</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">pos_of_attempting_ingr</span><span class="p">)</span>
                <span class="n">collision_at_this_level</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># NOTE: At certain lengths of overlap_indices, it might help to remove items from the list</span>
                <span class="c1"># if they dont have a collision at a non max level, but for short arrays, removing indices</span>
                <span class="c1"># takes longer than not checking it.</span>
                <span class="k">for</span> <span class="n">overlap_index</span> <span class="ow">in</span> <span class="n">overlap_indexes</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">ingr_indexes</span><span class="p">[</span><span class="n">overlap_index</span><span class="p">]</span>
                    <span class="n">collision_at_this_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_against_one_packed_ingr</span><span class="p">(</span>
                        <span class="n">index</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">search_tree_for_new_ingr</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">collision_at_this_level</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">collision_at_this_level</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">total_levels</span><span class="p">:</span>
                        <span class="c1"># found collision at lowest level, break all the way out</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">del</span> <span class="n">search_tree_for_new_ingr</span>

        <span class="c1"># the compartment the ingr belongs to</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_ingr_compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NOTE: env.compartments only includes compartments &gt;=1, ie not the</span>
            <span class="c1"># bounding box/comp==0. So need to subtrack 1 from the id of the compartment</span>
            <span class="c1"># to index into this list.</span>
            <span class="n">current_ingr_compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_ingr_compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">compartment</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">distances</span><span class="p">,</span> <span class="n">ingr_indexes</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">OGsrfPtsBht</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">packing_location</span><span class="p">)</span>

            <span class="c1"># NOTE: this could be optimized by walking down the sphere tree representation</span>
            <span class="c1"># of the instead of going right to the bottom</span>
            <span class="k">if</span> <span class="n">distances</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">+</span> <span class="n">compartment</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">:</span>
                <span class="n">pos_of_attempting_ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_pos</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">packing_location</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">total_levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">distances</span><span class="p">,</span> <span class="n">ingr_indexes</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">OGsrfPtsBht</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="n">pos_of_attempting_ingr</span>
                <span class="p">)</span>
                <span class="n">radii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">total_levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">ingr_indexes</span><span class="p">]</span>
                <span class="n">overlap_distance</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
                <span class="n">overlap_indexes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">overlap_distance</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_indexes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">has_collision</span></div>

<div class="viewcode-block" id="Ingredient.checkDistance"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.checkDistance">[docs]</a>    <span class="k">def</span> <span class="nf">checkDistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">liste_nodes</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">liste_nodes</span><span class="p">:</span>
            <span class="n">rTrans</span><span class="p">,</span> <span class="n">rRot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">getRotTransRB</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">measure_distance</span><span class="p">(</span><span class="n">rTrans</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;checkDistance&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.get_rbNodes"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.get_rbNodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_rbNodes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">close_indice</span><span class="p">,</span> <span class="n">currentpt</span><span class="p">,</span> <span class="n">removelast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prevpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">getInfo</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="c1"># move around the rbnode and return it</span>
        <span class="c1"># self.env.loopThroughIngr( self.env.reset_rbnode )</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">organelle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">organelle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#        a=numpy.asarray(self.env.rTrans)[close_indice[&quot;indices&quot;]]</span>
        <span class="c1">#        b=numpy.array([currentpt,])</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">close_indice</span><span class="p">[</span>
            <span class="s2">&quot;distances&quot;</span>
        <span class="p">]</span>  <span class="c1"># spatial.distance.cdist(a,b)#close_indice[&quot;distance&quot;]</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">close_indice</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># if n == len(close_indice[&quot;indices&quot;]):</span>
            <span class="c1">#                continue</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">distances</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">distances</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
                    <span class="o">&gt;</span> <span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">)</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">scaleER</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

            <span class="n">jtrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">rotMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rRot</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">prevpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># if prevpoint == jtrans : continue</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">measure_distance</span><span class="p">(</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jtrans</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prevpoint</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># same point</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># or  (n==(c-2)):</span>
                        <span class="k">continue</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partners</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># or (n==c-2):</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">ingr</span><span class="o">.</span><span class="n">partners</span> <span class="ow">and</span> <span class="n">ingr</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># or (n==c-2):</span>
                    <span class="k">continue</span>
                    <span class="c1">#            if self.packingMode == &#39;hexatile&#39; :</span>
                    <span class="c1">#                #no self collition for testing</span>
                    <span class="c1">#                if self.name == ingr.name :</span>
                    <span class="c1">#                    continue</span>
            <span class="n">rbnode</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">get_rb_model</span><span class="p">(</span><span class="n">alt</span><span class="o">=</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">getInfo</span><span class="p">:</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">rbnode</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">ingr</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbnode</span><span class="p">)</span>
                <span class="c1">#            print &quot;get&quot;,ingr.name,self.name,rbnode,distances[nid],(ingr.encapsulatingRadius+self.encapsulatingRadius)</span>
        <span class="c1"># append organelle rb nodes</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">organelle</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this i notworking for growing ingredient like hair.</span>
                <span class="c1"># should had after second segments</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># whats the current length</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
            <span class="n">orbnode</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get_rb_model</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">orbnode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># test distance to surface ?</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">OGsrfPtsBht</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">currentpt</span><span class="p">])))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">getInfo</span><span class="p">:</span>
                            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orbnode</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">orbnode</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">o</span><span class="p">])</span>
                            <span class="c1">#        if self.compNum &lt; 0 or self.compNum == 0 :</span>
                            <span class="c1">#            for o in self.env.compartments:</span>
                            <span class="c1">#                if o.rbnode is not None :</span>
                            <span class="c1">#                    if not getInfo :</span>
                            <span class="c1">#                        nodes.append(o.rbnode)</span>
                            <span class="c1">#        print (&quot;GetNode &quot;,len(nodes),nodes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="k">return</span> <span class="n">nodes</span></div>

<div class="viewcode-block" id="Ingredient.getClosePairIngredient"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getClosePairIngredient">[docs]</a>    <span class="k">def</span> <span class="nf">getClosePairIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">histoVol</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;indices&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;distances&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="p">]</span>
        <span class="n">radius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">[:]</span>  <span class="c1"># ).tolist()</span>
        <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">bht</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># find all pairs for which the distance is less than 1.1</span>
        <span class="c1"># times the sum of the radii</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">bht</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind</span><span class="p">:</span>
                <span class="n">R</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind</span><span class="p">:</span>
                <span class="n">R</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getClosePairIngredient &quot;</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;all pairs &quot;</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;query was ind &quot;</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="Ingredient.getClosestIngredient"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.getClosestIngredient">[docs]</a>    <span class="k">def</span> <span class="nf">getClosestIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">histoVol</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
        <span class="c1"># may have to rebuild the whale tree every time we add a point</span>
        <span class="c1"># grab the current result</span>
        <span class="c1"># set the bhtree</span>
        <span class="c1"># get closest ClosePoints()</span>
        <span class="c1">#        raw_input()</span>
        <span class="c1">#        return self.getClosePairIngredient(point,histoVol,cutoff=cutoff)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;indices&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;distances&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">histoVol</span><span class="o">.</span><span class="n">totalNbIngr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;treemode </span><span class="si">%s</span><span class="s2">, len rTrans=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">treemode</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">histoVol</span><span class="o">.</span><span class="n">rTrans</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">histoVol</span><span class="o">.</span><span class="n">rTrans</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">R</span>
        <span class="c1"># else:</span>
        <span class="c1">#     if histoVol.treemode == &quot;bhtree&quot;:</span>
        <span class="c1">#         if histoVol.close_ingr_bhtree is None:</span>
        <span class="c1">#             histoVol.close_ingr_bhtree = bhtreelib.BHtree(</span>
        <span class="c1">#                 histoVol.rTrans,</span>
        <span class="c1">#                 [ing.encapsulatingRadius for ing in histoVol.rIngr],</span>
        <span class="c1">#                 10,</span>
        <span class="c1">#             )</span>
        <span class="k">if</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># request kdtree</span>
            <span class="n">nb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;finding partners&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">histoVol</span><span class="o">.</span><span class="n">rTrans</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#                    nb = histoVol.close_ingr_bhtree.query_ball_point(point,cutoff)</span>
                <span class="c1">#                else :#use the general query, how many we want</span>
                <span class="n">distance</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">close_ingr_bhtree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="n">point</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">histoVol</span><span class="o">.</span><span class="n">rTrans</span><span class="p">),</span> <span class="n">distance_upper_bound</span><span class="o">=</span><span class="n">cutoff</span>
                <span class="p">)</span>  <span class="c1"># len of ingr posed so far</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">histoVol</span><span class="o">.</span><span class="n">rTrans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="p">[</span><span class="n">distance</span><span class="p">]</span>
                    <span class="n">nb</span> <span class="o">=</span> <span class="p">[</span><span class="n">nb</span><span class="p">]</span>
                <span class="n">R</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
                <span class="n">R</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span>  <span class="c1"># sorted by distance short -&gt; long</span>
            <span class="k">return</span> <span class="n">R</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">R</span></div>
            <span class="c1">#        closest = histoVol.close_ingr_bhtree.closestPointsArray(tuple(numpy.array([point,])), cutoff, 0)#returnNullIfFail</span>
            <span class="c1">#        print (&quot;getClosestIngredient&quot;,closest,cutoff )</span>
            <span class="c1">#        return closest</span>

<div class="viewcode-block" id="Ingredient.update_data_tree"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.update_data_tree">[docs]</a>    <span class="k">def</span> <span class="nf">update_data_tree</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">ptInd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pt2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">updateTree</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="c1"># self.env.static.append(rbnode)</span>
        <span class="c1"># self.env.moving = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">nb_ingredient</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jtrans</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rRot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rotMatj</span><span class="p">))</span>  <span class="c1"># rotMatj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pt1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pt1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pt2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="p">],</span>
                    <span class="n">rotMatj</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">ptInd</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jtrans</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rotMatj</span><span class="p">),</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">ptInd</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">updateTree</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.remove_from_realtime_display"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.remove_from_realtime_display">[docs]</a>    <span class="k">def</span> <span class="nf">remove_from_realtime_display</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">moving</span><span class="p">):</span>
        <span class="k">pass</span></div>
        <span class="c1"># env.afvi.vi.deleteObject(moving)</span>

<div class="viewcode-block" id="Ingredient.reject"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.reject">[docs]</a>    <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># got rejected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">haveBeenRejected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed ingr:</span><span class="si">%s</span><span class="s2"> rejections:</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rejectionCounter</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rejectionThreshold</span>
        <span class="p">):</span>  <span class="c1"># Graham set this to 6000 for figure 13b (Results Fig 3 Test1) otehrwise it fails to fill small guys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PREMATURE ENDING of ingredient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span></div>

<div class="viewcode-block" id="Ingredient.place"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.place">[docs]</a>    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">,</span>
        <span class="n">compartment</span><span class="p">,</span>
        <span class="n">dropped_position</span><span class="p">,</span>
        <span class="n">dropped_rotation</span><span class="p">,</span>
        <span class="n">grid_point_index</span><span class="p">,</span>
        <span class="n">new_inside_points</span><span class="p">,</span>
        <span class="n">new_dist_values</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbPts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbPts</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_inside_points</span><span class="p">)</span>
        <span class="c1"># self.update_distances(new_inside_points, new_dist_values)</span>
        <span class="n">compartment</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="n">dropped_position</span><span class="p">,</span> <span class="n">dropped_rotation</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">grid_point_index</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="n">grid_point_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">lastrank</span>
        <span class="n">env</span><span class="o">.</span><span class="n">lastrank</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">env</span><span class="o">.</span><span class="n">nb_ingredient</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;tile&quot;</span><span class="p">:</span>
            <span class="n">nexthexa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">dropTile</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">idc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">edge_id</span><span class="p">,</span>
                <span class="n">dropped_position</span><span class="p">,</span>
                <span class="n">dropped_rotation</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;drop next hexa </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nexthexa</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># add one to molecule counter for this ingredient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbMol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_data_tree</span><span class="p">(</span><span class="n">dropped_position</span><span class="p">,</span> <span class="n">dropped_rotation</span><span class="p">,</span> <span class="n">grid_point_index</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ingredient.attempt_to_pack_at_grid_location"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.attempt_to_pack_at_grid_location">[docs]</a>    <span class="k">def</span> <span class="nf">attempt_to_pack_at_grid_location</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">usePP</span>
    <span class="p">):</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxJitter</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>
        <span class="n">dpad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minRadius</span> <span class="o">+</span> <span class="n">max_radius</span> <span class="o">+</span> <span class="n">jitter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vi</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>  <span class="c1"># NOTE: do we need to store the env on the ingredient?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;PLACING INGREDIENT </span><span class="si">%s</span><span class="s2">, placeType=</span><span class="si">%s</span><span class="s2">, index=</span><span class="si">%d</span><span class="s2">, position=</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">placeType</span><span class="p">,</span>
            <span class="n">ptInd</span><span class="p">,</span>
            <span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">ptInd</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compartment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="n">gridPointsCoords</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">masterGridPositions</span>
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rotation</span><span class="p">(</span><span class="n">ptInd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">compartment</span><span class="p">)</span>
        <span class="n">target_grid_point_position</span> <span class="o">=</span> <span class="n">gridPointsCoords</span><span class="p">[</span>
            <span class="n">ptInd</span>
        <span class="p">]</span>  <span class="c1"># drop point, surface points.</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">target_grid_point_position</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_grid_point_position</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">ApplyMatrix</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">],</span> <span class="n">rotation_matrix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">target_grid_point_position</span> <span class="o">=</span> <span class="n">gridPointsCoords</span><span class="p">[</span>
            <span class="n">ptInd</span>
        <span class="p">]</span>  <span class="c1"># drop point, surface points.</span>

        <span class="n">current_visual_instance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">runTimeDisplay</span><span class="p">:</span>
            <span class="n">current_visual_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_real_time_visualization</span><span class="p">(</span>
                <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">target_grid_point_position</span><span class="p">,</span> <span class="n">rotation_matrix</span>
            <span class="p">)</span>
        <span class="n">is_realtime</span> <span class="o">=</span> <span class="n">current_visual_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="c1"># NOTE: move the target point for close partner check.</span>
        <span class="c1"># I think this should be done ealier, when we&#39;re getting the point indice</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">ingrLookForNeighbours</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">==</span> <span class="s2">&quot;closePartner&quot;</span><span class="p">:</span>
            <span class="n">target_grid_point_position</span><span class="p">,</span> <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_partner_check</span><span class="p">(</span>
                <span class="n">target_grid_point_position</span><span class="p">,</span>
                <span class="n">rotation_matrix</span><span class="p">,</span>
                <span class="n">compartment</span><span class="p">,</span>
                <span class="n">env</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span>
                <span class="n">distance</span><span class="p">,</span>
                <span class="n">current_visual_instance</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># grow doesnt use panda.......but could use all the geom produce by the grow as rb</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Actine&quot;</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grow_place</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">freePoints</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">dpad</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeType</span> <span class="o">==</span> <span class="s2">&quot;jitter&quot;</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jitter_place</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span>
                <span class="n">compartment</span><span class="p">,</span>
                <span class="n">target_grid_point_position</span><span class="p">,</span>
                <span class="n">rotation_matrix</span><span class="p">,</span>
                <span class="n">current_visual_instance</span><span class="p">,</span>
                <span class="n">distance</span><span class="p">,</span>
                <span class="n">dpad</span><span class="p">,</span>
                <span class="n">env</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeType</span> <span class="o">==</span> <span class="s2">&quot;spheresSST&quot;</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">success</span><span class="p">,</span>
                <span class="n">jtrans</span><span class="p">,</span>
                <span class="n">rotMatj</span><span class="p">,</span>
                <span class="n">insidePoints</span><span class="p">,</span>
                <span class="n">newDistPoints</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandaBullet_placeBHT</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span>
                <span class="n">compartment</span><span class="p">,</span>
                <span class="n">ptInd</span><span class="p">,</span>
                <span class="n">target_grid_point_position</span><span class="p">,</span>
                <span class="n">rotation_matrix</span><span class="p">,</span>
                <span class="n">current_visual_instance</span><span class="p">,</span>
                <span class="n">distance</span><span class="p">,</span>
                <span class="n">dpad</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeType</span> <span class="o">==</span> <span class="s2">&quot;pandaBullet&quot;</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">success</span><span class="p">,</span>
                <span class="n">jtrans</span><span class="p">,</span>
                <span class="n">rotMatj</span><span class="p">,</span>
                <span class="n">insidePoints</span><span class="p">,</span>
                <span class="n">newDistPoints</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandaBullet_place</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span>
                <span class="n">ptInd</span><span class="p">,</span>
                <span class="n">distance</span><span class="p">,</span>
                <span class="n">dpad</span><span class="p">,</span>
                <span class="n">env</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span>
                <span class="n">compartment</span><span class="p">,</span>
                <span class="n">gridPointsCoords</span><span class="p">,</span>
                <span class="n">rotation_matrix</span><span class="p">,</span>
                <span class="n">target_grid_point_position</span><span class="p">,</span>
                <span class="n">current_visual_instance</span><span class="p">,</span>
                <span class="n">usePP</span><span class="o">=</span><span class="n">usePP</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">placeType</span> <span class="o">==</span> <span class="s2">&quot;pandaBulletRelax&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeType</span> <span class="o">==</span> <span class="s2">&quot;pandaBulletSpring&quot;</span>
        <span class="p">):</span>
            <span class="p">(</span>
                <span class="n">success</span><span class="p">,</span>
                <span class="n">jtrans</span><span class="p">,</span>
                <span class="n">rotMatj</span><span class="p">,</span>
                <span class="n">insidePoints</span><span class="p">,</span>
                <span class="n">newDistPoints</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandaBullet_relax</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span>
                <span class="n">ptInd</span><span class="p">,</span>
                <span class="n">compartment</span><span class="p">,</span>
                <span class="n">target_grid_point_position</span><span class="p">,</span>
                <span class="n">rotation_matrix</span><span class="p">,</span>
                <span class="n">distance</span><span class="p">,</span>
                <span class="n">dpad</span><span class="p">,</span>
                <span class="n">current_visual_instance</span><span class="p">,</span>
                <span class="n">dpad</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t pack using this method </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeType</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">set_object_static</span><span class="p">(</span>
                    <span class="n">current_visual_instance</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">place</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span> <span class="n">compartment</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_from_realtime_display</span><span class="p">(</span><span class="n">current_visual_instance</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span></div>

<div class="viewcode-block" id="Ingredient.get_rotation"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.get_rotation">[docs]</a>    <span class="k">def</span> <span class="nf">get_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt_ind</span><span class="p">,</span> <span class="n">histovol</span><span class="p">,</span> <span class="n">compartment</span><span class="p">):</span>
        <span class="c1"># compute rotation matrix rotMat</span>
        <span class="n">comp_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span>

        <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comp_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># for surface points we compute the rotation which</span>
            <span class="c1"># aligns the principalVector with the surface normal</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">principalVector</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfacePointsNormals</span><span class="p">[</span><span class="n">pt_ind</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rotVectToVect</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PROBLEM &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this is where we could apply biased rotation ie gradient/attractor</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useRotAxis</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotAxis</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">useOrientBias</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">==</span> <span class="s2">&quot;gradient&quot;</span>
                <span class="p">):</span>  <span class="c1"># you need a gradient here</span>
                    <span class="n">rot_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignRotation</span><span class="p">(</span><span class="n">histovol</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">pt_ind</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span>
                        <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotRange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotAxis</span>
                    <span class="p">)</span>
            <span class="c1"># for other points we get a random rotation</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">histovol</span><span class="o">.</span><span class="n">randomRot</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rot_mat</span></div>

<div class="viewcode-block" id="Ingredient.randomize_rotation"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.randomize_rotation">[docs]</a>    <span class="k">def</span> <span class="nf">randomize_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">histovol</span><span class="p">):</span>
        <span class="c1"># randomize rotation about axis</span>
        <span class="n">jitter_rotation</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">jitter_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAxisRotation</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useRotAxis</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotAxis</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">jitter_rotation</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="c1"># Graham Oct 16,2012 Turned on always rotate below as default.  If you want no rotation</span>
                    <span class="c1"># set useRotAxis = 1 and set rotAxis = 0, 0, 0 for that ingredient</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">useOrientBias</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">==</span> <span class="s2">&quot;gradient&quot;</span><span class="p">:</span>
                    <span class="n">jitter_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBiasedRotation</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="c1"># weight = 1.0 - self.env.gradients[self.gradient].weight[ptInd])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># should we align to this rotAxis ?</span>
                    <span class="n">jitter_rotation</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span>
                        <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotRange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotAxis</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">histovol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">jitter_rotation</span> <span class="o">=</span> <span class="n">histovol</span><span class="o">.</span><span class="n">randomRot</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jitter_rotation</span> <span class="o">=</span> <span class="n">rotation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jitter_rotation</span></div>

<div class="viewcode-block" id="Ingredient.randomize_translation"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.randomize_translation">[docs]</a>    <span class="k">def</span> <span class="nf">randomize_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">rotation</span><span class="p">):</span>
        <span class="c1"># jitter points location</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridSpacing</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="n">spacing</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">jitter_sq</span> <span class="o">=</span> <span class="n">jitter</span> <span class="o">*</span> <span class="n">jitter</span>
        <span class="n">jx</span><span class="p">,</span> <span class="n">jy</span><span class="p">,</span> <span class="n">jz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jitterMax</span>
        <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">translation</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="n">jitter_trans</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">jitter_sq</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">jx</span> <span class="o">*</span> <span class="n">jitter</span> <span class="o">*</span> <span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">jy</span> <span class="o">*</span> <span class="n">jitter</span> <span class="o">*</span> <span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">jz</span> <span class="o">*</span> <span class="n">jitter</span> <span class="o">*</span> <span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">dz</span> <span class="o">*</span> <span class="n">dz</span>
                <span class="k">if</span> <span class="n">d2</span> <span class="o">&lt;</span> <span class="n">jitter_sq</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># jitter less among normal</span>
                        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">jitter_trans</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">ty</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">tz</span> <span class="o">+</span> <span class="n">dz</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># else:</span>
                <span class="c1"># self.log.info(&quot;JITTER REJECTED %d %d&quot;, d2, jitter_sq)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jitter_trans</span> <span class="o">=</span> <span class="n">translation</span>
        <span class="k">return</span> <span class="n">jitter_trans</span></div>

<div class="viewcode-block" id="Ingredient.update_display_rt"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.update_display_rt">[docs]</a>    <span class="k">def</span> <span class="nf">update_display_rt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_instance</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">rotation</span><span class="p">):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">rotation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">translation</span>
        <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">move_object</span><span class="p">(</span><span class="n">current_instance</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>

        <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="Ingredient.rigid_place"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.rigid_place">[docs]</a>    <span class="k">def</span> <span class="nf">rigid_place</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">histoVol</span><span class="p">,</span>
        <span class="n">ptInd</span><span class="p">,</span>
        <span class="n">compartment</span><span class="p">,</span>
        <span class="n">target_grid_point_position</span><span class="p">,</span>
        <span class="n">rotation_matrix</span><span class="p">,</span>
        <span class="n">nbFreePoints</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">,</span>
        <span class="n">dpad</span><span class="p">,</span>
        <span class="n">moving</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        drop the ingredient on grid point ptInd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print &quot;rigid&quot;,self.placeType</span>
        <span class="n">afvi</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">afviewer</span>
        <span class="n">simulationTimes</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">simulationTimes</span>
        <span class="n">runTimeDisplay</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">runTimeDisplay</span>
        <span class="n">springOptions</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">springOptions</span>
        <span class="n">is_realtime</span> <span class="o">=</span> <span class="n">moving</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oneJitter</span><span class="p">(</span>
            <span class="n">histoVol</span><span class="p">,</span> <span class="n">target_grid_point_position</span><span class="p">,</span> <span class="n">rotation_matrix</span>
        <span class="p">)</span>

        <span class="c1"># here should go the simulation</span>
        <span class="c1"># 1- we build the ingredient if not already and place the ingredient at jtrans, rotMatj</span>
        <span class="n">moving</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">static</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">jtrans</span>
        <span class="c1">#        import c4d</span>
        <span class="c1"># c4d.documents.RunAnimation(c4d.documents.GetActiveDocument(), True)</span>

        <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">)</span>
        <span class="c1"># 2- get the neighboring object from ptInd</span>
        <span class="n">mingrs</span><span class="p">,</span> <span class="n">listePartner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getListePartners</span><span class="p">(</span>
            <span class="n">histoVol</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">compartment</span><span class="p">,</span> <span class="n">afvi</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mingrs</span><span class="p">):</span>
            <span class="n">ing</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1"># print &quot;neighbour&quot;,ing.name</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ing</span><span class="p">,</span> <span class="s2">&quot;mesh_3d&quot;</span><span class="p">):</span>
                <span class="c1"># create an instance of mesh3d and place it</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">ing</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ing</span><span class="o">.</span><span class="n">mesh_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ipoly</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">Sphere</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">afvi</span><span class="o">.</span><span class="n">staticMesh</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ipoly</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ipoly</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span>
                        <span class="n">ing</span><span class="o">.</span><span class="n">mesh_3d</span><span class="p">,</span>
                        <span class="n">matrice</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>  <span class="c1"># .GetDown()</span>
                        <span class="n">location</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                        <span class="n">parent</span><span class="o">=</span><span class="n">afvi</span><span class="o">.</span><span class="n">staticMesh</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">static</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ipoly</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ing</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">ing</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="n">ipoly</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">afvi</span><span class="o">.</span><span class="n">orgaToMasterGeom</span><span class="p">[</span><span class="n">ing</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">afvi</span><span class="o">.</span><span class="n">staticMesh</span>
                <span class="p">)</span>
                <span class="n">static</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ipoly</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">listePartner</span><span class="p">:</span>  <span class="c1"># self.packingMode==&quot;closePartner&quot;:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len listePartner = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">listePartner</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_random</span><span class="p">:</span>
                <span class="n">targetPoint</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickPartner</span><span class="p">(</span>
                    <span class="n">mingrs</span><span class="p">,</span> <span class="n">listePartner</span><span class="p">,</span> <span class="n">currentPos</span><span class="o">=</span><span class="n">jtrans</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">targetPoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">jtrans</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">jtrans</span>
        <span class="c1"># setup the target position</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeType</span> <span class="o">==</span> <span class="s2">&quot;spring&quot;</span><span class="p">:</span>
            <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">setRigidBody</span><span class="p">(</span><span class="n">afvi</span><span class="o">.</span><span class="n">movingMesh</span><span class="p">,</span> <span class="o">**</span><span class="n">histoVol</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">])</span>
            <span class="c1"># target can be partner position?</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;target&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">Sphere</span><span class="p">(</span><span class="s2">&quot;target&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">targetPoint</span><span class="p">)</span>
            <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">addObjectToScene</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="c1"># 3- we setup the spring (using the sphere position empty)</span>
            <span class="n">spring</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;afspring&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spring</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spring</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">createSpring</span><span class="p">(</span>
                    <span class="s2">&quot;afspring&quot;</span><span class="p">,</span> <span class="n">targetA</span><span class="o">=</span><span class="n">moving</span><span class="p">,</span> <span class="n">tragetB</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">springOptions</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">updateSpring</span><span class="p">(</span>
                    <span class="n">spring</span><span class="p">,</span> <span class="n">targetA</span><span class="o">=</span><span class="n">moving</span><span class="p">,</span> <span class="n">tragetB</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">springOptions</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># before assigning should get outside thge object</span>
            <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">setRigidBody</span><span class="p">(</span><span class="n">afvi</span><span class="o">.</span><span class="n">movingMesh</span><span class="p">,</span> <span class="o">**</span><span class="n">histoVol</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">])</span>
            <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">targetPoint</span><span class="p">)</span>
        <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">setRigidBody</span><span class="p">(</span><span class="n">afvi</span><span class="o">.</span><span class="n">staticMesh</span><span class="p">,</span> <span class="o">**</span><span class="n">histoVol</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">])</span>
        <span class="c1"># 4- we run the simulation</span>
        <span class="c1"># c4d.documents.RunAnimation(c4d.documents.GetActiveDocument(), False,True)</span>
        <span class="c1"># if runTimeDisplay :</span>
        <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="c1">#        rTrans = afvi.vi.ToVec(afvi.vi.getTranslation(moving))</span>
        <span class="c1">#        rRot = afvi.vi.getMatRotation(moving)</span>

        <span class="c1"># print afvi.vi.ToVec(moving.GetAllPoints()[0])</span>
        <span class="c1"># afvi.vi.animationStart(duration = simulationTimes)</span>
        <span class="c1"># afvi.vi.update()</span>
        <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">frameAdvanced</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">simulationTimes</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">runTimeDisplay</span><span class="p">)</span>  <span class="c1"># ,</span>
        <span class="c1"># 5- we get the resuling transofrmation matrix and decompose -&gt;rTrans rRot</span>
        <span class="c1"># if runTimeDisplay :</span>
        <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">rTrans</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">ToVec</span><span class="p">(</span><span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">(</span><span class="n">moving</span><span class="p">))</span>
        <span class="n">rRot</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">getMatRotation</span><span class="p">(</span><span class="n">moving</span><span class="p">)</span>
        <span class="c1">#        M=moving.GetMg()</span>
        <span class="c1"># print afvi.vi.ToVec(moving.GetAllPoints()[0])</span>

        <span class="c1"># 6- clean and delete everything except the spring</span>
        <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">deleteObject</span><span class="p">(</span><span class="n">moving</span><span class="p">)</span>
        <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">deleteObject</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">static</span><span class="p">:</span>
            <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">deleteObject</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">jtrans</span> <span class="o">=</span> <span class="n">rTrans</span><span class="p">[:]</span>
        <span class="n">rotMatj</span> <span class="o">=</span> <span class="n">rRot</span><span class="p">[:]</span>
        <span class="n">centT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformPoints</span><span class="p">(</span><span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">insidePoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">newDistPoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_distance_values</span><span class="p">(</span>
            <span class="n">histoVol</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">histoVol</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">,</span>
            <span class="n">dpad</span><span class="p">,</span>
            <span class="n">distance</span><span class="p">,</span>
            <span class="n">centT</span><span class="p">,</span>
            <span class="n">jtrans</span><span class="p">,</span>
            <span class="n">rotMatj</span><span class="p">,</span>
            <span class="n">dpad</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># save dropped ingredient</span>

        <span class="n">histoVol</span><span class="o">.</span><span class="n">rTrans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jtrans</span><span class="p">)</span>
        <span class="n">histoVol</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>
        <span class="n">histoVol</span><span class="o">.</span><span class="n">rRot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotMatj</span><span class="p">)</span>
        <span class="n">histoVol</span><span class="o">.</span><span class="n">rIngr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rRot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotMatj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tTrans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jtrans</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Success nbfp:</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> dpad </span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nbFreePoints</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nbMol</span><span class="p">,</span>
            <span class="n">dpad</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span></div>

<div class="viewcode-block" id="Ingredient.merge_place_results"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.merge_place_results">[docs]</a>    <span class="k">def</span> <span class="nf">merge_place_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_results</span><span class="p">,</span> <span class="n">accum_results</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">new_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">accum_results</span><span class="p">:</span>
                <span class="n">accum_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">accum_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># newly inside point</span>
                    <span class="n">accum_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">new_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">accum_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># was already inside, get closet distance</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">new_results</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">accum_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]):</span>
                        <span class="n">accum_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">accum_results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">accum_results</span><span class="p">[</span><span class="n">pt</span><span class="p">],</span> <span class="n">new_results</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">accum_results</span></div>

<div class="viewcode-block" id="Ingredient.get_all_positions_to_check"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.get_all_positions_to_check">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_positions_to_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packing_location</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a starting position in the packing space, and returns all the points that</span>
<span class="sd">        need to be tested for a collision as an array.</span>

<span class="sd">            If the point isn&#39;t close to an edge, will return just the staring point.</span>
<span class="sd">            If the point is close to the side of the bounding box, will return an array of 2.</span>
<span class="sd">            If the point is close to an edge of the bb (which is a &quot;corner&quot; in 2D), will return an array of 3.</span>
<span class="sd">            If the point is close to a corner in 3D will return an array of 8.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">points_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">packing_location</span><span class="p">]</span>
        <span class="c1"># periodicity check</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span> <span class="o">!=</span> <span class="s2">&quot;graident&quot;</span><span class="p">:</span>
            <span class="n">periodic_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getPositionPeridocity</span><span class="p">(</span>
                <span class="n">packing_location</span><span class="p">,</span>
                <span class="n">getNormedVectorOnes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jitterMax</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">points_to_check</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">periodic_pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">points_to_check</span></div>

<div class="viewcode-block" id="Ingredient.jitter_place"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.jitter_place">[docs]</a>    <span class="k">def</span> <span class="nf">jitter_place</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">,</span>
        <span class="n">compartment</span><span class="p">,</span>
        <span class="n">targeted_master_grid_point</span><span class="p">,</span>
        <span class="n">rot_mat</span><span class="p">,</span>
        <span class="n">moving</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">,</span>
        <span class="n">dpad</span><span class="p">,</span>
        <span class="n">afvi</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the given grid point is available for packing using the jitter collision detection</span>
<span class="sd">        method. Returns packing location and new grid point values if packing is successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">packing_location</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">is_realtime</span> <span class="o">=</span> <span class="n">moving</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collisionLevel</span>
        <span class="k">for</span> <span class="n">attempt_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbJitter</span><span class="p">):</span>
            <span class="n">insidePoints</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">newDistPoints</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="p">(</span>
                <span class="n">packing_location</span><span class="p">,</span>
                <span class="n">packing_rotation</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_jitter_location_and_rotation</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span> <span class="n">targeted_master_grid_point</span><span class="p">,</span> <span class="n">rot_mat</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Jitter attempt </span><span class="si">{</span><span class="n">attempt_number</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">packing_location</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">packing_location</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_is_not_available</span><span class="p">(</span><span class="n">packing_location</span><span class="p">):</span>
                <span class="c1"># jittered out of container or too close to boundary</span>
                <span class="c1"># check next random jitter</span>
                <span class="k">continue</span>

            <span class="n">collision_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">points_to_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_positions_to_check</span><span class="p">(</span><span class="n">packing_location</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">points_to_check</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="n">collision</span><span class="p">,</span>
                    <span class="n">new_inside_points</span><span class="p">,</span>
                    <span class="n">new_dist_points</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collision_jitter</span><span class="p">(</span>
                    <span class="n">pt</span><span class="p">,</span>
                    <span class="n">packing_rotation</span><span class="p">,</span>
                    <span class="n">level</span><span class="p">,</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">,</span>
                    <span class="n">distance</span><span class="p">,</span>
                    <span class="n">env</span><span class="p">,</span>
                    <span class="n">dpad</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">collision_results</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">collision</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;collBox&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">changeObjColorMat</span><span class="p">(</span>
                        <span class="n">box</span><span class="p">,</span>
                        <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">collision_results</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">collision</span><span class="p">:</span>
                    <span class="c1"># found a collision, break this loop</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">insidePoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_place_results</span><span class="p">(</span>
                        <span class="n">new_inside_points</span><span class="p">,</span> <span class="n">insidePoints</span>
                    <span class="p">)</span>
                    <span class="n">newDistPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_place_results</span><span class="p">(</span>
                        <span class="n">new_dist_points</span><span class="p">,</span> <span class="n">newDistPoints</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;collBox&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">changeObjColorMat</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">collision</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collision_results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;no collision, new points </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">insidePoints</span><span class="p">),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">newDistPoints</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="kc">True</span><span class="p">,</span>
                    <span class="n">packing_location</span><span class="p">,</span>
                    <span class="n">packing_rotation</span><span class="p">,</span>
                    <span class="n">insidePoints</span><span class="p">,</span>
                    <span class="n">newDistPoints</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">packing_location</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Ingredient.lookForNeighbours"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.lookForNeighbours">[docs]</a>    <span class="k">def</span> <span class="nf">lookForNeighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">organelle</span><span class="p">,</span> <span class="n">afvi</span><span class="p">,</span> <span class="n">closest_indice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">mingrs</span><span class="p">,</span> <span class="n">listePartner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getListePartners</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">organelle</span><span class="p">,</span> <span class="n">afvi</span><span class="p">,</span> <span class="n">close_indice</span><span class="o">=</span><span class="n">closest_indice</span>
        <span class="p">)</span>
        <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">trans</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">listePartner</span><span class="p">:</span>  <span class="c1"># self.packingMode==&quot;closePartner&quot;:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;partner found&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_random</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">jitterPos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbJitter</span><span class="p">):</span>  <span class="c1">#</span>
                    <span class="n">targetPoint</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickPartner</span><span class="p">(</span>
                        <span class="n">mingrs</span><span class="p">,</span> <span class="n">listePartner</span><span class="p">,</span> <span class="n">currentPos</span><span class="o">=</span><span class="n">trans</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">targetPoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># print &quot;found &quot;,jitterPos</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">targetPoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">trans</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># maybe get the ptid that can have it</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># surface</span>
                        <span class="n">d</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">organelle</span><span class="o">.</span><span class="n">OGsrfPtsBht</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">targetPoint</span><span class="p">)</span>
                        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">principalVector</span>
                        <span class="c1"># surfacePointsNormals problem here</span>
                        <span class="n">v2</span> <span class="o">=</span> <span class="n">organelle</span><span class="o">.</span><span class="n">ogsurfacePointsNormals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">rotMat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rotVectToVect</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PROBLEM </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                            <span class="n">rotMat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="c1"># find a newpoint here?</span>
                    <span class="k">return</span> <span class="n">targetPoint</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">found</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">trans</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no partner found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">targetPoint</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">found</span></div>

<div class="viewcode-block" id="Ingredient.pandaBullet_collision"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.pandaBullet_collision">[docs]</a>    <span class="k">def</span> <span class="nf">pandaBullet_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">rbnode</span><span class="p">,</span> <span class="n">getnodes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">collision</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">liste_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">closesbody_indice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClosestIngredient</span><span class="p">(</span>
                <span class="n">pos</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">largestProteinSize</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingRadius</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># vself.radii[0][0]*2.0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">closesbody_indice</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get RB </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">closesbody_indice</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">rbnode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rbnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rb_model</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">moveRBnode</span><span class="p">(</span><span class="n">rbnode</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get RB for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">liste_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rbNodes</span><span class="p">(</span><span class="n">closesbody_indice</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">getInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;test collision against  </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">liste_nodes</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">liste_nodes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;collision test with </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">moveRBnode</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># Pb here ?</span>
                    <span class="n">collision</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">contactTestPair</span><span class="p">(</span><span class="n">rbnode</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">getNumContacts</span><span class="p">()</span>
                        <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">collision</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="n">getnodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">collision</span><span class="p">,</span> <span class="n">liste_nodes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">collision</span></div>

<div class="viewcode-block" id="Ingredient.get_compartment"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.get_compartment">[docs]</a>    <span class="k">def</span> <span class="nf">get_compartment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">env</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="Ingredient.close_partner_check"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.close_partner_check">[docs]</a>    <span class="k">def</span> <span class="nf">close_partner_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">compartment</span><span class="p">,</span> <span class="n">afvi</span><span class="p">,</span> <span class="n">moving</span><span class="p">):</span>
        <span class="n">bind</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;look for ingredient </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
        <span class="c1"># roll a dice about proba_not_binding</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proba_not_binding</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># between 0 and 1</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proba_not_binding</span><span class="p">:</span>
                <span class="n">bind</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">bind</span><span class="p">:</span>
            <span class="n">closesbody_indice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClosestIngredient</span><span class="p">(</span>
                <span class="n">translation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">diag</span>
            <span class="p">)</span>  <span class="c1"># vself.radii[0][0]*2.0</span>
            <span class="n">target_point</span><span class="p">,</span> <span class="n">rot_matrix</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookForNeighbours</span><span class="p">(</span>
                <span class="n">translation</span><span class="p">,</span>
                <span class="n">rotation</span><span class="p">,</span>
                <span class="n">compartment</span><span class="p">,</span>
                <span class="n">afvi</span><span class="p">,</span>
                <span class="n">closest_indice</span><span class="o">=</span><span class="n">closesbody_indice</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">translation</span><span class="p">,</span> <span class="n">rotation</span>

            <span class="c1"># if partner:pickNewPoit like in fill3</span>
            <span class="k">if</span> <span class="n">moving</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">target_point</span><span class="p">,</span> <span class="n">rot_matrix</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">target_point</span><span class="p">,</span> <span class="n">rot_matrix</span></div>

<div class="viewcode-block" id="Ingredient.handle_real_time_visualization"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.handle_real_time_visualization">[docs]</a>    <span class="k">def</span> <span class="nf">handle_real_time_visualization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">helper</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">target_point</span><span class="p">,</span> <span class="n">rot_mat</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">instance_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ptInd</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># copy of the ingredient being packed</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># parent object of all the instances</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">helper</span><span class="o">.</span><span class="n">add_object_to_scene</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">target_point</span><span class="p">,</span> <span class="n">rot_mat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">helper</span><span class="o">.</span><span class="n">add_new_instance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">target_point</span><span class="p">,</span> <span class="n">rot_mat</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">instance_id</span></div>

<div class="viewcode-block" id="Ingredient.pandaBullet_place"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.pandaBullet_place">[docs]</a>    <span class="k">def</span> <span class="nf">pandaBullet_place</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">histoVol</span><span class="p">,</span>
        <span class="n">ptInd</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">,</span>
        <span class="n">dpad</span><span class="p">,</span>
        <span class="n">afvi</span><span class="p">,</span>
        <span class="n">compartment</span><span class="p">,</span>
        <span class="n">gridPointsCoords</span><span class="p">,</span>
        <span class="n">rot_matrix</span><span class="p">,</span>
        <span class="n">target_point</span><span class="p">,</span>
        <span class="n">moving</span><span class="p">,</span>
        <span class="n">usePP</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        drop the ingredient on grid point ptInd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">histoVol</span><span class="o">.</span><span class="n">setupPanda</span><span class="p">()</span>
        <span class="n">is_realtime</span> <span class="o">=</span> <span class="n">moving</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="c1"># we need to change here in case tilling, the pos,rot ade deduced fromte tilling.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;tile&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setTilling</span><span class="p">(</span><span class="n">compartment</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># pick the next Hexa pos/rot.</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">collision_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">getNextHexaPosRot</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">rot_matrix</span> <span class="o">=</span> <span class="n">collision_results</span>
                    <span class="n">trans</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="n">target_point</span> <span class="o">=</span> <span class="n">trans</span>
                    <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">target_point</span><span class="p">,</span> <span class="n">rot_matrix</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span>  <span class="c1"># ,targetPoint, rotMat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">init_seed</span><span class="p">(</span><span class="n">histoVol</span><span class="o">.</span><span class="n">seed_used</span><span class="p">)</span>

        <span class="n">packing_location</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collisionLevel</span>

        <span class="k">for</span> <span class="n">jitter_attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbJitter</span><span class="p">):</span>
            <span class="n">histoVol</span><span class="o">.</span><span class="n">totnbJitter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="p">(</span>
                <span class="n">packing_location</span><span class="p">,</span>
                <span class="n">packing_rotation</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_jitter_location_and_rotation</span><span class="p">(</span>
                <span class="n">histoVol</span><span class="p">,</span>
                <span class="n">target_point</span><span class="p">,</span>
                <span class="n">rot_matrix</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">target_point</span><span class="p">,</span> <span class="n">rot_matrix</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_is_not_available</span><span class="p">(</span><span class="n">packing_location</span><span class="p">):</span>
                <span class="c1"># jittered into wrong compartment,</span>
                <span class="c1"># go to next jitter</span>
                <span class="k">continue</span>

            <span class="n">collision_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rbnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rb_model</span><span class="p">()</span>

            <span class="n">points_to_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_positions_to_check</span><span class="p">(</span>
                <span class="n">packing_location</span>
            <span class="p">)</span>  <span class="c1"># includes periodic points, if appropriate</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">points_to_check</span><span class="p">:</span>
                <span class="n">histoVol</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
                    <span class="n">histoVol</span><span class="o">.</span><span class="n">moveRBnode</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="n">rbnode</span><span class="p">,</span>
                        <span class="n">pt</span><span class="p">,</span>
                        <span class="n">packing_rotation</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">collision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandaBullet_collision</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">,</span> <span class="n">rbnode</span><span class="p">)</span>
                <span class="n">collision_results</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">collision</span><span class="p">])</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">collision_results</span><span class="p">:</span>
                    <span class="c1"># break out of point check loop, not this jitter loop</span>
                    <span class="k">break</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="c1"># checked packing location and periodic positions</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">collision_results</span><span class="p">:</span>
                <span class="c1"># found a collision, should check next jitter</span>
                <span class="k">continue</span>

            <span class="c1"># need to check compartment too</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no additional collisions, checking compartment&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartment</span><span class="p">:</span>

                <span class="n">collisionComp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartmentPrimitive</span><span class="p">(</span>
                    <span class="n">level</span><span class="p">,</span>
                    <span class="n">packing_location</span><span class="p">,</span>
                    <span class="n">packing_rotation</span><span class="p">,</span>
                    <span class="n">gridPointsCoords</span><span class="p">,</span>
                    <span class="n">distance</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">collision_results</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">collisionComp</span><span class="p">])</span>

            <span class="c1"># got all the way through the checks with no collision</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collision_results</span><span class="p">:</span>
                <span class="n">insidePoints</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">newDistPoints</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

                <span class="c1"># self.update_data_tree(jtrans,rotMatj,ptInd=ptInd)?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbnode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">moving</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">points_to_check</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rRot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packing_rotation</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>

                    <span class="n">new_inside_pts</span><span class="p">,</span> <span class="n">new_dist_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_distance_values</span><span class="p">(</span>
                        <span class="n">pt</span><span class="p">,</span>
                        <span class="n">packing_rotation</span><span class="p">,</span>
                        <span class="n">gridPointsCoords</span><span class="p">,</span>
                        <span class="n">distance</span><span class="p">,</span>
                        <span class="n">dpad</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">deepest_level</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">insidePoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_place_results</span><span class="p">(</span>
                        <span class="n">new_inside_pts</span><span class="p">,</span> <span class="n">insidePoints</span>
                    <span class="p">)</span>
                    <span class="n">newDistPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_place_results</span><span class="p">(</span>
                        <span class="n">new_dist_points</span><span class="p">,</span> <span class="n">newDistPoints</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;compute distance loop </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t3</span><span class="p">)</span>

                <span class="c1"># rebuild kdtree</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;tile&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">dropTile</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">idc</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">edge_id</span><span class="p">,</span>
                        <span class="n">packing_location</span><span class="p">,</span>
                        <span class="n">packing_rotation</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">success</span><span class="p">,</span>
                    <span class="n">packing_location</span><span class="p">,</span>
                    <span class="n">packing_rotation</span><span class="p">,</span>
                    <span class="n">insidePoints</span><span class="p">,</span>
                    <span class="n">newDistPoints</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># never found a place to pack</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;tile&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">nvisit</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">free_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Ingredient.pandaBullet_placeBHT"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.pandaBullet_placeBHT">[docs]</a>    <span class="k">def</span> <span class="nf">pandaBullet_placeBHT</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">histoVol</span><span class="p">,</span>
        <span class="n">compartment</span><span class="p">,</span>
        <span class="n">ptInd</span><span class="p">,</span>
        <span class="n">target_grid_point_position</span><span class="p">,</span>
        <span class="n">rotation_matrix</span><span class="p">,</span>
        <span class="n">moving</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">,</span>
        <span class="n">dpad</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        drop the ingredient on grid point ptInd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">histoVol</span><span class="o">.</span><span class="n">setupPanda</span><span class="p">()</span>
        <span class="n">is_realtime</span> <span class="o">=</span> <span class="n">moving</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">gridPointsCoords</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">masterGridPositions</span>

        <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">target_grid_point_position</span>

        <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">targetPoint</span><span class="p">,</span> <span class="n">rotation_matrix</span><span class="p">)</span>

        <span class="c1"># do we get the list of neighbours first &gt; and give a different trans...closer to the partner</span>
        <span class="c1"># we should look up for an available ptID around the picked partner if any</span>
        <span class="c1"># getListCloseIngredient</span>
        <span class="c1"># should se a distance_of_influence ? or self.env.largestProteinSize+self.encapsulatingRadius*2.0</span>
        <span class="c1"># or the grid diagonal</span>
        <span class="c1"># we need to change here in case tilling, the pos,rot ade deduced fromte tilling.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packingMode</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;tile&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setTilling</span><span class="p">(</span><span class="n">compartment</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># pick the next Hexa pos/rot.</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">collision_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">getNextHexaPosRot</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">collision_results</span>
                    <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">targetPoint</span><span class="p">,</span> <span class="n">rotation_matrix</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tilling</span><span class="o">.</span><span class="n">init_seed</span><span class="p">(</span><span class="n">histoVol</span><span class="o">.</span><span class="n">seed_used</span><span class="p">)</span>
        <span class="c1"># we may increase the jitter, or pick from xyz-&gt;Id free for its radius</span>
        <span class="c1"># create the rb only once and not at ever jitter</span>
        <span class="c1"># rbnode = histoVol.callFunction(self.env.addRB,(self, jtrans, rotMat,),{&quot;rtype&quot;:self.Type},)</span>
        <span class="c1"># jitter loop</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collisionLevel</span>

        <span class="k">for</span> <span class="n">attempt_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbJitter</span><span class="p">):</span>
            <span class="n">insidePoints</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">newDistPoints</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">histoVol</span><span class="o">.</span><span class="n">totnbJitter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="p">(</span>
                <span class="n">packing_location</span><span class="p">,</span>
                <span class="n">packing_rotation</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_jitter_location_and_rotation</span><span class="p">(</span>
                <span class="n">histoVol</span><span class="p">,</span>
                <span class="n">targetPoint</span><span class="p">,</span>
                <span class="n">rotation_matrix</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">packing_location</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">)</span>

            <span class="n">collision_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rbnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rb_model</span><span class="p">()</span>
            <span class="n">pts_to_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_positions_to_check</span><span class="p">(</span><span class="n">packing_location</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts_to_check</span><span class="p">:</span>
                <span class="n">collision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_check_collision</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">)</span>
                <span class="n">collision_results</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">collision</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_display_rt</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">packing_location</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">collision</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_is_not_available</span><span class="p">(</span><span class="n">packing_location</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">collision_results</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># need to check compartment too</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no collision&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartment</span><span class="p">:</span>
                <span class="n">collision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareCompartmentPrimitive</span><span class="p">(</span>
                    <span class="n">level</span><span class="p">,</span>
                    <span class="n">packing_location</span><span class="p">,</span>
                    <span class="n">packing_rotation</span><span class="p">,</span>
                    <span class="n">gridPointsCoords</span><span class="p">,</span>
                    <span class="n">distance</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">collision_results</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">collision</span><span class="p">])</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collision_results</span><span class="p">:</span>
                <span class="c1"># self.update_data_tree(jtrans,rotMatj,ptInd=ptInd)?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbnode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">moving</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts_to_check</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rRot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packing_rotation</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rIngr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>
                    <span class="n">new_inside_pts</span><span class="p">,</span> <span class="n">new_dist_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_distance_values</span><span class="p">(</span>
                        <span class="n">pt</span><span class="p">,</span>
                        <span class="n">packing_rotation</span><span class="p">,</span>
                        <span class="n">gridPointsCoords</span><span class="p">,</span>
                        <span class="n">distance</span><span class="p">,</span>
                        <span class="n">dpad</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">deepest_level</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">insidePoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_place_results</span><span class="p">(</span>
                        <span class="n">new_inside_pts</span><span class="p">,</span> <span class="n">insidePoints</span>
                    <span class="p">)</span>
                    <span class="n">newDistPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_place_results</span><span class="p">(</span>
                        <span class="n">new_dist_points</span><span class="p">,</span> <span class="n">newDistPoints</span>
                    <span class="p">)</span>
                <span class="c1"># rebuild kdtree</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">close_ingr_bhtree</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rTrans</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span>
                    <span class="p">)</span>

                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">success</span><span class="p">,</span>
                    <span class="n">packing_location</span><span class="p">,</span>
                    <span class="n">packing_rotation</span><span class="p">,</span>
                    <span class="n">insidePoints</span><span class="p">,</span>
                    <span class="n">newDistPoints</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">packing_location</span><span class="p">,</span> <span class="n">packing_rotation</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span></div>

<div class="viewcode-block" id="Ingredient.pandaBullet_relax"><a class="viewcode-back" href="../../../../cellpack.autopack.ingredient.html#cellpack.autopack.ingredient.Ingredient.Ingredient.pandaBullet_relax">[docs]</a>    <span class="k">def</span> <span class="nf">pandaBullet_relax</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">histoVol</span><span class="p">,</span>
        <span class="n">ptInd</span><span class="p">,</span>
        <span class="n">compartment</span><span class="p">,</span>
        <span class="n">target_grid_point_position</span><span class="p">,</span>
        <span class="n">rotation_matrix</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">,</span>
        <span class="n">dpad</span><span class="p">,</span>
        <span class="n">moving</span><span class="p">,</span>
        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        drop the ingredient on grid point ptInd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">histoVol</span><span class="o">.</span><span class="n">setupPanda</span><span class="p">()</span>
        <span class="n">afvi</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">afviewer</span>
        <span class="n">simulationTimes</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">simulationTimes</span>
        <span class="n">runTimeDisplay</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">runTimeDisplay</span>
        <span class="n">is_realtime</span> <span class="o">=</span> <span class="n">moving</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">gridPointsCoords</span> <span class="o">=</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span>
        <span class="n">insidePoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">newDistPoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oneJitter</span><span class="p">(</span>
            <span class="n">histoVol</span><span class="p">,</span> <span class="n">target_grid_point_position</span><span class="p">,</span> <span class="n">rotation_matrix</span>
        <span class="p">)</span>
        <span class="c1"># here should go the simulation</span>
        <span class="c1"># 1- we build the ingredient if not already and place the ingredient at jtrans, rotMatj</span>
        <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">jtrans</span>
        <span class="k">if</span> <span class="n">is_realtime</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mesh_3d&quot;</span><span class="p">):</span>
                <span class="c1"># create an instance of mesh3d and place it</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptInd</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">moving_geom</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">Sphere</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">afvi</span><span class="o">.</span><span class="n">movingMesh</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_geom</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">jtrans</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">moving_geom</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_3d</span><span class="p">,</span>
                        <span class="n">matrice</span><span class="o">=</span><span class="n">rotMatj</span><span class="p">,</span>
                        <span class="n">location</span><span class="o">=</span><span class="n">jtrans</span><span class="p">,</span>
                        <span class="n">parent</span><span class="o">=</span><span class="n">afvi</span><span class="o">.</span><span class="n">movingMesh</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="c1"># 2- get the neighboring object from ptInd</span>
        <span class="k">if</span> <span class="n">histoVol</span><span class="o">.</span><span class="n">ingrLookForNeighbours</span><span class="p">:</span>
            <span class="n">mingrs</span><span class="p">,</span> <span class="n">listePartner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getListePartners</span><span class="p">(</span>
                <span class="n">histoVol</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">compartment</span><span class="p">,</span> <span class="n">afvi</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mingrs</span><span class="p">):</span>
                <span class="n">ing</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="c1"># print &quot;neighbour&quot;,ing.name</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ing</span><span class="p">,</span> <span class="s2">&quot;mesh_3d&quot;</span><span class="p">):</span>
                    <span class="c1"># create an instance of mesh3d and place it</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">ing</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ing</span><span class="o">.</span><span class="n">mesh_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ipoly</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">Sphere</span><span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">afvi</span><span class="o">.</span><span class="n">staticMesh</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ipoly</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ipoly</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span>
                            <span class="n">ing</span><span class="o">.</span><span class="n">mesh_3d</span><span class="p">,</span>
                            <span class="n">matrice</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
                            <span class="n">location</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                            <span class="n">parent</span><span class="o">=</span><span class="n">afvi</span><span class="o">.</span><span class="n">staticMesh</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">ing</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">ing</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                    <span class="n">ipoly</span> <span class="o">=</span> <span class="n">afvi</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">afvi</span><span class="o">.</span><span class="n">orgaToMasterGeom</span><span class="p">[</span><span class="n">ing</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">afvi</span><span class="o">.</span><span class="n">staticMesh</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">listePartner</span><span class="p">:</span>  <span class="c1"># self.packingMode==&quot;closePartner&quot;:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len listePartner = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">listePartner</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_random</span><span class="p">:</span>
                    <span class="n">targetPoint</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickPartner</span><span class="p">(</span>
                        <span class="n">mingrs</span><span class="p">,</span> <span class="n">listePartner</span><span class="p">,</span> <span class="n">currentPos</span><span class="o">=</span><span class="n">jtrans</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">targetPoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">jtrans</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">targetPoint</span> <span class="o">=</span> <span class="n">jtrans</span>
                    <span class="c1">#        print &quot;targetPt&quot;,len(targetPoint),targetPoint</span>
                    <span class="c1">#       should be panda util</span>
                    <span class="c1">#        add the rigid body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">moving</span> <span class="o">=</span> <span class="n">rbnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">addRB</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">jtrans</span><span class="p">,</span>
                <span class="n">rotation_matrix</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">{</span><span class="s2">&quot;rtype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">moveRBnode</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">rbnode</span><span class="p">,</span>
                <span class="n">jtrans</span><span class="p">,</span>
                <span class="n">rotMatj</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># run he simulation for simulationTimes</span>
        <span class="n">histoVol</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">runBullet</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">simulationTimes</span><span class="p">,</span>
                <span class="n">runTimeDisplay</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># cb=self.getTransfo)</span>
        <span class="n">rTrans</span><span class="p">,</span> <span class="n">rRot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">getRotTransRB</span><span class="p">(</span><span class="n">rbnode</span><span class="p">)</span>
        <span class="c1"># 5- we get the resuling transofrmation matrix and decompose -&gt;rTrans rRot</span>
        <span class="c1"># use</span>
        <span class="c1"># r=[ (self.env.world.contactTestPair(rbnode, n).getNumContacts() &gt; 0 ) for n in self.env.static]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbnode</span><span class="p">)</span>

        <span class="n">jtrans</span> <span class="o">=</span> <span class="n">rTrans</span><span class="p">[:]</span>
        <span class="n">rotMatj</span> <span class="o">=</span> <span class="n">rRot</span><span class="p">[:]</span>
        <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_distance_values</span><span class="p">(</span>
            <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">gridPointsCoords</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">dpad</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rRot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotMatj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tTrans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jtrans</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Megan Riel-Mehan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>