

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>cellpack.autopack.Environment &mdash; cellPack 1.0.3 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> cellPack
          

          
          </a>

          
            
            
              <div class="version">
                1.0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#stable-release">Stable release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#from-sources">From sources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Package modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cellpack.html">cellpack package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../cellpack.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../cellpack.autopack.html">cellpack.autopack package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../cellpack.bin.html">cellpack.bin package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../cellpack.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cellpack.html#module-cellpack.example">cellpack.example module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../cellpack.html#cellpack.example.Example"><code class="docutils literal notranslate"><span class="pre">Example</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../cellpack.html#module-cellpack">Module contents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../cellpack.html#cellpack.get_module_version"><code class="docutils literal notranslate"><span class="pre">get_module_version()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../recipe-schema.html">Cellpack Recipe Schema 1.0</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../recipe-schema.html#recipe-definition-properties">Recipe definition properties</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#name">name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#version">version</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../recipe-schema.html#example">example:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../recipe-schema.html#options-properties">Options properties</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#saveresult">saveResult</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#result-file">result_file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#enviroonly">EnviroOnly</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#canceldialog">cancelDialog</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#pickweightedingr">pickWeightedIngr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#pickrandpt">pickRandPt</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#ingrlookforneighbours">ingrLookForNeighbours</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#overwriteplacemethod">overwritePlaceMethod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#boundingbox">boundingBox</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#smallestproteinsize">smallestProteinSize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#largestproteinsize">largestProteinSize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#computegridparams">computeGridParams</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#windowssize">windowsSize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#runtimedisplay">runTimeDisplay</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#place-method">place_method</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#use-gradient">use_gradient</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#gradients">gradients</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#innergridmethod">innerGridMethod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#freeptsupdatethreshold">freePtsUpdateThreshold</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#use-periodicity">use_periodicity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#timer">_timer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#hackfreepts">_hackFreepts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../recipe-schema.html#example-options">example <code class="docutils literal notranslate"><span class="pre">Options</span></code>:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../recipe-schema.html#ingredient-properties">Ingredient Properties</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#id81">name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#molarity">molarity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#count">count</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#encapsulating-radius">encapsulating_radius</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#radii">radii</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#positions">positions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#positions2">positions2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#spherefile">sphereFile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#priority">priority</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#pdb">pdb</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#color">color</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#meshfile">meshFile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#meshname">meshName</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#coordsystem">coordsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#principal-vector">principal_vector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#type">type</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#offset">offset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#max-jitter">max_jitter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#jitter-attempts">jitter_attempts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#perturb-axis-amplitude">perturb_axis_amplitude</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#use-rotation-axis">use_rotation_axis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#rotation-axis">rotation_axis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#rotation-range">rotation_range</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#use-orient-bias">use_orient_bias</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#orientbiasrotrangemin">orientBiasRotRangeMin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#orientbiasrotrangemax">orientBiasRotRangeMax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#cutoff-boundary">cutoff_boundary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#cutoff-surface">cutoff_surface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#id162">place_method</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#rejection-threshold">rejection_threshold</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#packing-mode">packing_mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#gradient">gradient</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#proba-binding">proba_binding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#proba-not-binding">proba_not_binding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#is-attractor">is_attractor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#weight">weight</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#partners-name">partners_name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#excluded-partners-name">excluded_partners_name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#partners-position">partners_position</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#partners-weight">partners_weight</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#properties">properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#score">score</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#organism">organism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../recipe-schema.html#example-ingredient">example ingredient</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#get-started">Get Started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#deploying">Deploying</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">cellPack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../cellpack.html">cellpack</a> &raquo;</li>
        
          <li><a href="../autopack.html">cellpack.autopack</a> &raquo;</li>
        
      <li>cellpack.autopack.Environment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cellpack.autopack.Environment</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">#</span>
<span class="sd"># autoPACK Authors: Graham T. Johnson, Mostafa Al-Alusi, Ludovic Autin, Michel Sanner</span>
<span class="sd">#   Based on COFFEE Script developed by Graham Johnson between 2005 and 2010</span>
<span class="sd">#   with assistance from Mostafa Al-Alusi in 2009 and periodic input</span>
<span class="sd">#   from Arthur Olson&#39;s Molecular Graphics Lab</span>
<span class="sd">#</span>
<span class="sd"># Environment.py Authors: Graham Johnson &amp; Michel Sanner with editing/enhancement</span>
<span class="sd"># from Ludovic Autin</span>
<span class="sd"># HistoVol.py became Environment.py in the Spring of 2013 to generalize the terminology</span>
<span class="sd"># away from biology</span>
<span class="sd">#</span>
<span class="sd"># Translation to Python initiated March 1, 2010 by Michel Sanner with Graham Johnson</span>
<span class="sd">#</span>
<span class="sd"># Class restructuring and organization: Michel Sanner</span>
<span class="sd">#</span>
<span class="sd"># Copyright: Graham Johnson Â©2010</span>
<span class="sd">#</span>
<span class="sd"># This file &quot;Environment.py&quot; is part of autoPACK, cellPACK.</span>
<span class="sd">#</span>
<span class="sd">#    autoPACK is free software: you can redistribute it and/or modify</span>
<span class="sd">#    it under the terms of the GNU General Public License as published by</span>
<span class="sd">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">#    (at your option) any later version.</span>
<span class="sd">#</span>
<span class="sd">#    autoPACK is distributed in the hope that it will be useful,</span>
<span class="sd">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">#    GNU General Public License for more details.</span>
<span class="sd">#</span>
<span class="sd">#    You should have received a copy of the GNU General Public License</span>
<span class="sd">#    along with autoPACK (See &quot;CopyingGNUGPL&quot; in the installation.</span>
<span class="sd">#    If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="sd">#</span>
<span class="sd">#</span>
<span class="sd">###############################################################################</span>
<span class="sd">@author: Graham Johnson, Ludovic Autin, &amp; Michel Sanner</span>

<span class="sd"># Hybrid version merged from Graham&#39;s Sept 2011 and Ludo&#39;s April 2012</span>
<span class="sd"># version on May 16, 2012</span>
<span class="sd"># Updated with final thesis HistoVol.py file from Sept 25, 2012 on July 5, 2012</span>
<span class="sd"># with correct analysis tools</span>

<span class="sd"># TODO: fix the save/restore grid</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span><span class="p">,</span> <span class="n">uniform</span><span class="p">,</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">encoder</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="c1"># PANDA3D Physics engine ODE and Bullet</span>
<span class="kn">import</span> <span class="nn">panda3d</span>

<span class="kn">from</span> <span class="nn">panda3d.core</span> <span class="kn">import</span> <span class="n">Mat3</span><span class="p">,</span> <span class="n">Mat4</span><span class="p">,</span> <span class="n">Vec3</span><span class="p">,</span> <span class="n">BitMask32</span><span class="p">,</span> <span class="n">NodePath</span>
<span class="kn">from</span> <span class="nn">panda3d.bullet</span> <span class="kn">import</span> <span class="n">BulletRigidBodyNode</span>

<span class="kn">import</span> <span class="nn">cellpack.autopack</span> <span class="k">as</span> <span class="nn">autopack</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.MeshStore</span> <span class="kn">import</span> <span class="n">MeshStore</span>
<span class="kn">import</span> <span class="nn">cellpack.autopack.ingredient</span> <span class="k">as</span> <span class="nn">ingredient</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.loaders.utils</span> <span class="kn">import</span> <span class="n">create_output_dir</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cmp_to_key</span><span class="p">,</span>
    <span class="n">expand_object_using_key</span><span class="p">,</span>
    <span class="n">ingredient_compare0</span><span class="p">,</span>
    <span class="n">ingredient_compare1</span><span class="p">,</span>
    <span class="n">ingredient_compare2</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.writers</span> <span class="kn">import</span> <span class="n">Writer</span>
<span class="kn">from</span> <span class="nn">.Compartment</span> <span class="kn">import</span> <span class="n">CompartmentList</span><span class="p">,</span> <span class="n">Compartment</span>
<span class="kn">from</span> <span class="nn">.Recipe</span> <span class="kn">import</span> <span class="n">Recipe</span>
<span class="kn">from</span> <span class="nn">.ingredient</span> <span class="kn">import</span> <span class="n">GrowIngredient</span><span class="p">,</span> <span class="n">ActinIngredient</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack</span> <span class="kn">import</span> <span class="n">IOutils</span>
<span class="kn">from</span> <span class="nn">.octree</span> <span class="kn">import</span> <span class="n">Octree</span>
<span class="kn">from</span> <span class="nn">.Gradient</span> <span class="kn">import</span> <span class="n">Gradient</span>
<span class="kn">from</span> <span class="nn">.transformation</span> <span class="kn">import</span> <span class="n">euler_from_matrix</span>

<span class="c1"># backward compatibility with kevin method</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.BaseGrid</span> <span class="kn">import</span> <span class="n">BaseGrid</span> <span class="k">as</span> <span class="n">BaseGrid</span>
<span class="kn">from</span> <span class="nn">.trajectory</span> <span class="kn">import</span> <span class="n">dcdTrajectory</span><span class="p">,</span> <span class="n">molbTrajectory</span>
<span class="kn">from</span> <span class="nn">.randomRot</span> <span class="kn">import</span> <span class="n">RandomRot</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="kc">None</span>


<span class="n">encoder</span><span class="o">.</span><span class="n">FLOAT_REPR</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="nb">format</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s2">&quot;.8g&quot;</span><span class="p">)</span>

<span class="n">SEED</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">LOG</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="Environment"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment">[docs]</a><span class="k">class</span> <span class="nc">Environment</span><span class="p">(</span><span class="n">CompartmentList</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Environment class</span>
<span class="sd">    ==========================</span>
<span class="sd">    This class is main class in autopack. The class handle all the setup, initialization</span>
<span class="sd">    and process of the packing. We use xml or python for the setup.</span>
<span class="sd">    A environments is made of :</span>
<span class="sd">        a grid and the gradients if any</span>
<span class="sd">        a list of compartment and their recipes (surface and interior)</span>
<span class="sd">        a exterior recipe</span>
<span class="sd">        each recipe are made of a list of ingredients</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recipe</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">CompartmentList</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span> <span class="o">=</span> <span class="n">MeshStore</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config_data</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span> <span class="o">=</span> <span class="n">recipe</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># From config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runTimeDisplay</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;live_packing&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;place_method&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">innerGridMethod</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inner_grid_method&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_output</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_periodicity</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_periodicity&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_place_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;overwrite_place_method&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickRandPt</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ordered_packing&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_sphere_trees</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;show_sphere_trees&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_grid_spheres</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;show_grid_plot&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recipe</span><span class="p">[</span><span class="s2">&quot;bounding_box&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_from_grid_file</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;load_from_grid_file&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># saving/pickle option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveResult</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span> <span class="ow">in</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_folder</span> <span class="o">=</span> <span class="n">create_output_dir</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;out&quot;</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;place_method&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">recipe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">recipe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_grid.dat&quot;</span>

        <span class="n">should_load_grid_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_from_grid_file</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span> <span class="k">if</span> <span class="n">should_load_grid_file</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupfile</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># the path of the recipe file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_filename</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_result_filename</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># str(gridn.getAttribute(&quot;grid_result&quot;))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timeUpDistLoopTotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hgrid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># panda world for collision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ongoing octree test, no need if openvdb wrapped to python</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Grid()  # the main grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingGrid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">0</span>  <span class="c1"># Only override this with 0 for 2D packing- otherwise its very unsafe!</span>
        <span class="p">)</span>
        <span class="c1"># 0 is the exterior, 1 is compartment 1 surface, -1 is compartment 1 interior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbCompartments</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># TODO: call this &#39;id&#39; consistent with container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># give the order of drop ingredient by ptInd from molecules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastrank</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># smallest and largest protein radii across all recipes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span> <span class="o">=</span> <span class="mi">999</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleER</span> <span class="o">=</span> <span class="mf">2.5</span>  <span class="c1"># hack in case problem with encapsulating radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computeGridParams</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">EnviroOnly</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EnviroOnlyCompartiment</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># bounding box of the Environment</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fbox_bb</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># used for estimating the volume</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fbox</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Oct 20, 2012 Graham wonders if this is part of the problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillBB</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># bounding box for a given fill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillbb_insidepoint</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>  <span class="c1"># Oct 20, 2012 Graham wonders if this is part of the problem</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freePointMask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[]</span>
        <span class="p">)</span>  <span class="c1"># list of ( (x,y,z), rotation, ingredient) triplet generated by packing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ingr_result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">randomRot</span> <span class="o">=</span> <span class="n">RandomRot</span><span class="p">()</span>  <span class="c1"># the class used to generate random rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngre_saved</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freePtsUpdateThreshold</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># optionally can provide a host and a viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># version of setup used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>

        <span class="c1"># option for packing using host dynamics capability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windowsSize</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windowsSize_overwrite</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orthogonalBoxType</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejection_threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># if use C4D RB dynamics, should be genralized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupRBOptions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulationTimes</span> <span class="o">=</span> <span class="mf">2.0</span>

        <span class="c1"># cancel dialog-&gt; need to be develop more</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cancelDialog</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grab_cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_set</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_used</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cFill</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FillName</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;F&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nFill</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># do we sort the ingredient or not see  getSortedActiveIngredients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currtId</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># gradient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_gradient</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gradients&quot;</span><span class="p">,</span> <span class="p">{}))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_halton</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># use halton for grid point distribution</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ingrLookForNeighbours</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Old Features to be test</span>

        <span class="c1"># debug with timer function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_ingredient</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totalNbIngr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treemode</span> <span class="o">=</span> <span class="s2">&quot;cKDTree&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>  <span class="c1"># RBHTree(a.tolist(),range(len(a)),10,10,10,10,10,9999)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rTrans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rIngr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rRot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># should be part of an independent module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">=</span> <span class="s2">&quot;bullet&quot;</span>  <span class="c1"># or bullet</span>
        <span class="c1"># could be a problem here for pp</span>
        <span class="c1"># can&#39;t pickle this dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rb_func_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># need options for the save/server data etc....</span>
        <span class="c1"># should it be in __init__ like other general options ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_freq</span> <span class="o">=</span> <span class="mf">120.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jsondic</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">distancesAfterFill</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freePointsAfterFill</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbFreePointsAfterFill</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distanceAfterFill</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;composition&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root_compartment</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compartment_keys</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference_dict</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">referenced_objects</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">Recipe</span><span class="o">.</span><span class="n">resolve_composition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_objects</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gradient</span><span class="p">:</span>
            <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;gradients&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">gradient_name</span> <span class="ow">in</span> <span class="n">gradients</span><span class="p">:</span>
                <span class="n">gradient_data</span> <span class="o">=</span> <span class="n">gradients</span><span class="p">[</span><span class="n">gradient_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;surface_name&quot;</span> <span class="ow">in</span> <span class="n">gradient_data</span><span class="p">:</span>
                    <span class="n">gradient_data</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compartment_object_by_name</span><span class="p">(</span>
                        <span class="n">gradient_data</span><span class="p">[</span><span class="s2">&quot;surface_name&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_gradient</span><span class="p">(</span><span class="n">gradient_name</span><span class="p">,</span> <span class="n">gradient_data</span><span class="p">)</span>

<div class="viewcode-block" id="Environment.get_compartment_object_by_name"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_compartment_object_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_compartment_object_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns compartment object by name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">compartment_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">compartment</span></div>

<div class="viewcode-block" id="Environment.get_bounding_box_limits"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_bounding_box_limits">[docs]</a>    <span class="k">def</span> <span class="nf">get_bounding_box_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the min and max limits for the bounding box</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>
        <span class="n">min_bound</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_bound</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">min_bound</span><span class="p">,</span> <span class="n">max_bound</span></div>

<div class="viewcode-block" id="Environment.setSeed"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setSeed">[docs]</a>    <span class="k">def</span> <span class="nf">setSeed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seedNum</span><span class="p">):</span>
        <span class="n">SEED</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seedNum</span><span class="p">)</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>  <span class="c1"># for gradient</span>
        <span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomRot</span><span class="o">.</span><span class="n">setSeed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_set</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_used</span> <span class="o">=</span> <span class="n">SEED</span></div>

    <span class="k">def</span> <span class="nf">_prep_ingredient_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition_info</span><span class="p">,</span> <span class="n">ingredient_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">objects_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span>
        <span class="n">object_key</span> <span class="o">=</span> <span class="n">composition_info</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>
        <span class="n">ingredient_info</span> <span class="o">=</span> <span class="n">expand_object_using_key</span><span class="p">(</span>
            <span class="n">composition_info</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">objects_dict</span>
        <span class="p">)</span>
        <span class="n">ingredient_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ingredient_name</span> <span class="k">if</span> <span class="n">ingredient_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">object_key</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ingredient_info</span>

    <span class="k">def</span> <span class="nf">_step_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment_key</span><span class="p">,</span> <span class="n">prev_compartment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">prev_compartment</span> <span class="k">if</span> <span class="n">prev_compartment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span>
        <span class="n">composition_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;composition&quot;</span><span class="p">]</span>
        <span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_compartment</span><span class="p">(</span><span class="n">compartment_key</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="n">compartment_info</span> <span class="o">=</span> <span class="n">composition_dict</span><span class="p">[</span><span class="n">compartment_key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">obj_keys</span> <span class="ow">in</span> <span class="n">compartment_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># check if entry in compositions has regions</span>
            <span class="n">recipe</span> <span class="o">=</span> <span class="n">Recipe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">compartment_key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key_or_dict</span> <span class="ow">in</span> <span class="n">obj_keys</span><span class="p">:</span>
                <span class="n">is_key</span><span class="p">,</span> <span class="n">composition_info</span> <span class="o">=</span> <span class="n">Recipe</span><span class="o">.</span><span class="n">is_key</span><span class="p">(</span><span class="n">key_or_dict</span><span class="p">,</span> <span class="n">composition_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_key</span> <span class="ow">and</span> <span class="n">key_or_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartment_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key_or_dict</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_step_down</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prev_compartment</span><span class="o">=</span><span class="n">compartment</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key_or_dict</span> <span class="k">if</span> <span class="n">is_key</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">ingredient_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_ingredient_info</span><span class="p">(</span><span class="n">composition_info</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_ingredient</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">ingredient_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">region_name</span> <span class="o">==</span> <span class="s2">&quot;surface&quot;</span><span class="p">:</span>
                <span class="n">compartment</span><span class="o">.</span><span class="n">setSurfaceRecipe</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">region_name</span> <span class="o">==</span> <span class="s2">&quot;interior&quot;</span><span class="p">:</span>
                <span class="n">compartment</span><span class="o">.</span><span class="n">setInnerRecipe</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span>

<div class="viewcode-block" id="Environment.create_objects"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.create_objects">[docs]</a>    <span class="k">def</span> <span class="nf">create_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate compartments and ingredients contained within the recipe data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">composition_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;composition&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_compartment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_compartment</span> <span class="o">=</span> <span class="n">composition_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_compartment</span><span class="p">]</span>
            <span class="c1"># self.create_compartment(self.root_compartment)</span>
            <span class="n">external_recipe</span> <span class="o">=</span> <span class="n">Recipe</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">obj_keys</span> <span class="ow">in</span> <span class="n">root_compartment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="p">{}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># check if entry in compositions has regions</span>
                <span class="k">for</span> <span class="n">key_or_dict</span> <span class="ow">in</span> <span class="n">obj_keys</span><span class="p">:</span>
                    <span class="n">is_key</span><span class="p">,</span> <span class="n">composition_info</span> <span class="o">=</span> <span class="n">Recipe</span><span class="o">.</span><span class="n">is_key</span><span class="p">(</span>
                        <span class="n">key_or_dict</span><span class="p">,</span> <span class="n">composition_dict</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_key</span> <span class="ow">and</span> <span class="n">key_or_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartment_keys</span><span class="p">:</span>
                        <span class="c1"># key is pointing to another container</span>
                        <span class="c1"># make compartment and add ingredients inside it</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key_or_dict</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_step_down</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key_or_dict</span> <span class="k">if</span> <span class="n">is_key</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">ingredient_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_ingredient_info</span><span class="p">(</span>
                            <span class="n">composition_info</span><span class="p">,</span> <span class="n">key</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">create_ingredient</span><span class="p">(</span><span class="n">external_recipe</span><span class="p">,</span> <span class="n">ingredient_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setExteriorRecipe</span><span class="p">(</span><span class="n">external_recipe</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.reportprogress"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.reportprogress">[docs]</a>    <span class="k">def</span> <span class="nf">reportprogress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span> <span class="s2">&quot;vi&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">progressBar</span><span class="p">(</span><span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.set_partners_ingredient"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.set_partners_ingredient">[docs]</a>    <span class="k">def</span> <span class="nf">set_partners_ingredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">partners_name</span><span class="p">:</span>
            <span class="n">weightinitial</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">partners_weight</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">partners_name</span><span class="p">)</span>  <span class="c1"># this is 1</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weightinitial</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">partners_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">total</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">weightinitial</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">partners_name</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">iname</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">weightinitial</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">total</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)))</span>
                <span class="n">ingr_partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromName</span><span class="p">(</span><span class="n">iname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ingr_partner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">partners_position</span><span class="p">):</span>
                    <span class="n">partner</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">addPartner</span><span class="p">(</span>
                        <span class="n">ingr_partner</span><span class="p">,</span>
                        <span class="n">weight</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
                        <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">ingr</span><span class="o">.</span><span class="n">partners_position</span><span class="p">[</span><span class="n">i</span><span class="p">]},</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">partner</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">addPartner</span><span class="p">(</span><span class="n">ingr_partner</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{})</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ingr_partner</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                    <span class="n">partner</span><span class="o">.</span><span class="n">addProperties</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ingr_partner</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
                <span class="n">w</span> <span class="o">+=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">weightinitial</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">total</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="n">weightinitial</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">prepare_alternates</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">excluded_partners_name</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="n">ingr</span><span class="o">.</span><span class="n">excluded_partners_name</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">addExcludedPartner</span><span class="p">(</span><span class="n">iname</span><span class="p">)</span>
        <span class="n">ingr</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span></div>

    <span class="c1"># def unpack_objects(self, objects):</span>
    <span class="c1">#     for key, value in objects.items():</span>

<div class="viewcode-block" id="Environment.save_result"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.save_result">[docs]</a>    <span class="k">def</span> <span class="nf">save_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">free_points</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">vAnalysis</span><span class="p">,</span> <span class="n">vTestid</span><span class="p">,</span> <span class="n">seedNum</span><span class="p">,</span> <span class="n">all_ingr_as_array</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[:]</span>
        <span class="c1"># should check extension filename for type of saved file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_from_grid_file</span><span class="p">:</span>
            <span class="c1"># do not overwrite if grid was loaded from file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">result_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saveGridToFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveGridLogsAsJson</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_file</span> <span class="o">+</span> <span class="s2">&quot;_grid-data.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectResultPerIngredient</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_asTxt</span><span class="p">()</span>
        <span class="n">Writer</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format_output</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span><span class="p">,</span>
            <span class="n">kwds</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;compNum&quot;</span><span class="p">],</span>
            <span class="n">result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">quaternion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">all_ingr_as_array</span><span class="o">=</span><span class="n">all_ingr_as_array</span><span class="p">,</span>
            <span class="n">compartments</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;time to save result file </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vAnalysis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># START Analysis Tools: Graham added back this big chunk of code for analysis tools and graphic on 5/16/12 Needs to be cleaned up into a function and proper uPy code</span>
            <span class="c1"># totalVolume = self.grid.gridVolume*unitVol</span>
            <span class="n">unitVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridSpacing</span><span class="o">**</span><span class="mi">3</span>
            <span class="n">wrkDirRes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span> <span class="o">+</span> <span class="s2">&quot;_analyze_&quot;</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>  <span class="c1"># only for compartment ?</span>
                <span class="c1"># totalVolume -= o.surfaceVolume</span>
                <span class="c1"># totalVolume -= o.interiorVolume</span>
                <span class="n">innerPointNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">insidePoints</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  .  .  .  . &quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;for compartment o = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;inner Point Count = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">innerPointNum</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;inner Volume = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">interiorVolume</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;innerVolume temp Confirm = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">innerPointNum</span> <span class="o">*</span> <span class="n">unitVol</span><span class="p">)</span>
                <span class="n">usedPts</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">unUsedPts</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">vDistanceString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">insidepointindce</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span><span class="p">,</span> <span class="o">-</span><span class="n">o</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">insidepointindce</span><span class="p">:</span>  <span class="c1"># xrange(innerPointNum):</span>
                    <span class="c1">#                        pt = o.insidePoints[i] #fpts[i]</span>
                    <span class="c1">#                        print (pt,type(pt))</span>
                    <span class="c1"># for pt in self.histo.freePointsAfterFill:#[:self.histo.nbFreePointsAfterFill]:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distancesAfterFill</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">vDistanceString</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># &gt;self.smallestProteinSize-0.001:</span>
                        <span class="n">usedPts</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">unUsedPts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">wrkDirRes</span>
                    <span class="o">+</span> <span class="s2">&quot;vResultMatrix1&quot;</span>
                    <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span>
                    <span class="o">+</span> <span class="s2">&quot;_Testid&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vTestid</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;_Seed&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seedNum</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;_dists.txt&quot;</span>
                <span class="p">)</span>  <span class="c1"># Used this from thesis to overwrite less informative SVN version on next line on July 5, 2012</span>
                <span class="c1">#            filename = wrkDirRes+&quot;/vDistances1.txt&quot;</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vDistanceString</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c1"># result is [pos,rot,ingr.name,ingr.compNum,ptInd]</span>
                <span class="c1"># if resultfilename == None:</span>
                <span class="c1"># resultfilename = self.result_file</span>
                <span class="n">resultfilenameT</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">wrkDirRes</span>
                    <span class="o">+</span> <span class="s2">&quot;vResultMatrix1&quot;</span>
                    <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span>
                    <span class="o">+</span> <span class="s2">&quot;_Testid&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vTestid</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;_Seed&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seedNum</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;_Trans.txt&quot;</span>
                <span class="p">)</span>  <span class="c1"># Used this from thesis to overwrite less informative SVN version on next line on July 5, 2012</span>
                <span class="n">resultfilenameR</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">wrkDirRes</span>
                    <span class="o">+</span> <span class="s2">&quot;vResultMatrix1&quot;</span>
                    <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span>
                    <span class="o">+</span> <span class="s2">&quot;_Testid&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vTestid</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;_Seed&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seedNum</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;_Rot.txt&quot;</span>
                <span class="p">)</span>
                <span class="n">vTranslationString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">vRotationString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">matCount</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
                    <span class="c1"># BEGIN: newer code from Theis version added July 5, 2012</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;afviewer&quot;</span><span class="p">):</span>
                        <span class="n">mat</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>

                        <span class="c1"># r = R.from_matrix(mat).as_euler(&quot;xyz&quot;, degrees=False)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">euler_from_matrix</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s2">&quot;rxyz&quot;</span><span class="p">)</span>
                        <span class="n">h1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">p1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">b1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rot from matrix = </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
                        <span class="c1"># END: newer code from Theis version added July 5, 2012</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">])</span>
                    <span class="n">pt3d</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">matCount</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">y</span><span class="p">,</span>
                        <span class="n">z</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">pt3d</span>

                    <span class="n">vTranslationString</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># vRotationString += str(rot3d) #str(h)+ &quot;,\t&quot; + str(p) + &quot;,\t&quot; + str(b) + &quot;\n&quot;</span>
                    <span class="n">vRotationString</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\t</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\t</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\t</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">matCount</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilenameT</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">rfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vTranslationString</span><span class="p">)</span>
                <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilenameR</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">rfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vRotationString</span><span class="p">)</span>
                <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(result) = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(self.molecules) = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">))</span>
                <span class="c1"># Graham Note:  There is overused disk space- the rotation matrix is 4x4 with an offset of 0,0,0</span>
                <span class="c1"># and we have a separate translation vector in the results and molecules arrays.</span>
                <span class="c1">#  Get rid of the translation vector and move it to the rotation matrix to save space...</span>
                <span class="c1"># will that slow the time it takes to extract the vector from the matrix when we need to call it?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;*************************************************** vDistance String Should be on&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;unitVolume2 = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unitVol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of Points Unused = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unUsedPts</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of Points Used   = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usedPts</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Volume Used   = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usedPts</span> <span class="o">*</span> <span class="n">unitVol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Volume Unused = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unUsedPts</span> <span class="o">*</span> <span class="n">unitVol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;vTestid = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vTestid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.grid.nbGridPoints = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">nbGridPoints</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.gridVolume = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridVolume</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.compartments In Environment = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">unitVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridSpacing</span><span class="o">**</span><span class="mi">3</span>
            <span class="n">innerPointNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_points</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  .  .  .  . &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;inner Point Count = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">innerPointNum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;innerVolume temp Confirm = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">innerPointNum</span> <span class="o">*</span> <span class="n">unitVol</span><span class="p">)</span>
            <span class="n">usedPts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">unUsedPts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># fpts = self.freePointsAfterFill</span>
            <span class="n">vDistanceString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">innerPointNum</span><span class="p">):</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># fpts[i]</span>
                <span class="c1"># for pt in self.histo.freePointsAfterFill:#[:self.histo.nbFreePointsAfterFill]:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distancesAfterFill</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
                <span class="n">vDistanceString</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># &gt;self.smallestProteinSize-0.001:</span>
                    <span class="n">usedPts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">unUsedPts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Graham Note:  There is overused disk space- the rotation matrix is 4x4 with an offset of 0,0,0</span>
            <span class="c1"># and we have a separate translation vector in the results and molecules arrays.</span>
            <span class="c1"># Get rid of the translation vector and move it to the rotation matrix to save space...</span>
            <span class="c1"># will that slow the time it takes to extract the vector from the matrix when we need to call it?</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;unitVolume2 = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unitVol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of Points Unused = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unUsedPts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of Points Used   = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usedPts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Volume Used   = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usedPts</span> <span class="o">*</span> <span class="n">unitVol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Volume Unused = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unUsedPts</span> <span class="o">*</span> <span class="n">unitVol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;vTestid = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vTestid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.nbGridPoints = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">nbGridPoints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.gridVolume = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridVolume</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;histoVol.timeUpDistLoopTotal = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeUpDistLoopTotal</span><span class="p">)</span>

            <span class="c1">#    END Analysis Tools: Graham added back this big chunk of code for analysis tools and graphic on 5/16/12 Needs to be cleaned up into a function and proper uPy code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;time to save end </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.loadResult"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.loadResult">[docs]</a>    <span class="k">def</span> <span class="nf">loadResult</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restore_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backward</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
            <span class="c1"># check the extension of the filename none, txt or json</span>
        <span class="n">fileName</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;can&#39;t read &quot;</span> <span class="o">+</span> <span class="n">resultfilename</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.apr&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_asTxt</span><span class="p">(</span><span class="n">resultfilename</span><span class="o">=</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.txt&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_asTxt</span><span class="p">(</span><span class="n">resultfilename</span><span class="o">=</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">backward</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_asJson</span><span class="p">(</span><span class="n">resultfilename</span><span class="o">=</span><span class="n">resultfilename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">IOutils</span><span class="o">.</span><span class="n">load_MixedasJson</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="n">resultfilename</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="n">transpose</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;can&#39;t read or recognize &quot;</span> <span class="o">+</span> <span class="n">resultfilename</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Environment.includeIngrRecipes"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.includeIngrRecipes">[docs]</a>    <span class="k">def</span> <span class="nf">includeIngrRecipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Include or Exclude the given ingredient from the recipe.</span>
<span class="sd">        (similar to an active state toggle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeIngrRecipe</span><span class="p">(</span><span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeIngrRecipe</span><span class="p">(</span><span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">rs</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeIngrRecipe</span><span class="p">(</span><span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">ri</span><span class="p">):</span>
                <span class="k">return</span></div>

<div class="viewcode-block" id="Environment.includeIngrRecipe"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.includeIngrRecipe">[docs]</a>    <span class="k">def</span> <span class="nf">includeIngrRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">rs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Include or Exclude the given ingredient from the given recipe.</span>
<span class="sd">        (similar to an active state toggle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ingrname</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">include</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rs</span><span class="o">.</span><span class="n">addIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ingrname</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">include</span><span class="p">:</span>
                    <span class="n">rs</span><span class="o">.</span><span class="n">delIngredients</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Environment.includeIngredientRecipe"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.includeIngredientRecipe">[docs]</a>    <span class="k">def</span> <span class="nf">includeIngredientRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">include</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;lue</span>
<span class="sd">        Include or Exclude the given ingredient from the recipe.</span>
<span class="sd">        (similar to an active state toggle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">recipe</span>  <span class="c1"># ()</span>
        <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">addIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">delIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.sortIngredient"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.sortIngredient">[docs]</a>    <span class="k">def</span> <span class="nf">sortIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># make sure all recipes are sorted from large to small radius</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span></div>

<div class="viewcode-block" id="Environment.set_gradient"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.set_gradient">[docs]</a>    <span class="k">def</span> <span class="nf">set_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">gradient_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create a grdaient</span>
<span class="sd">        assign weight to point</span>
<span class="sd">        listorganelle influenced</span>
<span class="sd">        listingredient influenced</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="n">Gradient</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">gradient_data</span><span class="p">)</span>
        <span class="c1"># default gradient 1-linear Decoy X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradient</span></div>

<div class="viewcode-block" id="Environment.callFunction"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.callFunction">[docs]</a>    <span class="k">def</span> <span class="nf">callFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kw</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        helper function to callback another function with the</span>
<span class="sd">        given arguments and keywords.</span>
<span class="sd">        Optionally time stamp it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Environment.is_two_d"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.is_two_d">[docs]</a>    <span class="k">def</span> <span class="nf">is_two_d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">grid_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridSpacing</span>
        <span class="n">bounding_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span>
        <span class="n">box_size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">smallest_size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">box_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">smallest_size</span> <span class="o">&lt;=</span> <span class="n">grid_spacing</span></div>

<div class="viewcode-block" id="Environment.timeFunction"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.timeFunction">[docs]</a>    <span class="k">def</span> <span class="nf">timeFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mesure the time for performing the provided function.</span>

<span class="sd">        @type  function: function</span>
<span class="sd">        @param function: the function to execute</span>
<span class="sd">        @type  args: liste</span>
<span class="sd">        @param args: the liste of arguments for the function</span>


<span class="sd">        @rtype:   list/array</span>
<span class="sd">        @return:  the center of mass of the coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;time &quot;</span> <span class="o">+</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Environment.SetRBOptions"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.SetRBOptions">[docs]</a>    <span class="k">def</span> <span class="nf">SetRBOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="s2">&quot;moving&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the rigid body options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">,</span>
            <span class="s2">&quot;child&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dynamicsBody&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;massClamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rotMassClamp&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Environment.SetSpringOptions"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.SetSpringOptions">[docs]</a>    <span class="k">def</span> <span class="nf">SetSpringOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the spring options, mainly used by C4D.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stifness&quot;</span><span class="p">,</span> <span class="s2">&quot;rlength&quot;</span><span class="p">,</span> <span class="s2">&quot;damping&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Environment.setupRBOptions"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setupRBOptions">[docs]</a>    <span class="k">def</span> <span class="nf">setupRBOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set default value for rigid body options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span><span class="p">[</span><span class="s2">&quot;stifness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span><span class="p">[</span><span class="s2">&quot;rlength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span><span class="p">[</span><span class="s2">&quot;damping&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsBody&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;massClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;rotMassClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsBody&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;massClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;rotMassClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsBody&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;massClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;rotMassClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsBody&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;massClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;rotMassClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Environment.writeArraysToFile"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.writeArraysToFile">[docs]</a>    <span class="k">def</span> <span class="nf">writeArraysToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;write self.compartment_ids and self.distToClosestSurf to file. (pickle)&quot;&quot;&quot;</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.readArraysFromFile"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.readArraysFromFile">[docs]</a>    <span class="k">def</span> <span class="nf">readArraysFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;write self.compartment_ids and self.distToClosestSurf to file. (pickle)&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span> <span class="o">=</span> <span class="n">pos</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span> <span class="o">=</span> <span class="n">dist</span>  <span class="c1"># grid+organelle+surf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">id</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Environment.saveGridToFile"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.saveGridToFile">[docs]</a>    <span class="k">def</span> <span class="nf">saveGridToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current grid and the compartment grid information in a file. (pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">gridFileOut</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SAVED GRID TO &quot;</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gridfilename path problem&quot;</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">gridFileOut</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>  <span class="c1"># &#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeArraysToFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">saveGridToFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Environment.saveGridLogsAsJson"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.saveGridLogsAsJson">[docs]</a>    <span class="k">def</span> <span class="nf">saveGridLogsAsJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current grid and the compartment grid information in a file. (pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">gridFileOut</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gridfilename path problem&quot;</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
                <span class="p">],</span>
                <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="s2">&quot;compartment&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">}</span>
        <span class="c1"># data = {</span>
        <span class="c1">#     # &quot;gridPositions&quot;: json.loads(self.grid.masterGridPositions),</span>
        <span class="c1">#     &quot;distances&quot;: json.loads(self.grid.distToClosestSurf)</span>
        <span class="c1"># }</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gridFileOut</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Environment.restoreGridFromFile"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.restoreGridFromFile">[docs]</a>    <span class="k">def</span> <span class="nf">restoreGridFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridFileName</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and setup the grid from the given filename. (pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading grid from </span><span class="si">{</span><span class="n">gridFileName</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">aInteriorGrids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aSurfaceGrids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">gridFileName</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readArraysFromFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">readGridFromFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">aInteriorGrids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compartment</span><span class="o">.</span><span class="n">insidePoints</span><span class="p">)</span>
            <span class="n">aSurfaceGrids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compartment</span><span class="o">.</span><span class="n">surfacePoints</span><span class="p">)</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">OGsrfPtsBht</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">compartment</span><span class="o">.</span><span class="n">vertices</span><span class="p">),</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">compute_volume_and_set_count</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfacePoints</span><span class="p">,</span> <span class="n">compartment</span><span class="o">.</span><span class="n">insidePoints</span><span class="p">,</span> <span class="n">areas</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># TODO: restore surface distances on loading from grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aInteriorGrids</span> <span class="o">=</span> <span class="n">aInteriorGrids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aSurfaceGrids</span> <span class="o">=</span> <span class="n">aSurfaceGrids</span></div>

<div class="viewcode-block" id="Environment.extractMeshComponent"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.extractMeshComponent">[docs]</a>    <span class="k">def</span> <span class="nf">extractMeshComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Require host helper. Return the v,f,n of the given object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extractMeshComponent&quot;</span><span class="p">,</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">helper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no Helper found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">:</span>  <span class="c1"># compartment master parent?</span>
            <span class="n">childs</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getChilds</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">childs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getChilds</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                    <span class="c1"># should be all polygon</span>
                    <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">vertices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">vnormals</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vn</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
                            <span class="n">pc</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="n">faces</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="n">vertices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">vnormals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">vnormals</span>
                <span class="k">elif</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">:</span>
                    <span class="n">faces</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">vnormals</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
                        <span class="n">ch</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">vnormals</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">:</span>
            <span class="n">faces</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">vnormals</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
                <span class="n">obj</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">vnormals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;extractMeshComponent&quot;</span><span class="p">,</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">,</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Environment.setCompartmentMesh"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setCompartmentMesh">[docs]</a>    <span class="k">def</span> <span class="nf">setCompartmentMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment</span><span class="p">,</span> <span class="n">ref_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Require host helper. Change the mesh of the given compartment and recompute</span>
<span class="sd">        inside and surface point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compartment</span><span class="o">.</span><span class="n">ref_obj</span> <span class="o">==</span> <span class="n">ref_obj</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ref_obj</span><span class="p">):</span>
            <span class="n">fileName</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">ref_obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">helper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># neeed the helper</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ref_obj</span><span class="p">)</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="c1"># reparent to the fill parent</span>
                <span class="c1"># rotate ?</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">!=</span> <span class="s2">&quot;c4d&quot;</span> <span class="ow">and</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># need to rotate the transform that carry the shape</span>
                    <span class="n">helper</span><span class="o">.</span><span class="n">rotateObj</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">ref_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">vnormals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractMeshComponent</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">setMesh</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">ref_obj</span><span class="p">,</span> <span class="n">vertices</span><span class="o">=</span><span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="o">=</span><span class="n">faces</span><span class="p">,</span> <span class="n">vnormals</span><span class="o">=</span><span class="n">vnormals</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Environment.update_largest_smallest_size"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.update_largest_smallest_size">[docs]</a>    <span class="k">def</span> <span class="nf">update_largest_smallest_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">min_radius</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">min_radius</span></div>

<div class="viewcode-block" id="Environment.create_ingredient"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.create_ingredient">[docs]</a>    <span class="k">def</span> <span class="nf">create_ingredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipe</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;place_method&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;place_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_method</span>
        <span class="n">ingredient_type</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">ingredient_class</span> <span class="o">=</span> <span class="n">ingredient</span><span class="o">.</span><span class="n">get_ingredient_class</span><span class="p">(</span><span class="n">ingredient_type</span><span class="p">)</span>
        <span class="n">ingr</span> <span class="o">=</span> <span class="n">ingredient_class</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;gradient&quot;</span> <span class="ow">in</span> <span class="n">arguments</span>
            <span class="ow">and</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;gradient&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
            <span class="ow">and</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;gradient&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span>
        <span class="p">):</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;gradient&quot;</span><span class="p">]</span>
            <span class="c1"># TODO: allow ingrdients to have multiple gradients</span>
        <span class="k">if</span> <span class="s2">&quot;results&quot;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span>
        <span class="n">ingr</span><span class="o">.</span><span class="n">initialize_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span><span class="p">)</span>
        <span class="n">recipe</span><span class="o">.</span><span class="n">addIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_largest_smallest_size</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.create_compartment"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.create_compartment">[docs]</a>    <span class="k">def</span> <span class="nf">create_compartment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment_key</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="n">comp_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;composition&quot;</span><span class="p">]</span>
        <span class="n">obj_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;object&quot;</span> <span class="ow">in</span> <span class="n">comp_dic</span><span class="p">[</span><span class="n">compartment_key</span><span class="p">]:</span>
            <span class="c1"># create compartment using object</span>
            <span class="n">object_info</span> <span class="o">=</span> <span class="n">obj_dic</span><span class="p">[</span><span class="n">comp_dic</span><span class="p">[</span><span class="n">compartment_key</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use bounding box</span>
            <span class="n">object_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bounding_box&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">}</span>

        <span class="n">compartment</span> <span class="o">=</span> <span class="n">Compartment</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">compartment_key</span><span class="p">,</span>
            <span class="n">object_info</span><span class="o">=</span><span class="n">object_info</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">compartment</span><span class="o">.</span><span class="n">initialize_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_compartment</span><span class="p">(</span><span class="n">compartment</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compartment</span></div>

    <span class="k">def</span> <span class="nf">_add_compartment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the given compartment to the environment.</span>
<span class="sd">        Extend the main bounding box if needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compartment</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbCompartments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbCompartments</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compartment</span><span class="p">)</span>

        <span class="n">CompartmentList</span><span class="o">.</span><span class="n">add_compartment</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">compartment</span><span class="p">)</span>

<div class="viewcode-block" id="Environment.compartment_id_for_nearest_grid_point"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.compartment_id_for_nearest_grid_point">[docs]</a>    <span class="k">def</span> <span class="nf">compartment_id_for_nearest_grid_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="c1"># check if point inside  of the compartments</span>
        <span class="c1"># closest grid point is</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getClosestGridPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">compartment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">compartment_id</span></div>

<div class="viewcode-block" id="Environment.longestIngrdientName"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.longestIngrdientName">[docs]</a>    <span class="k">def</span> <span class="nf">longestIngrdientName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for gui. Return the size of the longest ingredient name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">M</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">M</span><span class="p">:</span>
                    <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">rs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">M</span><span class="p">:</span>
                        <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">ri</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">M</span><span class="p">:</span>
                        <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">M</span></div>

<div class="viewcode-block" id="Environment.loopThroughIngr"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.loopThroughIngr">[docs]</a>    <span class="k">def</span> <span class="nf">loopThroughIngr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb_function</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function that loops through all ingredients of all recipes and applies the given</span>
<span class="sd">        callback function on each ingredients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="n">cb_function</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">surface_recipe</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">surface_recipe</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">surface_recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">cb_function</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
            <span class="n">inner_recipe</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">inner_recipe</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">inner_recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">cb_function</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.getIngrFromNameInRecipe"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getIngrFromNameInRecipe">[docs]</a>    <span class="k">def</span> <span class="nf">getIngrFromNameInRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an ingredient name and a recipe, retrieve the ingredient object instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="c1"># check if name start with comp name</span>
            <span class="c1"># backward compatibility</span>
            <span class="c1"># legacy code</span>
            <span class="c1"># Problem when ingredient in different compartments</span>
            <span class="c1"># compartments is in the first three caractet like int_2 or surf_1</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="c1">#                elif name.find(ingr.o_name) != -1 :</span>
                <span class="c1">#                    #check for</span>
                <span class="c1">#                    return ingr</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="c1">#                elif name.find(ingr.o_name) != -1 :</span>
                <span class="c1">#                    return ingr</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Environment.getIngrFromName"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getIngrFromName">[docs]</a>    <span class="k">def</span> <span class="nf">getIngrFromName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">compNum</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an ingredient name and optionally the compartment number, retrieve the ingredient object instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compNum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ingr</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span>
                <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="n">ri</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span>
                <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ri</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
        <span class="k">elif</span> <span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ingr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">compNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ingr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &lt;0</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[(</span><span class="n">compNum</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ri</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ingr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Environment.setExteriorRecipe"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setExteriorRecipe">[docs]</a>    <span class="k">def</span> <span class="nf">setExteriorRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipe</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the exterior recipe with the given one. Create the weakref.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span> <span class="o">=</span> <span class="n">recipe</span>
        <span class="n">recipe</span><span class="o">.</span><span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># weakref.ref(self)</span>
        <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Environment.BuildCompartmentsGrids"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.BuildCompartmentsGrids">[docs]</a>    <span class="k">def</span> <span class="nf">BuildCompartmentsGrids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the compartments grid (interior and surface points) to be merged with the main grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aInteriorGrids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aSurfaceGrids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># thread ?</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;in Environment, compartment.is_orthogonal_bounding_box=</span><span class="si">{</span><span class="n">compartment</span><span class="o">.</span><span class="n">is_orthogonal_bounding_box</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="p">(</span>
                <span class="n">points_inside_compartments</span><span class="p">,</span>
                <span class="n">points_on_compartment_surfaces</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">BuildGrid</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span>
            <span class="p">)</span>  <span class="c1"># return inside and surface point</span>
            <span class="n">aInteriorGrids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points_inside_compartments</span><span class="p">)</span>
            <span class="n">aSurfaceGrids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points_on_compartment_surfaces</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aInteriorGrids</span> <span class="o">=</span> <span class="n">aInteriorGrids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aSurfaceGrids</span> <span class="o">=</span> <span class="n">aSurfaceGrids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;I&#39;m out of the loop and have build my grid with inside points&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;build Grids </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">innerGridMethod</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aSurfaceGrids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Environment.build_compartment_grids"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.build_compartment_grids">[docs]</a>    <span class="k">def</span> <span class="nf">build_compartment_grids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;file is None thus re/building grid distance&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BuildCompartmentsGrids</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="n">verts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">surfacePointsCoords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)):</span>
                <span class="n">verts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">verts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">surfacePointsCoords</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">set_surfPtsBht</span><span class="p">(</span>
                <span class="n">verts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">)</span>  <span class="c1"># should do it only on inside grid point</span></div>

<div class="viewcode-block" id="Environment.extend_bounding_box_for_compartments"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.extend_bounding_box_for_compartments">[docs]</a>    <span class="k">def</span> <span class="nf">extend_bounding_box_for_compartments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="n">fits</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">inBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fits</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span> <span class="o">=</span> <span class="n">bb</span></div>

<div class="viewcode-block" id="Environment.get_size_of_bounding_box"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_size_of_bounding_box">[docs]</a>    <span class="k">def</span> <span class="nf">get_size_of_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">box_boundary</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">box_boundary</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box_boundary</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="Environment.buildGrid"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.buildGrid">[docs]</a>    <span class="k">def</span> <span class="nf">buildGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rebuild</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main build grid function. Setup the main grid and merge the</span>
<span class="sd">        compartment grid. The setup is de novo or using previously built grid</span>
<span class="sd">        or restored using given file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend_bounding_box_for_compartments</span><span class="p">()</span>

        <span class="n">boundingBox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_halton</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cellpack.autopack.BaseGrid</span> <span class="kn">import</span> <span class="n">HaltonGrid</span> <span class="k">as</span> <span class="n">Grid</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">innerGridMethod</span> <span class="o">==</span> <span class="s2">&quot;floodfill&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cellpack.autopack.Environment</span> <span class="kn">import</span> <span class="n">Grid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cellpack.autopack.BaseGrid</span> <span class="kn">import</span> <span class="n">BaseGrid</span> <span class="k">as</span> <span class="n">Grid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sortIngredient</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;####BUILD GRID - step </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fillBB</span> <span class="o">=</span> <span class="n">boundingBox</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">boundingBox</span><span class="o">=</span><span class="n">boundingBox</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">)</span>
            <span class="n">nbPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridVolume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;new Grid with </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">boundingBox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridVolume</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[:]</span>
                <span class="n">nbPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridVolume</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;$$$$$$$$  reset the grid&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">nbPoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;$$$$$$$$  reset the grid&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first fill, after we can just reset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;restore from file&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restoreGridFromFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_compartment_grids</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exteriorVolume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">computeExteriorVolume</span><span class="p">(</span>
            <span class="n">compartments</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">,</span>
            <span class="n">space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span><span class="p">,</span>
            <span class="n">fbox_bb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fbox_bb</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saveGridToFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exteriorVolume</span><span class="p">)</span>  <span class="c1"># should actually use the fillBB</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rebuild</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setCount</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span>  <span class="c1"># [:]</span>
            <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">nbPoints</span>  <span class="c1"># -1              #Graham turned this off on 5/16/12 to match August Repair for May Hybrid</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mingrs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
            <span class="p">):</span>  <span class="c1"># ( jtrans, rotMatj, self, ptInd )</span>
                <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onePrevIngredient</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">mingrs</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">organelle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mingrs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">organelle</span><span class="o">.</span><span class="n">molecules</span>
                <span class="p">):</span>  <span class="c1"># ( jtrans, rotMatj, self, ptInd )</span>
                    <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onePrevIngredient</span><span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span> <span class="n">mingrs</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">organelle</span><span class="o">.</span><span class="n">molecules</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">nbFreePoints</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gradient</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rebuild</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">:</span>
                <span class="n">gradient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">gradient</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;surface&quot;</span><span class="p">:</span>
                    <span class="n">gradient</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">get_surface_distances</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">build_weight_map</span><span class="p">(</span>
                    <span class="n">boundingBox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Environment.onePrevIngredient"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.onePrevIngredient">[docs]</a>    <span class="k">def</span> <span class="nf">onePrevIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mingrs</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">marray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unused</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="o">=</span> <span class="n">mingrs</span>
        <span class="n">centT</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">transformPoints</span><span class="p">(</span><span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">insidePoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">newDistPoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dpad</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span><span class="p">)</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">getMaxJitter</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>
        <span class="n">dpad</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">min_radius</span> <span class="o">+</span> <span class="n">mr</span> <span class="o">+</span> <span class="n">jitter</span>
        <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">getInsidePoints</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">,</span>
            <span class="n">dpad</span><span class="p">,</span>
            <span class="n">distance</span><span class="p">,</span>
            <span class="n">centT</span><span class="o">=</span><span class="n">centT</span><span class="p">,</span>
            <span class="n">jtrans</span><span class="o">=</span><span class="n">jtrans</span><span class="p">,</span>
            <span class="n">rotMatj</span><span class="o">=</span><span class="n">rotMatj</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># update free points</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">insidePoints</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_method</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;panda&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot; is inside&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkPtIndIngr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">marray</span><span class="p">)</span>
            <span class="c1"># ingr.inside_current_grid = True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not in the grid</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot; is outside&quot;</span><span class="p">)</span>
            <span class="c1"># rbnode = ingr.rbnode[ptInd]</span>
            <span class="c1"># ingr.rbnode.pop(ptInd)</span>
            <span class="n">marray</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ptInd</span>  <span class="c1"># uniq Id ?</span>
            <span class="c1"># ingr.rbnode[-1] = rbnode</span>
        <span class="c1"># doesnt seem to work properly...</span>
        <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">BaseGrid</span><span class="o">.</span><span class="n">updateDistances</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">insidePoints</span><span class="p">,</span>
            <span class="n">newDistPoints</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span><span class="p">,</span>
            <span class="n">nbFreePoints</span><span class="p">,</span>
            <span class="n">distance</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># should we reset the ingredient ? completion ?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ingr</span><span class="o">.</span><span class="n">is_previous</span><span class="p">:</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">firstTimeUpdate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># should actually count it</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;allIngrPts&quot;</span>
            <span class="p">):</span>  <span class="c1"># Graham here on 5/16/12 are these two lines safe?</span>
                <span class="k">del</span> <span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span>  <span class="c1"># Graham here on 5/16/12 are these two lines safe?</span>
        <span class="k">return</span> <span class="n">nbFreePoints</span></div>

<div class="viewcode-block" id="Environment.checkPtIndIngr"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.checkPtIndIngr">[docs]</a>    <span class="k">def</span> <span class="nf">checkPtIndIngr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">insidePoints</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">marray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We need to check if the point indice is correct in the case of panda packing.</span>
<span class="sd">        as the pt indice in the result array have a different meaning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># change key for rbnode too</span>
        <span class="n">rbnode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">ingr</span><span class="o">.</span><span class="n">rbnode</span><span class="p">:</span>
            <span class="n">rbnode</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">rbnode</span><span class="p">[</span><span class="n">ptInd</span><span class="p">]</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">rbnode</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ptInd</span><span class="p">)</span>
        <span class="k">elif</span> <span class="o">-</span><span class="n">ptInd</span> <span class="ow">in</span> <span class="n">ingr</span><span class="o">.</span><span class="n">rbnode</span><span class="p">:</span>
            <span class="n">rbnode</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">rbnode</span><span class="p">[</span><span class="o">-</span><span class="n">ptInd</span><span class="p">]</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">rbnode</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="n">ptInd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ptInd &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptInd</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; not in ingr.rbnode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">marray</span><span class="p">):</span>
            <span class="n">marray</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">insidePoints</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">rbnode</span><span class="p">[</span><span class="n">insidePoints</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">rbnode</span></div>

<div class="viewcode-block" id="Environment.getSortedActiveIngredients"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getSortedActiveIngredients">[docs]</a>    <span class="k">def</span> <span class="nf">getSortedActiveIngredients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allIngredients</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort the active ingredient according their pirority and radius.</span>
<span class="sd">        # first get the ones with a packing priority</span>
<span class="sd">        # Graham- This now works in concert with ingredient picking</span>

<span class="sd">        # Graham here- In the new setup, priority is infinite with abs[priority] increasing (+)</span>
<span class="sd">        # An ingredients with (-) priority will pack from greatest abs[-priority] one at a time</span>
<span class="sd">        #     to lease abs[-priority]... each ingredient will attempt to reach its molarity</span>
<span class="sd">        #     before moving on to the next ingredient, and all (-) ingredients will try to</span>
<span class="sd">        #     deposit before other ingredients are tested.</span>
<span class="sd">        # An ingredient with (+) priority will recieve a weighted value based on its abs[priority]</span>
<span class="sd">        #     e.g. an ingredient with a priority=10 will be 10x more likely to be picked than</span>
<span class="sd">        #     an ingredient with a priority=1.</span>
<span class="sd">        # An ingredient with the default priority=0 will recieve a weighted value based on its</span>
<span class="sd">        #     complexity. (currently complexity = min_radius), thus a more &#39;complex&#39; ingredient</span>
<span class="sd">        #     will more likely try to pack before a less &#39;complex&#39; ingredient.</span>
<span class="sd">        #     IMPORTANT: the +priority list does not fully mix with the priority=0 list, but this</span>
<span class="sd">        #     should be an option... currently, the priority=0 list is normalized against a range</span>
<span class="sd">        #     up to the smallest +priority ingredient and appended to the (+) list</span>
<span class="sd">        # TODO: Add an option to allow + ingredients to be weighted by assigned priority AND complexity</span>
<span class="sd">        #     Add an option to allow priority=0 ingredients to fit into the (+) ingredient list</span>
<span class="sd">        #       rather than appending to the end.</span>
<span class="sd">        #     Even better, add an option to set the max priority for the 0list and then plug the results</span>
<span class="sd">        #       into the (+) ingredient list.</span>
<span class="sd">        #     Get rid of the (-), 0, (+) system and recreate this as a new flag and a class function</span>
<span class="sd">        #        so we can add multiple styles of sorting and weighting systems.</span>
<span class="sd">        #     Make normalizedPriorities and thresholdPriorities members of Ingredient class to avoid</span>
<span class="sd">        #        building these arrays.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ingr1</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># given priorities</span>
        <span class="n">priorities1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ingr2</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># priority = 0 or none and will be assigned based on complexity</span>
        <span class="n">priorities2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ingr0</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># negative values will pack first in order of abs[priority]</span>
        <span class="n">priorities0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ing</span> <span class="ow">in</span> <span class="n">allIngredients</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ing</span><span class="o">.</span><span class="n">completion</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># ignore completed ingredients</span>
            <span class="k">if</span> <span class="n">ing</span><span class="o">.</span><span class="n">priority</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ing</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ingr2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="p">)</span>
                <span class="n">priorities2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ing</span><span class="o">.</span><span class="n">priority</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ingr1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="p">)</span>
                <span class="n">priorities1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ing.priority    = -ing.priority</span>
                <span class="n">ingr0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="p">)</span>
                <span class="n">priorities0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ingr1</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">ingredient_compare1</span><span class="p">))</span>
                <span class="n">ingr2</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">ingredient_compare2</span><span class="p">))</span>
                <span class="n">ingr0</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">ingredient_compare0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ATTENTION INGR NOT SORTED&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="c1"># GrahamAdded this stuff in summer 2011, beware!</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lowestIng</span> <span class="o">=</span> <span class="n">ingr1</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ingr1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowestPriority</span> <span class="o">=</span> <span class="n">lowestIng</span><span class="o">.</span><span class="n">priority</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowestPriority</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.lowestPriority for Ing1 = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowestPriority</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">radii</span> <span class="ow">in</span> <span class="n">ingr2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">radii</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Cylinders&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radii</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">radii</span><span class="o">.</span><span class="n">min_radius</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">radii</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Spheres&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">radii</span><span class="o">.</span><span class="n">min_radius</span>
            <span class="k">elif</span> <span class="n">radii</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Cube&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">radii</span><span class="o">.</span><span class="n">min_radius</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">+</span> <span class="n">r</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.totalRadii += </span><span class="si">%d</span><span class="s2"> = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># safety</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">+</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">priors2</span> <span class="ow">in</span> <span class="n">ingr2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">priors2</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Cylinders&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">priors2</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">priors2</span><span class="o">.</span><span class="n">min_radius</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">priors2</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Spheres&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">priors2</span><span class="o">.</span><span class="n">min_radius</span>
            <span class="n">np</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowestPriority</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">)</span>
            <span class="n">priors2</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">np</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.normalizedPriorities0 = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities0</span><span class="p">)</span>
        <span class="n">activeIngr0</span> <span class="o">=</span> <span class="n">ingr0</span>  <span class="c1"># +ingr1+ingr2  #cropped to 0 on 7/20/10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(activeIngr0) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">activeIngr0</span><span class="p">))</span>
        <span class="n">activeIngr12</span> <span class="o">=</span> <span class="n">ingr1</span> <span class="o">+</span> <span class="n">ingr2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(activeIngr12) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">activeIngr12</span><span class="p">))</span>
        <span class="n">packingPriorities</span> <span class="o">=</span> <span class="n">priorities0</span> <span class="o">+</span> <span class="n">priorities1</span> <span class="o">+</span> <span class="n">priorities2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;packingPriorities </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">packingPriorities</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">activeIngr0</span><span class="p">,</span> <span class="n">activeIngr12</span></div>

<div class="viewcode-block" id="Environment.clearRBingredient"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.clearRBingredient">[docs]</a>    <span class="k">def</span> <span class="nf">clearRBingredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delRB</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delRB</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Environment.clear"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># before closing remoeall rigidbody</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loopThroughIngr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clearRBingredient</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.reset"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset everything to empty and not done&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fbox_bb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totnbJitter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jitterLength</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetIngrRecip</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">orga</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="c1"># orga.reset()</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetIngrRecip</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetIngrRecip</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span>
            <span class="n">orga</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ingr_result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># need to clear all node</span>
            <span class="c1">#            nodes = self.rb_panda[:]</span>
            <span class="c1">#            for node in nodes:</span>
            <span class="c1">#                self.delRB(node)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moving</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">octree</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># the reset doesnt touch the grid...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rTrans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rIngr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rRot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span></div>
        <span class="c1"># rapid node ?</span>

<div class="viewcode-block" id="Environment.resetIngrRecip"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.resetIngrRecip">[docs]</a>    <span class="k">def</span> <span class="nf">resetIngrRecip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recip</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all ingredient of the given recipe&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">recip</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recip</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="c1"># ingr.results = []</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">firstTimeUpdate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">prev_alt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">start_positions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;isph&quot;</span><span class="p">):</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">isph</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;icyl&quot;</span><span class="p">):</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">icyl</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recip</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">firstTimeUpdate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">prev_alt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">start_positions</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;isph&quot;</span><span class="p">):</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">isph</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;icyl&quot;</span><span class="p">):</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">icyl</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Environment.getActiveIng"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getActiveIng">[docs]</a>    <span class="k">def</span> <span class="nf">getActiveIng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all remaining active ingredients&quot;&quot;&quot;</span>
        <span class="n">allIngredients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">recipe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="s2">&quot;molecules&quot;</span><span class="p">):</span>
                <span class="n">recipe</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># counter of placed molecules</span>
                <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># I DONT GET IT !</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">allIngredients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">compartment</span><span class="p">,</span> <span class="s2">&quot;molecules&quot;</span><span class="p">):</span>
                <span class="n">compartment</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">recipe</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># counter of placed molecules</span>
                    <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">allIngredients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">recipe</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># counter of placed molecules</span>
                    <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">allIngredients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">allIngredients</span></div>

<div class="viewcode-block" id="Environment.pickIngredient"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.pickIngredient">[docs]</a>    <span class="k">def</span> <span class="nf">pickIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vThreshStart</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main function that decide the next ingredient the packing will try to</span>
<span class="sd">        drop. The picking is weighted or random</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Graham here: Walk through -priorities first</span>
                <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># prob = uniform(vRangeStart,1.0)  #Graham 9/21/11 This is wrong...vRangeStart is the point index, need active list i.e. thresholdPriority to be limited</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">ingrInd</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">threshProb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prob</span> <span class="o">&lt;=</span> <span class="n">threshProb</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">ingrInd</span> <span class="o">=</span> <span class="n">ingrInd</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">ingrInd</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">):</span>
                    <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="n">ingrInd</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error in Environment pick Ingredient&quot;</span><span class="p">,</span> <span class="n">ingrInd</span><span class="p">)</span>
                    <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;weighted&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">vThreshStart</span><span class="p">,</span> <span class="n">ingrInd</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span>  <span class="c1"># randint(0, len(self.activeIngr)-1)#random()</span>
            <span class="c1"># n=int(r*(len(self.activeIngr)-1))</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">))</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="c1">#            print (r,n,ingr.name,len(self.activeIngr)) #Graham turned back on 5/16/12, but may be costly</span>
        <span class="k">return</span> <span class="n">ingr</span></div>

<div class="viewcode-block" id="Environment.get_dpad"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_dpad">[docs]</a>    <span class="k">def</span> <span class="nf">get_dpad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compNum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the largest encapsulating_radius and use it for padding&quot;&quot;&quot;</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># cytoplasm -&gt; use cyto and all surfaces</span>
            <span class="k">for</span> <span class="n">ingr1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">encapsulating_radius</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">mr</span><span class="p">:</span>
                        <span class="n">mr</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="n">compNum</span> <span class="ow">or</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="o">-</span><span class="n">compNum</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">encapsulating_radius</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">mr</span><span class="p">:</span>
                        <span class="n">mr</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">mr</span></div>

<div class="viewcode-block" id="Environment.getPointToDrop"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getPointToDrop">[docs]</a>    <span class="k">def</span> <span class="nf">getPointToDrop</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ingr</span><span class="p">,</span>
        <span class="n">free_points</span><span class="p">,</span>
        <span class="n">nbFreePoints</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">,</span>
        <span class="n">spacing</span><span class="p">,</span>
        <span class="n">compId</span><span class="p">,</span>
        <span class="n">vRangeStart</span><span class="p">,</span>
        <span class="n">vThreshStart</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decide next point to use for dropping a given ingredent. The picking can be</span>
<span class="sd">        random, based on closest distance, based on gradients, ordered.</span>
<span class="sd">        This function also update the available free point except when hack is on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allIngrPts</span><span class="p">,</span> <span class="n">allIngrDist</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">get_list_of_free_indices</span><span class="p">(</span>
            <span class="n">distance</span><span class="p">,</span>
            <span class="n">free_points</span><span class="p">,</span>
            <span class="n">nbFreePoints</span><span class="p">,</span>
            <span class="n">spacing</span><span class="p">,</span>
            <span class="n">compId</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freePtsUpdateThreshold</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
            <span class="c1"># if ind == 0:</span>
            <span class="n">vRangeStart</span> <span class="o">=</span> <span class="n">vRangeStart</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># j = 0</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="c1"># Start of massive overruling section from corrected thesis file of Sept. 25, 2012</span>
            <span class="c1"># this function also depend on the ingr.completiion that can be restored ?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getSortedActiveIngredients</span><span class="p">,</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No point left for ingredient </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(allIngredients </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(self.activeIngr0) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(self.activeIngr12) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">activeIngre_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0.00001</span>
            <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">+</span> <span class="n">pp</span>
            <span class="n">previousThresh</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Graham- Once negatives are used, if picked random#</span>
            <span class="c1"># is below a number in this list, that item becomes</span>
            <span class="c1"># the active ingredient in the while loop below</span>
            <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
                <span class="c1"># pp1 = 0</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">np</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">np</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;np is &quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="s2">&quot; pp is &quot;</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="s2">&quot; tp is &quot;</span><span class="p">,</span> <span class="n">np</span> <span class="o">+</span> <span class="n">previousThresh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="n">previousThresh</span><span class="p">)</span>
                <span class="n">previousThresh</span> <span class="o">=</span> <span class="n">np</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">previousThresh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;time to reject the picking </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vRangeStart</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickRandPt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;picking random point&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">packing_mode</span> <span class="o">==</span> <span class="s2">&quot;close&quot;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">allIngrDist</span><span class="p">)</span>
                <span class="c1"># pick point with closest distance</span>
                <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                    <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ptIndr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">))</span>
                    <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="n">ptIndr</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">ingr</span><span class="o">.</span><span class="n">packing_mode</span> <span class="o">==</span> <span class="s2">&quot;gradient&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gradient</span><span class="p">:</span>
                <span class="c1"># get the most probable point using the gradient</span>
                <span class="c1"># use the gradient weighted map and get mot probabl point</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pick point from gradients </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">)))</span>
                <span class="n">ptInd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">gradient</span><span class="p">]</span><span class="o">.</span><span class="n">pickPoint</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># pick a point randomly among free points</span>
                <span class="c1"># random or uniform?</span>
                <span class="n">ptIndr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">))</span>
                <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="n">ptIndr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ptInd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No point left for ingredient </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                <span class="c1"># if ind == 0:</span>
                <span class="n">vRangeStart</span> <span class="o">=</span> <span class="n">vRangeStart</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># j = 0</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;popping this gradient ingredient array must be redone using Sept 25, 2011 thesis version as above for nongraient ingredients, TODO: July 5, 2012&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;time to reject the picking&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;vRangeStart&quot;</span><span class="p">,</span> <span class="n">vRangeStart</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vRangeStart</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sorting index&quot;</span><span class="p">)</span>
            <span class="n">allIngrPts</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ptInd</span></div>

<div class="viewcode-block" id="Environment.removeOnePoint"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.removeOnePoint">[docs]</a>    <span class="k">def</span> <span class="nf">removeOnePoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">free_points</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># New system replaced by Graham on Aug 18, 2012</span>
            <span class="n">nbFreePoints</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">vKill</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
            <span class="n">vLastFree</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[</span><span class="n">nbFreePoints</span><span class="p">]</span>
            <span class="n">free_points</span><span class="p">[</span><span class="n">vKill</span><span class="p">]</span> <span class="o">=</span> <span class="n">vLastFree</span>
            <span class="n">free_points</span><span class="p">[</span><span class="n">vLastFree</span><span class="p">]</span> <span class="o">=</span> <span class="n">vKill</span>
            <span class="c1"># End New replaced by Graham on Aug 18, 2012</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">nbFreePoints</span></div>

<div class="viewcode-block" id="Environment.getTotalNbObject"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getTotalNbObject">[docs]</a>    <span class="k">def</span> <span class="nf">getTotalNbObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allIngredients</span><span class="p">,</span> <span class="n">update_partner</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">totalNbIngr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">allIngredients</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                <span class="n">totalNbIngr</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span> <span class="o">*</span> <span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">ingr</span><span class="o">.</span><span class="n">unit_length</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">totalNbIngr</span> <span class="o">+=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span>
            <span class="k">if</span> <span class="n">update_partner</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_partners_ingredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">totalNbIngr</span></div>

<div class="viewcode-block" id="Environment.prep_molecules_for_save"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.prep_molecules_for_save">[docs]</a>    <span class="k">def</span> <span class="nf">prep_molecules_for_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">free_points</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distancesAfterFill</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freePointsAfterFill</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbFreePointsAfterFill</span> <span class="o">=</span> <span class="n">nbFreePoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distanceAfterFill</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runTimeDisplay</span> <span class="ow">and</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;simularium&quot;</span><span class="p">:</span>
            <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">writeToFile</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;./realtime&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span> <span class="s2">&quot;vi&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">progressBar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filling Complete&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">resetProgressBar</span><span class="p">()</span>
        <span class="n">ingredients</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_ingr_as_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ingredients</span><span class="p">:</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ingr</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="n">ingredients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">ingredients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
            <span class="n">ingredients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">compartment</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">ingredients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ingr</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
                <span class="n">all_ingr_as_array</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ingr_result</span> <span class="o">=</span> <span class="n">ingredients</span>
        <span class="k">return</span> <span class="n">all_ingr_as_array</span></div>

<div class="viewcode-block" id="Environment.pack_grid"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.pack_grid">[docs]</a>    <span class="k">def</span> <span class="nf">pack_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">seedNum</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vTestid</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">vAnalysis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ## Fill the grid by picking an ingredient first and then</span>
<span class="sd">        ## find a suitable point using the ingredient&#39;s placer object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set periodicity</span>
        <span class="n">autopack</span><span class="o">.</span><span class="n">testPeriodicity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_periodicity</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeUpDistLoopTotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no grid setup&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># create a list of active ingredients indices in all recipes to allow</span>
        <span class="c1"># removing inactive ingredients when molarity is reached</span>
        <span class="n">allIngredients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getActiveIng</span><span class="p">)</span>
        <span class="c1"># verify partner</span>

        <span class="n">usePP</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;usePP&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">usePP</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;usePP&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cFill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nFill</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FillName</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># seed random number generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSeed</span><span class="p">(</span><span class="n">seedNum</span><span class="p">)</span>
        <span class="c1"># create copies of the distance array as they change when molecules</span>
        <span class="c1"># are added, this array can be restored/saved before filling</span>
        <span class="n">free_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_points</span><span class="p">)</span>  <span class="c1"># -1</span>
        <span class="k">if</span> <span class="s2">&quot;fbox&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fbox</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;fbox&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">EnviroOnly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freePointMask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
            <span class="n">bb_insidepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getPointsInCube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fbox</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)[:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freePointMask</span><span class="p">[</span><span class="n">bb_insidepoint</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bb_outside</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freePointMask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span><span class="p">[</span><span class="n">bb_outside</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99999</span>
        <span class="n">compartment_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span>
        <span class="c1"># why a copy? --&gt; can we split ?</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[:]</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span>

        <span class="c1"># DEBUG stuff, should be removed later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jitterVectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jitterLength</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totnbJitter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxColl</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">successfullJitter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failedJitter</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># this function also depend on the ingr.completiion that can be restored ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getSortedActiveIngredients</span><span class="p">,</span> <span class="p">([</span><span class="n">allIngredients</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(allIngredients </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">allIngredients</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(self.activeIngr0) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(self.activeIngr12) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngre_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0.00001</span>
        <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">+</span> <span class="n">pp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;totalPriorities = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span><span class="p">)</span>
        <span class="n">previousThresh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Graham- Once negatives are used, if picked random#</span>
        <span class="c1"># is below a number in this list, that item becomes</span>
        <span class="c1"># the active ingredient in the while loop below</span>
        <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>  <span class="c1"># why ?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
            <span class="c1"># pp1 = 0</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">np</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">np</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="n">previousThresh</span><span class="p">)</span>
            <span class="n">previousThresh</span> <span class="o">=</span> <span class="n">np</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">previousThresh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span>

        <span class="n">nls</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">totalNumMols</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totalNbIngr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTotalNbObject</span><span class="p">(</span><span class="n">allIngredients</span><span class="p">,</span> <span class="n">update_partner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">allIngredients</span><span class="p">:</span>
                <span class="n">totalNumMols</span> <span class="o">+=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;totalNumMols pack_grid if = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">totalNumMols</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threshProb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">:</span>
                <span class="n">nameMe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="n">nls</span><span class="p">]</span>
                <span class="n">totalNumMols</span> <span class="o">+=</span> <span class="n">nameMe</span><span class="o">.</span><span class="n">left_to_place</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;threshprop pack_grid else is </span><span class="si">%f</span><span class="s2"> for ingredient: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">threshProb</span><span class="p">,</span>
                    <span class="n">nameMe</span><span class="p">,</span>
                    <span class="n">nameMe</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">nameMe</span><span class="o">.</span><span class="n">left_to_place</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;totalNumMols pack_grid else = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">totalNumMols</span><span class="p">)</span>
                <span class="n">nls</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">vRangeStart</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tCancelPrev</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">ptInd</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">PlacedMols</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vThreshStart</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Added back by Graham on July 5, 2012 from Sept 25, 2011 thesis version</span>

        <span class="c1"># if bullet build the organel rbnode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_method</span> <span class="o">==</span> <span class="s2">&quot;pandaBullet&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setupPanda</span><span class="p">()</span>

        <span class="c1"># ==============================================================================</span>
        <span class="c1">#         #the big loop</span>
        <span class="c1"># ==============================================================================</span>
        <span class="n">dump_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_freq</span>  <span class="c1"># 120.0#every minute</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">nbFreePoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;.........At start of while loop, with vRangeStart = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vRangeStart</span>
            <span class="p">)</span>

            <span class="c1"># breakin test</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;exit packing loop because of len****&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;afviewer&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span> <span class="s2">&quot;vi&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">resetProgressBar</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">progressBar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filling Complete&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">vRangeStart</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exit packing loop because vRange and hence Done!!!****&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancelDialog</span><span class="p">:</span>
                <span class="n">tCancel</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tCancel</span> <span class="o">-</span> <span class="n">tCancelPrev</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="p">:</span>
                    <span class="n">cancel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayCancelDialog</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cancel</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;canceled by user: we&#39;ll fill with current objects up to time </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E510</span>
                            <span class="n">tCancel</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                    <span class="c1"># if OK, do nothing, i.e., continue loop</span>
                    <span class="c1"># (but not the function continue)</span>
                    <span class="n">tCancelPrev</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># pick an ingredient</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickIngredient</span><span class="p">(</span><span class="n">vThreshStart</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;afviewer&quot;</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">PlacedMols</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">totalNumMols</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>  <span class="c1"># This code shows 100% of ingredients all the time</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span> <span class="s2">&quot;vi&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">progressBar</span><span class="p">(</span>
                        <span class="n">progress</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">completion</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">renderDistance</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">displayParticleVolumeDistance</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="n">current_ingr_compartment</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span>
            <span class="c1"># compute dpad which is the distance at which we need to update</span>
            <span class="c1"># distances after the drop is successfull</span>
            <span class="n">max_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dpad</span><span class="p">(</span><span class="n">current_ingr_compartment</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;picked Ingr radius </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">min_radius</span><span class="si">}</span><span class="s2">, compNum </span><span class="si">{</span><span class="n">current_ingr_compartment</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># find the points that can be used for this ingredient</span>
            <span class="c1">##</span>

            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">surface_points</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfacePoints</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">surface_points</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">surface_points</span><span class="p">))]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPointToDrop</span><span class="p">(</span>
                    <span class="n">ingr</span><span class="p">,</span>
                    <span class="n">free_points</span><span class="p">,</span>
                    <span class="n">nbFreePoints</span><span class="p">,</span>
                    <span class="n">distances</span><span class="p">,</span>
                    <span class="n">spacing</span><span class="p">,</span>
                    <span class="n">compartment_ids</span><span class="p">,</span>
                    <span class="n">vRangeStart</span><span class="p">,</span>
                    <span class="n">vThreshStart</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># (Bool, ptInd)</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ptInd</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ptInd</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;point index outside of grid length, should never be true &quot;</span><span class="p">,</span>
                        <span class="n">ptInd</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;vRangeStart coninue &quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
                <span class="n">vRangeStart</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="c1"># NOTE: should we do the close partner check here instead of in the place functions?</span>
            <span class="c1"># place the ingredient</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_place_method</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">place_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_method</span>

            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;attempting to place near </span><span class="si">%d</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">ptInd</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">ptInd</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">collision_possible</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># if distances[ptInd] &gt;= ingr.encapsulating_radius + ingr.getMaxJitter(</span>
            <span class="c1">#     spacing</span>
            <span class="c1"># ):</span>
            <span class="c1">#     # there is no possible collision here</span>
            <span class="c1">#     collision_possible = False</span>
            <span class="p">(</span>
                <span class="n">success</span><span class="p">,</span>
                <span class="n">insidePoints</span><span class="p">,</span>
                <span class="n">newDistPoints</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">attempt_to_pack_at_grid_location</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">usePP</span><span class="p">,</span> <span class="n">collision_possible</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;after place attempt, placed: </span><span class="si">%r</span><span class="s2">, number of free points:</span><span class="si">%d</span><span class="s2">, length of free points=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">success</span><span class="p">,</span>
                <span class="n">nbFreePoints</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">free_points</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">BaseGrid</span><span class="o">.</span><span class="n">updateDistances</span><span class="p">(</span>
                    <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span><span class="p">,</span> <span class="n">free_points</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">distances</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances</span><span class="p">[:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">free_points</span><span class="p">[:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">nbFreePoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_points</span><span class="p">)</span>  <span class="c1"># -1</span>
                <span class="c1"># update largest protein size</span>
                <span class="c1"># problem when the encapsulating_radius is actually wrong</span>
                <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span>
                <span class="n">PlacedMols</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rejected </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;completed*************** </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PlacedMols = </span><span class="si">{</span><span class="n">PlacedMols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;activeIngr index of </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;threshold p len </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># j = 0</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">)</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span>
                        <span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">getSortedActiveIngredients</span><span class="p">,</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len(self.activeIngr0) </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len(self.activeIngr12) </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngre_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[:]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0.00001</span>
                <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
                    <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">+</span> <span class="n">pp</span>
                <span class="c1">#                    print (&#39;totalPriorities = &#39;, self.totalPriorities)</span>
                <span class="n">previousThresh</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># Graham- Once negatives are used, if picked random#</span>
                <span class="c1"># is below a number in this list, that item becomes</span>
                <span class="c1"># the active ingredient in the while loop below</span>
                <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
                    <span class="c1"># pp1 = 0</span>
                    <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">np</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">np</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">)</span>
                    <span class="c1">#                    print (&#39;np is &#39;, np, &#39; pp is &#39;, pp, &#39; tp is &#39;, np + previousThresh)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="n">previousThresh</span><span class="p">)</span>
                    <span class="n">previousThresh</span> <span class="o">=</span> <span class="n">np</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">previousThresh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span>
            <span class="k">if</span> <span class="n">dump</span> <span class="ow">and</span> <span class="p">((</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">stime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dump_freq</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SAVING&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span><span class="p">)</span>
                <span class="n">all_ingr_as_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_molecules_for_save</span><span class="p">(</span>
                    <span class="n">distances</span><span class="p">,</span>
                    <span class="n">free_points</span><span class="p">,</span>
                    <span class="n">nbFreePoints</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;placed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveResult</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_result</span><span class="p">(</span>
                        <span class="n">free_points</span><span class="p">,</span>
                        <span class="n">distances</span><span class="o">=</span><span class="n">distances</span><span class="p">,</span>
                        <span class="n">t0</span><span class="o">=</span><span class="n">stime</span><span class="p">,</span>
                        <span class="n">vAnalysis</span><span class="o">=</span><span class="n">vAnalysis</span><span class="p">,</span>
                        <span class="n">vTestid</span><span class="o">=</span><span class="n">vTestid</span><span class="p">,</span>
                        <span class="n">seedNum</span><span class="o">=</span><span class="n">seedNum</span><span class="p">,</span>
                        <span class="n">all_ingr_as_array</span><span class="o">=</span><span class="n">all_ingr_as_array</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;time to fill </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">all_ingr_as_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_molecules_for_save</span><span class="p">(</span>
            <span class="n">distances</span><span class="p">,</span> <span class="n">free_points</span><span class="p">,</span> <span class="n">nbFreePoints</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;placed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveResult</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_result</span><span class="p">(</span>
                <span class="n">free_points</span><span class="p">,</span>
                <span class="n">distances</span><span class="o">=</span><span class="n">distances</span><span class="p">,</span>
                <span class="n">t0</span><span class="o">=</span><span class="n">time</span><span class="p">(),</span>
                <span class="n">vAnalysis</span><span class="o">=</span><span class="n">vAnalysis</span><span class="p">,</span>
                <span class="n">vTestid</span><span class="o">=</span><span class="n">vTestid</span><span class="p">,</span>
                <span class="n">seedNum</span><span class="o">=</span><span class="n">seedNum</span><span class="p">,</span>
                <span class="n">all_ingr_as_array</span><span class="o">=</span><span class="n">all_ingr_as_array</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Environment.displayCancelDialog"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.displayCancelDialog">[docs]</a>    <span class="k">def</span> <span class="nf">displayCancelDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Popup CancelBox: if Cancel Box is up for more than 10 sec, close box and continue loop from here&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Environment.restore_molecules_array"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.restore_molecules_array">[docs]</a>    <span class="k">def</span> <span class="nf">restore_molecules_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ingr</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ingr</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span></div>

<div class="viewcode-block" id="Environment.restore"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">orgaresult</span><span class="p">,</span> <span class="n">freePoint</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># should we used the grid ? the freePoint can be computed</span>
        <span class="c1"># result is [pos,rot,ingr.name,ingr.compNum,ptInd]</span>
        <span class="c1"># orgaresult is [[pos,rot,ingr.name,ingr.compNum,ptInd],[pos,rot,ingr.name,ingr.compNum,ptInd]...]</span>
        <span class="c1"># after restore we can build the grid and fill!</span>
        <span class="c1"># ingredient based dictionary</span>
        <span class="n">ingredients</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">compNum</span><span class="p">,</span> <span class="n">ptInd</span> <span class="o">=</span> <span class="n">elem</span>
            <span class="c1"># needto check the name if it got the comp rule</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">compNum</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">),</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ingr</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
                <span class="n">mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">))</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rTrans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rRot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">))</span>  <span class="c1"># rotMatj</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rIngr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">molecules</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">molecules</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orgaresult</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
                <span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">orgaresult</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">compNum</span><span class="p">,</span> <span class="n">ptInd</span> <span class="o">=</span> <span class="n">elem</span>
                    <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">compNum</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">),</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ingredients</span><span class="p">:</span>
                            <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ingr</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>
                        <span class="n">mat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
                        <span class="n">mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
                        <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                        <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">))</span>
                        <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rTrans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rRot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">))</span>  <span class="c1"># rotMatj</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rIngr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">])</span>
                <span class="n">o</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">molecules</span>
        <span class="c1"># consider that one filling have occured</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rTrans</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tree</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rTrans</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cFill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ingr_result</span> <span class="o">=</span> <span class="n">ingredients</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freePoint</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restoreFreePoints</span><span class="p">(</span><span class="n">freePoint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ingredients</span></div>

<div class="viewcode-block" id="Environment.restoreFreePoints"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.restoreFreePoints">[docs]</a>    <span class="k">def</span> <span class="nf">restoreFreePoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freePoint</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freePointsAfterFill</span> <span class="o">=</span> <span class="n">freePoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbFreePointsAfterFill</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freePoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distanceAfterFill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distancesAfterFill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span></div>

<div class="viewcode-block" id="Environment.loadFreePoint"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.loadFreePoint">[docs]</a>    <span class="k">def</span> <span class="nf">loadFreePoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="p">):</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="n">freePoint</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">freePoint</span></div>

<div class="viewcode-block" id="Environment.store"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="n">resultfilename</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">fixOnePath</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="c1"># pickle.dump(self.molecules, rfile)</span>
        <span class="c1"># OR</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">rfile</span><span class="p">)</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">orga</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="n">orfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;organelle&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">orga</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">orfile</span><span class="p">)</span>
            <span class="c1">#            pickle.dump(orga.molecules, orfile)</span>
            <span class="n">orfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span><span class="p">,</span> <span class="n">rfile</span><span class="p">)</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Environment.dropOneIngr"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.dropOneIngr">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">dropOneIngr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">&gt;,&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;&lt;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">&gt;,&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;&lt;</span><span class="si">%f</span><span class="s2">&gt;,&lt;</span><span class="si">%s</span><span class="s2">&gt;,&lt;</span><span class="si">%d</span><span class="s2">&gt;,&lt;</span><span class="si">%d</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span></div>

<div class="viewcode-block" id="Environment.getOneIngr"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getOneIngr">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getOneIngr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">3</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ingrname</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">4</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ingrcompNum</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">5</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ptInd</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">rad</span></div>

    <span class="c1">#    @classmethod</span>
<div class="viewcode-block" id="Environment.getOneIngrJson"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getOneIngrJson">[docs]</a>    <span class="k">def</span> <span class="nf">getOneIngrJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ingrdic</span><span class="p">):</span>
        <span class="c1">#        name_ingr = ingr.name</span>
        <span class="c1">#        if name_ingr not in ingrdic:</span>
        <span class="c1">#            name_ingr = ingr.o_name</span>
        <span class="c1">#        for r in ingr.results:</span>
        <span class="c1">#            ingrdic[name_ingr][&quot;results&quot;].append([r[0]],r[1],)</span>
        <span class="c1">#        print (&quot;growingr?&quot;,ingr,ingr.name,isinstance(ingr, GrowIngredient))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">GrowIngredient</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">ActinIngredient</span><span class="p">):</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">nbCurve</span> <span class="o">=</span> <span class="n">ingrdic</span><span class="p">[</span><span class="s2">&quot;nbCurve&quot;</span><span class="p">]</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">nbCurve</span><span class="p">):</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingrdic</span><span class="p">[</span><span class="s2">&quot;curve&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
            <span class="c1">#            print (&quot;nbCurve?&quot;,ingr.nbCurve,ingrdic[&quot;nbCurve&quot;])</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">ingrdic</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">],</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span><span class="p">,</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ingrdic[&quot;compNum&quot;],1,ingrdic[&quot;encapsulating_radius&quot;]</span></div>

<div class="viewcode-block" id="Environment.load_asTxt"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.load_asTxt">[docs]</a>    <span class="k">def</span> <span class="nf">load_asTxt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="c1"># needto parse</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">orgaresult</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># [[],]*len(self.compartments)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)):</span>
            <span class="n">orgaresult</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="c1">#        mry90 = helper.rotation_matrix(-math.pi/2.0, [0.0,1.0,0.0])</span>
        <span class="c1">#        numpy.array([[0.0, 1.0, 0.0, 0.0],</span>
        <span class="c1">#                 [-1., 0.0, 0.0, 0.0],</span>
        <span class="c1">#                 [0.0, 0.0, 1.0, 0.0],</span>
        <span class="c1">#                 [0.0, 0.0, 0.0, 1.0]])</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOneIngr</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="c1"># should I multiply here</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
            <span class="p">)</span>  <span class="c1"># numpy.matrix(mry90)*numpy.matrix(numpy.array(rot).reshape(4,4))</span>
            <span class="k">if</span> <span class="n">ingrcompNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orgaresult</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ingrcompNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="c1">#        for i, orga in enumerate(self.compartments):</span>
            <span class="c1">#            orfile = open(resultfilename+&quot;ogra&quot;+str(i),&#39;rb&#39;)</span>
            <span class="c1">#            orgaresult.append(pickle.load(orfile))</span>
            <span class="c1">#            orfile.close()</span>
            <span class="c1">#        rfile.close()</span>
            <span class="c1">#        rfile = open(resultfilename+&quot;free_points&quot;,&#39;rb&#39;)</span>
        <span class="n">freePoint</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># pickle.load(rfile)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">freePoint</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
            <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">orgaresult</span><span class="p">,</span> <span class="n">freePoint</span></div>

<div class="viewcode-block" id="Environment.collectResultPerIngredient"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.collectResultPerIngredient">[docs]</a>    <span class="k">def</span> <span class="nf">collectResultPerIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">ingr</span><span class="p">):</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loopThroughIngr</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">GrowIngredient</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">ActinIngredient</span><span class="p">):</span>
                <span class="k">pass</span>  <span class="c1"># already store</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">orga</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">orga</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">GrowIngredient</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">ingr</span><span class="p">,</span> <span class="n">ActinIngredient</span>
                <span class="p">):</span>
                    <span class="k">pass</span>  <span class="c1"># already store</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">])</span></div>

<div class="viewcode-block" id="Environment.load_asJson"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.load_asJson">[docs]</a>    <span class="k">def</span> <span class="nf">load_asJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>  <span class="c1"># doesnt work with symbol link ?</span>
            <span class="k">if</span> <span class="n">autopack</span><span class="o">.</span><span class="n">use_json_hook</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">fp</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span>
                <span class="p">)</span>  <span class="c1"># ,indent=4, separators=(&#39;,&#39;, &#39;: &#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="c1"># needto parse</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">orgaresult</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;exteriorRecipe&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">name_ingr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">]:</span>
                        <span class="c1"># backward compatiblity</span>
                        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">]:</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                    <span class="n">iresults</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOneIngrJson</span><span class="p">(</span>
                        <span class="n">ingr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">][</span><span class="n">name_ingr</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">iresults</span><span class="p">:</span>
                        <span class="n">rot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                            <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
                        <span class="p">)</span>  <span class="c1"># numpy.matrix(mry90)*numpy.matrix(numpy.array(rot).reshape(4,4))</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">])</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># organelle ingr</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">orga</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="n">orgaresult</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="c1"># organelle surface ingr</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">rs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                        <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span>
                        <span class="c1"># replace number by name ?</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surf_&quot;</span> <span class="o">+</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surf_&quot;</span> <span class="o">+</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">name_ingr</span>
                            <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="c1"># backward compatiblity</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                                <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span>
                            <span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                        <span class="p">(</span>
                            <span class="n">iresults</span><span class="p">,</span>
                            <span class="n">ingrname</span><span class="p">,</span>
                            <span class="n">ingrcompNum</span><span class="p">,</span>
                            <span class="n">ptInd</span><span class="p">,</span>
                            <span class="n">rad</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOneIngrJson</span><span class="p">(</span>
                            <span class="n">ingr</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">][</span><span class="n">name_ingr</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">iresults</span><span class="p">:</span>
                            <span class="n">rot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
                            <span class="p">)</span>  <span class="c1"># numpy.matrix(mry90)*numpy.matrix(numpy.array(rot).reshape(4,4))</span>
                            <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">])</span>
                            <span class="n">orgaresult</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ingrcompNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="p">)</span>
            <span class="c1"># organelle matrix ingr</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">ri</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                        <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_int_&quot;</span> <span class="o">+</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_int_&quot;</span> <span class="o">+</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">name_ingr</span>
                            <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="c1"># backward compatiblity</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                                <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span>
                            <span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                        <span class="p">(</span>
                            <span class="n">iresults</span><span class="p">,</span>
                            <span class="n">ingrname</span><span class="p">,</span>
                            <span class="n">ingrcompNum</span><span class="p">,</span>
                            <span class="n">ptInd</span><span class="p">,</span>
                            <span class="n">rad</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOneIngrJson</span><span class="p">(</span>
                            <span class="n">ingr</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">][</span><span class="n">name_ingr</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">iresults</span><span class="p">:</span>
                            <span class="n">rot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
                            <span class="p">)</span>  <span class="c1"># numpy.matrix(mry90)*numpy.matrix(numpy.array(rot).reshape(4,4))</span>
                            <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">])</span>
                            <span class="n">orgaresult</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ingrcompNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="p">)</span>
        <span class="n">freePoint</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># pickle.load(rfile)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">freePoint</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
            <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">orgaresult</span><span class="p">,</span> <span class="n">freePoint</span></div>

<div class="viewcode-block" id="Environment.dropOneIngrJson"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.dropOneIngrJson">[docs]</a>    <span class="k">def</span> <span class="nf">dropOneIngrJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">rdic</span><span class="p">):</span>
        <span class="n">adic</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># [ingr.name]</span>
        <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;compNum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span>
        <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;encapsulating_radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span><span class="p">)</span>
        <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;tolist&quot;</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;tolist&quot;</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">GrowIngredient</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">ActinIngredient</span><span class="p">):</span>
            <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;nbCurve&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">nbCurve</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">nbCurve</span><span class="p">):</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;curve&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1">#        print adic</span>
        <span class="k">return</span> <span class="n">adic</span></div>

<div class="viewcode-block" id="Environment.store_asJson"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.store_asJson">[docs]</a>    <span class="k">def</span> <span class="nf">store_asJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">fixOnePath</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">)</span>  <span class="c1"># retireve?</span>
        <span class="c1"># if result file_name start with http?</span>
        <span class="k">if</span> <span class="n">resultfilename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">resultfilename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ftp&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;please provide a correct file name for the result file &quot;</span><span class="p">,</span>
                <span class="n">resultfilename</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectResultPerIngredient</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;recipe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupfile</span>  <span class="c1"># replace server?</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">][</span><span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngrJson</span><span class="p">(</span>
                    <span class="n">ingr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="c1"># compartment ingr</span>
        <span class="k">for</span> <span class="n">orga</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="c1"># compartment surface ingr</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">rs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">][</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngrJson</span><span class="p">(</span>
                        <span class="n">ingr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="c1"># compartment matrix ingr</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">ri</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">][</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">o_name</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngrJson</span><span class="p">(</span>
                        <span class="n">ingr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>  <span class="c1"># doesnt work with symbol link ?</span>
            <span class="k">if</span> <span class="n">indent</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># ,indent=4, separators=(&#39;,&#39;, &#39;: &#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># ,indent=4, separators=(&#39;,&#39;, &#39;: &#39;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok dump&quot;</span><span class="p">,</span> <span class="n">resultfilename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.store_asTxt"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.store_asTxt">[docs]</a>    <span class="k">def</span> <span class="nf">store_asTxt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="n">resultfilename</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">fixOnePath</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>  <span class="c1"># doesnt work with symbol link ?</span>
        <span class="c1"># pickle.dump(self.molecules, rfile)</span>
        <span class="c1"># OR</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;&lt;recipe include = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupfile</span> <span class="o">+</span> <span class="s2">&quot;&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngr</span><span class="p">(</span>
                <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span>
            <span class="p">)</span>
            <span class="c1"># result.append([pos,rot,ingr.name,ingr.compNum,ptInd])</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="c1"># write the curve point</span>

        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">orga</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="n">orfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_organelle_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">orga</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngr</span><span class="p">(</span>
                    <span class="n">pos</span><span class="p">,</span>
                    <span class="n">rot</span><span class="p">,</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">compNum</span><span class="p">,</span>
                    <span class="n">ptInd</span><span class="p">,</span>
                    <span class="n">rad</span><span class="o">=</span><span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">orfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="c1">#            pickle.dump(orga.molecules, orfile)</span>
            <span class="n">orfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        <span class="c1">#        rfile = open(resultfilename+&quot;free_points&quot;, &#39;w&#39;)</span>
        <span class="c1">#        pickle.dump(self.free_points, rfile)</span>
        <span class="c1">#        rfile.close()</span>

<div class="viewcode-block" id="Environment.convertPickleToText"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.convertPickleToText">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">convertPickleToText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norga</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
        <span class="n">orgaresult</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norga</span><span class="p">):</span>
            <span class="n">orfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_organelle_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">orgaresult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">orfile</span><span class="p">))</span>
            <span class="n">orfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">)</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrName</span><span class="p">,</span> <span class="n">compNum</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrName</span><span class="p">,</span> <span class="n">compNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">)</span>
            <span class="c1"># result.append([pos,rot,ingr.name,ingr.compNum,ptInd])</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norga</span><span class="p">):</span>
            <span class="n">orfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_organelle_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrName</span><span class="p">,</span> <span class="n">compNum</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">orgaresult</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrName</span><span class="p">,</span> <span class="n">compNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">)</span>
            <span class="n">orfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="c1">#            pickle.dump(orga.molecules, orfile)</span>
            <span class="n">orfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
            <span class="c1"># freepoint</span>

<div class="viewcode-block" id="Environment.printFillInfo"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.printFillInfo">[docs]</a>    <span class="k">def</span> <span class="nf">printFillInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Environment exterior recipe:&quot;</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">printFillInfo</span><span class="p">(</span><span class="s2">&quot;        &quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">printFillInfo</span><span class="p">()</span></div>

<div class="viewcode-block" id="Environment.finishWithWater"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.finishWithWater">[docs]</a>    <span class="k">def</span> <span class="nf">finishWithWater</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">free_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># self.freePointsAfterFill[:self.nbFreePointsAfterFill]</span>
        <span class="c1"># sphere sphere of 2.9A</span>
        <span class="k">if</span> <span class="n">free_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freePointsAfterFill</span>
        <span class="k">if</span> <span class="n">nbFreePoints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbFreePointsAfterFill</span></div>
        <span class="c1"># a freepoint is a voxel, how many water in the voxel</span>
        <span class="c1"># coords masterGridPositions</span>

    <span class="c1"># ==============================================================================</span>
    <span class="c1"># AFter this point, features development around physics engine and algo</span>
    <span class="c1"># octree</span>
    <span class="c1"># panda bullet</span>
    <span class="c1"># panda ode</span>
    <span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="Environment.setupOctree"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setupOctree">[docs]</a>    <span class="k">def</span> <span class="nf">setupOctree</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="o">=</span> <span class="n">Octree</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getRadius</span><span class="p">(),</span> <span class="n">helper</span><span class="o">=</span><span class="n">helper</span>
            <span class="p">)</span>  <span class="c1"># Octree((0,0,0),self.grid.getRadius())   #0,0,0 or center of grid?</span></div>

<div class="viewcode-block" id="Environment.setupPanda"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setupPanda">[docs]</a>    <span class="k">def</span> <span class="nf">setupPanda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">panda3d</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">panda3d.core</span> <span class="kn">import</span> <span class="n">loadPrcFileData</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loadPrcFileData</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;bullet-sap-extents &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">diag</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># grid may not be setup</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">panda3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">loadPrcFileData</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   load-display p3tinydisplay # to force CPU only rendering (to make it available as an option if everything else fail, use aux-display p3tinydisplay)</span>
<span class="sd">   audio-library-name null # Prevent ALSA errors</span>
<span class="sd">   show-frame-rate-meter 0</span>
<span class="sd">   sync-video 0</span>
<span class="sd">   bullet-max-objects 10240</span>
<span class="sd">   bullet-broadphase-algorithm sap</span>
<span class="sd">   bullet-sap-extents 10000.0</span>
<span class="sd">   textures-power-2 up</span>
<span class="sd">   textures-auto-power-2 #t</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1">#            loadPrcFileData(&quot;&quot;, &quot;window-type none&quot; )</span>
            <span class="c1"># Make sure we don&#39;t need a graphics engine</span>
            <span class="c1"># (Will also prevent X errors / Display errors when starting on linux without X server)</span>
            <span class="c1">#            loadPrcFileData(&quot;&quot;, &quot;audio-library-name null&quot; ) # Prevent ALSA errors</span>
            <span class="c1">#            loadPrcFileData(&#39;&#39;, &#39;bullet-enable-contact-events true&#39;)</span>
            <span class="c1">#            loadPrcFileData(&#39;&#39;, &#39;bullet-max-objects 10240&#39;)#10240</span>
            <span class="c1">#            loadPrcFileData(&#39;&#39;, &#39;bullet-broadphase-algorithm sap&#39;)#aabb</span>
            <span class="c1">#            loadPrcFileData(&#39;&#39;, &#39;bullet-sap-extents 10000.0&#39;)#</span>
            <span class="k">if</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">nogui</span><span class="p">:</span>
                <span class="n">loadPrcFileData</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;window-type offscreen&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loadPrcFileData</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;window-type None&quot;</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">direct.showbase.ShowBase</span> <span class="kn">import</span> <span class="n">ShowBase</span>

            <span class="n">base</span> <span class="o">=</span> <span class="n">ShowBase</span><span class="p">()</span>
            <span class="n">base</span><span class="o">.</span><span class="n">disableMouse</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span>
            <span class="kn">from</span> <span class="nn">panda3d.core</span> <span class="kn">import</span> <span class="n">Vec3</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;bullet&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">panda3d.bullet</span> <span class="kn">import</span> <span class="n">BulletWorld</span>

                <span class="c1"># global variable from panda3d</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worldNP</span> <span class="o">=</span> <span class="n">render</span><span class="o">.</span><span class="n">attachNewNode</span><span class="p">(</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>  <span class="c1"># noqa: F821</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">BulletWorld</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BitMask32</span> <span class="o">=</span> <span class="n">BitMask32</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;ode&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">panda3d.ode</span> <span class="kn">import</span> <span class="n">OdeWorld</span><span class="p">,</span> <span class="n">OdeHashSpace</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">OdeWorld</span><span class="p">()</span>
                <span class="c1"># or hashspace ?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ode_space</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">OdeHashSpace</span><span class="p">()</span>
                <span class="p">)</span>  <span class="c1"># OdeQuadTreeSpace(center,extends,depth)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ode_space</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ode_space</span><span class="o">.</span><span class="n">setAutoCollideWorld</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">setGravity</span><span class="p">(</span><span class="n">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moving</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rb_panda</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compartment</span><span class="o">.</span><span class="n">rbnode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">compartment</span><span class="o">.</span><span class="n">rbnode</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">addShapeRB</span><span class="p">(</span>
                    <span class="bp">self</span>
                <span class="p">)</span>  <span class="c1"># addMeshRBOrganelle(o)</span></div>

<div class="viewcode-block" id="Environment.add_rb_node"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.add_rb_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_rb_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Mesh&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ingr</span><span class="o">.</span><span class="n">add_rb_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worldNP</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;ode&quot;</span> <span class="ow">and</span> <span class="n">ingr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Sphere&quot;</span><span class="p">:</span>
            <span class="n">mat3x3</span> <span class="o">=</span> <span class="n">Mat3</span><span class="p">(</span>
                <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">ingr</span><span class="o">.</span><span class="n">add_rb_node_ode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">mat3x3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ingr</span><span class="o">.</span><span class="n">add_rb_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worldNP</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.delRB"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.delRB">[docs]</a>    <span class="k">def</span> <span class="nf">delRB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">panda3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;bullet&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">removeRigidBody</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">np</span> <span class="o">=</span> <span class="n">NodePath</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">removeNode</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;ode&quot;</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_panda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rb_panda</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rb_panda</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">static</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">moving</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moving</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Environment.setGeomFaces"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setGeomFaces">[docs]</a>    <span class="k">def</span> <span class="nf">setGeomFaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tris</span><span class="p">,</span> <span class="n">face</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">panda3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
            <span class="c1"># have to add vertices one by one since they are not in order</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">face</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">face</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">face</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">face</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">face</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">face</span><span class="p">:</span>
            <span class="n">tris</span><span class="o">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">tris</span><span class="o">.</span><span class="n">closePrimitive</span><span class="p">()</span></div>

<div class="viewcode-block" id="Environment.addMeshRBOrganelle"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.addMeshRBOrganelle">[docs]</a>    <span class="k">def</span> <span class="nf">addMeshRBOrganelle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">panda3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">helper</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">nogui</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">gname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">gname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Mesh&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">gname</span><span class="p">)</span>
            <span class="n">faces</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">vnormals</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
                <span class="n">geom</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">faces</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">faces</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">vertices</span>
        <span class="n">inodenp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worldNP</span><span class="o">.</span><span class="n">attachNewNode</span><span class="p">(</span><span class="n">BulletRigidBodyNode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span><span class="o">.</span><span class="n">setMass</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">panda3d.core</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">GeomVertexFormat</span><span class="p">,</span>
            <span class="n">GeomVertexWriter</span><span class="p">,</span>
            <span class="n">GeomVertexData</span><span class="p">,</span>
            <span class="n">Geom</span><span class="p">,</span>
            <span class="n">GeomTriangles</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">panda3d.bullet</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">BulletTriangleMesh</span><span class="p">,</span>
            <span class="n">BulletTriangleMeshShape</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># step 1) create GeomVertexData and add vertex information</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="n">GeomVertexFormat</span><span class="o">.</span><span class="n">getV3</span><span class="p">()</span>
        <span class="n">vdata</span> <span class="o">=</span> <span class="n">GeomVertexData</span><span class="p">(</span><span class="s2">&quot;vertices&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">Geom</span><span class="o">.</span><span class="n">UHStatic</span><span class="p">)</span>
        <span class="n">vertexWriter</span> <span class="o">=</span> <span class="n">GeomVertexWriter</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span> <span class="s2">&quot;vertex&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">vertexWriter</span><span class="o">.</span><span class="n">addData3f</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">]</span>

        <span class="c1"># step 2) make primitives and assign vertices to them</span>
        <span class="n">tris</span> <span class="o">=</span> <span class="n">GeomTriangles</span><span class="p">(</span><span class="n">Geom</span><span class="o">.</span><span class="n">UHStatic</span><span class="p">)</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setGeomFaces</span><span class="p">(</span><span class="n">tris</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">]</span>

        <span class="c1"># step 3) make a Geom object to hold the primitives</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">Geom</span><span class="p">(</span><span class="n">vdata</span><span class="p">)</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">addPrimitive</span><span class="p">(</span><span class="n">tris</span><span class="p">)</span>
        <span class="c1"># step 4) create the bullet mesh and node</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">BulletTriangleMesh</span><span class="p">()</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">addGeom</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">BulletTriangleMeshShape</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># BulletConvexHullShape</span>
        <span class="c1"># or</span>
        <span class="c1"># shape = BulletConvexHullShape()</span>
        <span class="c1"># shape.add_geom(geom)</span>
        <span class="c1"># inodenp = self.worldNP.attachNewNode(BulletRigidBodyNode(ingr.name))</span>
        <span class="c1"># inodenp.node().setMass(1.0)</span>
        <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span><span class="o">.</span><span class="n">addShape</span><span class="p">(</span>
            <span class="n">shape</span>
        <span class="p">)</span>  <span class="c1"># ,TransformState.makePos(Point3(0, 0, 0)))#, pMat)#TransformState.makePos(Point3(jtrans[0],jtrans[1],jtrans[2])))#rotation ?</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;bullet&quot;</span><span class="p">:</span>
            <span class="n">inodenp</span><span class="o">.</span><span class="n">setCollideMask</span><span class="p">(</span><span class="n">BitMask32</span><span class="o">.</span><span class="n">allOn</span><span class="p">())</span>
            <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span><span class="o">.</span><span class="n">setAngularDamping</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span><span class="o">.</span><span class="n">setLinearDamping</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="c1">#            inodenp.setMat(pmat)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">attachRigidBody</span><span class="p">(</span><span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">())</span>
            <span class="n">inodenp</span> <span class="o">=</span> <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inodenp</span></div>

<div class="viewcode-block" id="Environment.addRB"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.addRB">[docs]</a>    <span class="k">def</span> <span class="nf">addRB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s2">&quot;single_sphere&quot;</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Sphere</span>
        <span class="k">if</span> <span class="n">panda3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">rotMat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#        mat[:3, 3] = trans</span>
        <span class="c1">#        mat = mat.transpose()</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">16</span><span class="p">,))</span>

        <span class="n">pmat</span> <span class="o">=</span> <span class="n">Mat4</span><span class="p">(</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
            <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">trans</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">inodenp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">inodenp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_rb_node</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;bullet&quot;</span><span class="p">:</span>
            <span class="n">inodenp</span><span class="o">.</span><span class="n">setCollideMask</span><span class="p">(</span><span class="n">BitMask32</span><span class="o">.</span><span class="n">allOn</span><span class="p">())</span>
            <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span><span class="o">.</span><span class="n">setAngularDamping</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span><span class="o">.</span><span class="n">setLinearDamping</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">inodenp</span><span class="o">.</span><span class="n">setMat</span><span class="p">(</span><span class="n">pmat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">attachRigidBody</span><span class="p">(</span><span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">())</span>
            <span class="n">inodenp</span> <span class="o">=</span> <span class="n">inodenp</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;ode&quot;</span><span class="p">:</span>
            <span class="n">inodenp</span><span class="o">.</span><span class="n">setCollideBits</span><span class="p">(</span><span class="n">BitMask32</span><span class="p">(</span><span class="mh">0x00000002</span><span class="p">))</span>
            <span class="n">inodenp</span><span class="o">.</span><span class="n">setCategoryBits</span><span class="p">(</span><span class="n">BitMask32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">))</span>
            <span class="c1"># boxGeom.setBody(boxBody)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rb_panda</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inodenp</span><span class="p">)</span>
        <span class="c1"># self.moveRBnode(inodenp.node(), trans, rotMat)</span>
        <span class="k">return</span> <span class="n">inodenp</span></div>

<div class="viewcode-block" id="Environment.moveRBnode"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.moveRBnode">[docs]</a>    <span class="k">def</span> <span class="nf">moveRBnode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">panda3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">rotMat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#        mat[:3, 3] = trans</span>
        <span class="c1">#        mat = mat.transpose()</span>
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">16</span><span class="p">,))</span>
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;problem Matrix&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;bullet&quot;</span><span class="p">:</span>
            <span class="n">pMat</span> <span class="o">=</span> <span class="n">Mat4</span><span class="p">(</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
                <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">trans</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">nodenp</span> <span class="o">=</span> <span class="n">NodePath</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">nodenp</span><span class="o">.</span><span class="n">setMat</span><span class="p">(</span><span class="n">pMat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_solver</span> <span class="o">==</span> <span class="s2">&quot;ode&quot;</span><span class="p">:</span>
            <span class="n">mat3x3</span> <span class="o">=</span> <span class="n">Mat3</span><span class="p">(</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                <span class="n">rotation_matrix</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_body</span><span class="p">()</span>
            <span class="n">body</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="n">Vec3</span><span class="p">(</span><span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">trans</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">body</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">mat3x3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.getRotTransRB"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getRotTransRB">[docs]</a>    <span class="k">def</span> <span class="nf">getRotTransRB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">panda3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">nodenp</span> <span class="o">=</span> <span class="n">NodePath</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">nodenp</span><span class="o">.</span><span class="n">getMat</span><span class="p">()</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">rRot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">rRot</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">rTrans</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rTrans</span><span class="p">,</span> <span class="n">rRot</span></div>

<div class="viewcode-block" id="Environment.runBullet"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.runBullet">[docs]</a>    <span class="k">def</span> <span class="nf">runBullet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">simulationTimes</span><span class="p">,</span> <span class="n">runTimeDisplay</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">panda3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">simulationTimes</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1"># should do it after a jitter run</span>
            <span class="c1">#        for i in xrange(10):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">globalClock</span><span class="o">.</span><span class="n">getDt</span><span class="p">()</span>  <span class="c1"># noqa: F821, global variable from panda3d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">doPhysics</span><span class="p">(</span>
                <span class="n">dt</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">500.0</span>
            <span class="p">)</span>  <span class="c1"># world.doPhysics(dt, 10, 1.0/180.0)100, 1./500.#2, 1.0/120.0</span>
            <span class="c1"># check number of contact betwee currrent and rest ?</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">contactTestPair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">getNumContacts</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">static</span>
            <span class="p">]</span>
            <span class="n">done</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">runTimeDisplay</span><span class="p">:</span>
                <span class="c1"># move self.moving and update</span>
                <span class="n">nodenp</span> <span class="o">=</span> <span class="n">NodePath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving</span><span class="p">)</span>
                <span class="n">ma</span> <span class="o">=</span> <span class="n">nodenp</span><span class="o">.</span><span class="n">getMat</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">setObjectMatrix</span><span class="p">(</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">moving_geom</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ma</span><span class="p">),</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>  <span class="c1"># transpose ?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">simulationTimes</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span></div>

                <span class="c1"># ==============================================================================</span>
            <span class="c1">#               Export -&gt; another file ?</span>
            <span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="Environment.exportToBD_BOX"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.exportToBD_BOX">[docs]</a>    <span class="k">def</span> <span class="nf">exportToBD_BOX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bd_type</span><span class="o">=</span><span class="s2">&quot;flex&quot;</span><span class="p">):</span>
        <span class="c1"># , call the BD_BOX exporter, plugin ? better if result store somewhere.</span>
        <span class="c1"># only sphere + boudary ?</span>
        <span class="c1"># sub ATM 216 225.0000 150.0000 525.0000 25.0000 -5.0000 50.0000 0.5922 1</span>
        <span class="k">if</span> <span class="n">bd_type</span> <span class="o">==</span> <span class="s2">&quot;flex&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">bd_box</span> <span class="kn">import</span> <span class="n">flex_box</span> <span class="k">as</span> <span class="n">bd_box</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">bd_box</span> <span class="kn">import</span> <span class="n">rigid_box</span> <span class="k">as</span> <span class="n">bd_box</span>
        <span class="k">if</span> <span class="n">res_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bd</span> <span class="o">=</span> <span class="n">bd_box</span><span class="p">(</span><span class="n">res_filename</span><span class="p">,</span> <span class="n">bounding_box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">makePrmFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectResultPerIngredient</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>

        <span class="c1"># compartment ingr</span>
        <span class="k">for</span> <span class="n">orga</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="c1"># compartment surface ingr</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">rs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
            <span class="c1"># compartment matrix ingr</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">ri</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>

<div class="viewcode-block" id="Environment.exportToTEM_SIM"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.exportToTEM_SIM">[docs]</a>    <span class="k">def</span> <span class="nf">exportToTEM_SIM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">tem_sim</span> <span class="kn">import</span> <span class="n">tem_sim</span>

        <span class="k">if</span> <span class="n">res_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tem</span> <span class="o">=</span> <span class="n">tem_sim</span><span class="p">(</span><span class="n">res_filename</span><span class="p">,</span> <span class="n">bounding_box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectResultPerIngredient</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>

        <span class="c1"># compartment ingr</span>
        <span class="k">for</span> <span class="n">orga</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="c1"># compartment surface ingr</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">rs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
            <span class="c1"># compartment matrix ingr</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">ri</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>

<div class="viewcode-block" id="Environment.exportToTEM"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.exportToTEM">[docs]</a>    <span class="k">def</span> <span class="nf">exportToTEM</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># limited to 20 ingredients, call the TEM exporter plugin ?</span>
        <span class="c1"># ingredient -&gt; PDB file or mrc volume file</span>
        <span class="c1"># ingredient -&gt; coordinate.txt file</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># *0.05</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;iSutm_coordinate.txt&quot;</span>  <span class="c1"># ingrname_.txt</span>
        <span class="n">aStr</span> <span class="o">=</span> <span class="s2">&quot;# File created for TEM-simulator, version 1.3.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">aStr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; 6</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">aStr</span> <span class="o">+=</span> <span class="s2">&quot;#            x             y             z           phi         theta           psi</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
            <span class="n">aStr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0:14.4f}{1:14.4f}{2:14.4f}{3:14.4f}{4:14.4f}{5:14.4f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">aStr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.exportToReaDDy"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.exportToReaDDy">[docs]</a>    <span class="k">def</span> <span class="nf">exportToReaDDy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># wehn I will get it running ... plugin ?</span>
        <span class="k">return</span></div>

        <span class="c1"># ==============================================================================</span>

    <span class="c1">#         Animate</span>
    <span class="c1"># ==============================================================================</span>
<div class="viewcode-block" id="Environment.readTraj"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.readTraj">[docs]</a>    <span class="k">def</span> <span class="nf">readTraj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectResultPerIngredient</span><span class="p">()</span>
        <span class="n">lenIngrInstance</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">orga</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">lenIngrInstance</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orga</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>
        <span class="n">fileName</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.dcd&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">dcdTrajectory</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lenIngrInstance</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.molb&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">molbTrajectory</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lenIngrInstance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">completeMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Environment.linkTraj"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.linkTraj">[docs]</a>    <span class="k">def</span> <span class="nf">linkTraj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># link the traj usin upy for creating a new synchronized calleback?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span><span class="p">:</span>
            <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">synchronize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">applyStep</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Environment.unlinkTraj"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.unlinkTraj">[docs]</a>    <span class="k">def</span> <span class="nf">unlinkTraj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># link the traj usin upy for creating a new synchronized calleback?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span><span class="p">:</span>
            <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">unsynchronize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">applyStep</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Environment.applyStep"><a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.applyStep">[docs]</a>    <span class="k">def</span> <span class="nf">applyStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="c1"># apply the coordinate from a trajectory at step step.</span>
        <span class="c1"># correspondance ingredients instance &lt;-&gt; coordinates file</span>
        <span class="c1"># trajectory class to handle</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>
        <span class="c1"># if self.traj.traj_type==&quot;dcd&quot; or self.traj.traj_type==&quot;xyz&quot;:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">applyState_primitive_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></div></div>
        <span class="c1"># ho can we apply to parent instance the rotatiotn?</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Megan Riel-Mehan.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>