<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cellpack.autopack.Environment &#8212; cellPack 1.0.8 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=514cf933" />
    
    <script src="../../../_static/documentation_options.js?v=aec50437"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">cellPack 1.0.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../cellpack.html" >cellpack</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../autopack.html" accesskey="U">cellpack.autopack</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">cellpack.autopack.Environment</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cellpack.autopack.Environment</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">#</span>
<span class="sd"># autoPACK Authors: Graham T. Johnson, Mostafa Al-Alusi, Ludovic Autin, Michel Sanner</span>
<span class="sd">#   Based on COFFEE Script developed by Graham Johnson between 2005 and 2010</span>
<span class="sd">#   with assistance from Mostafa Al-Alusi in 2009 and periodic input</span>
<span class="sd">#   from Arthur Olson&#39;s Molecular Graphics Lab</span>
<span class="sd">#</span>
<span class="sd"># Environment.py Authors: Graham Johnson &amp; Michel Sanner with editing/enhancement</span>
<span class="sd"># from Ludovic Autin</span>
<span class="sd"># HistoVol.py became Environment.py in the Spring of 2013 to generalize the terminology</span>
<span class="sd"># away from biology</span>
<span class="sd">#</span>
<span class="sd"># Translation to Python initiated March 1, 2010 by Michel Sanner with Graham Johnson</span>
<span class="sd">#</span>
<span class="sd"># Class restructuring and organization: Michel Sanner</span>
<span class="sd">#</span>
<span class="sd"># Copyright: Graham Johnson Â©2010</span>
<span class="sd">#</span>
<span class="sd"># This file &quot;Environment.py&quot; is part of autoPACK, cellPACK.</span>
<span class="sd">#</span>
<span class="sd">#    autoPACK is free software: you can redistribute it and/or modify</span>
<span class="sd">#    it under the terms of the GNU General Public License as published by</span>
<span class="sd">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">#    (at your option) any later version.</span>
<span class="sd">#</span>
<span class="sd">#    autoPACK is distributed in the hope that it will be useful,</span>
<span class="sd">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">#    GNU General Public License for more details.</span>
<span class="sd">#</span>
<span class="sd">#    You should have received a copy of the GNU General Public License</span>
<span class="sd">#    along with autoPACK (See &quot;CopyingGNUGPL&quot; in the installation.</span>
<span class="sd">#    If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="sd">#</span>
<span class="sd">#</span>
<span class="sd">###############################################################################</span>
<span class="sd">@author: Graham Johnson, Ludovic Autin, &amp; Michel Sanner</span>

<span class="sd"># Hybrid version merged from Graham&#39;s Sept 2011 and Ludo&#39;s April 2012</span>
<span class="sd"># version on May 16, 2012</span>
<span class="sd"># Updated with final thesis HistoVol.py file from Sept 25, 2012 on July 5, 2012</span>
<span class="sd"># with correct analysis tools</span>

<span class="sd"># TODO: fix the save/restore grid</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span><span class="p">,</span> <span class="n">uniform</span><span class="p">,</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.interface_objects.packed_objects</span> <span class="kn">import</span> <span class="n">PackedObjects</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">encoder</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">cellpack.autopack</span> <span class="k">as</span> <span class="nn">autopack</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.MeshStore</span> <span class="kn">import</span> <span class="n">MeshStore</span>
<span class="kn">import</span> <span class="nn">cellpack.autopack.ingredient</span> <span class="k">as</span> <span class="nn">ingredient</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.loaders.utils</span> <span class="kn">import</span> <span class="n">create_output_dir</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cmp_to_key</span><span class="p">,</span>
    <span class="n">expand_object_using_key</span><span class="p">,</span>
    <span class="n">get_value_from_distribution</span><span class="p">,</span>
    <span class="n">get_max_value_from_distribution</span><span class="p">,</span>
    <span class="n">get_min_value_from_distribution</span><span class="p">,</span>
    <span class="n">ingredient_compare0</span><span class="p">,</span>
    <span class="n">ingredient_compare1</span><span class="p">,</span>
    <span class="n">ingredient_compare2</span><span class="p">,</span>
    <span class="n">load_object_from_pickle</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.writers</span> <span class="kn">import</span> <span class="n">Writer</span>
<span class="kn">from</span> <span class="nn">.Compartment</span> <span class="kn">import</span> <span class="n">CompartmentList</span><span class="p">,</span> <span class="n">Compartment</span>
<span class="kn">from</span> <span class="nn">.Recipe</span> <span class="kn">import</span> <span class="n">Recipe</span>
<span class="kn">from</span> <span class="nn">.ingredient</span> <span class="kn">import</span> <span class="n">GrowIngredient</span><span class="p">,</span> <span class="n">ActinIngredient</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack</span> <span class="kn">import</span> <span class="n">IOutils</span>
<span class="kn">from</span> <span class="nn">.octree</span> <span class="kn">import</span> <span class="n">Octree</span>
<span class="kn">from</span> <span class="nn">.Gradient</span> <span class="kn">import</span> <span class="n">Gradient</span>
<span class="kn">from</span> <span class="nn">.transformation</span> <span class="kn">import</span> <span class="n">signed_angle_between_vectors</span>

<span class="c1"># backward compatibility with kevin method</span>
<span class="kn">from</span> <span class="nn">cellpack.autopack.BaseGrid</span> <span class="kn">import</span> <span class="n">BaseGrid</span> <span class="k">as</span> <span class="n">BaseGrid</span>
<span class="kn">from</span> <span class="nn">.randomRot</span> <span class="kn">import</span> <span class="n">RandomRot</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="kc">None</span>


<span class="n">encoder</span><span class="o">.</span><span class="n">FLOAT_REPR</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="nb">format</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s2">&quot;.8g&quot;</span><span class="p">)</span>

<span class="c1"># set default pickle protocol to highest level</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">DEFAULT_PROTOCOL</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span>

<span class="n">SEED</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">LOG</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="Environment">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment">[docs]</a>
<span class="k">class</span> <span class="nc">Environment</span><span class="p">(</span><span class="n">CompartmentList</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Environment class</span>
<span class="sd">    ==========================</span>
<span class="sd">    This class is main class in autopack. The class handle all the setup, initialization</span>
<span class="sd">    and process of the packing. We use xml or python for the setup.</span>
<span class="sd">    A environments is made of :</span>
<span class="sd">        a grid and the gradients if any</span>
<span class="sd">        a list of compartment and their recipes (surface and interior)</span>
<span class="sd">        a exterior recipe</span>
<span class="sd">        each recipe are made of a list of ingredients</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recipe</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">CompartmentList</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span> <span class="o">=</span> <span class="n">MeshStore</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config_data</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span> <span class="o">=</span> <span class="n">recipe</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># From config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runTimeDisplay</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;live_packing&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;place_method&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">innerGridMethod</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inner_grid_method&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_output</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_periodicity</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_periodicity&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_place_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;overwrite_place_method&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickRandPt</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ordered_packing&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_sphere_trees</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;show_sphere_trees&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_grid_spheres</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;show_grid_plot&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recipe</span><span class="p">[</span><span class="s2">&quot;bounding_box&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_from_grid_file</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;load_from_grid_file&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_progress_bar</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;show_progress_bar&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">recipe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
        <span class="c1"># saving/pickle option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveResult</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span> <span class="ow">in</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_folder</span> <span class="o">=</span> <span class="n">create_output_dir</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;out&quot;</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;place_method&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">_grid.dat&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">recipe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grid_file_path&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="s2">&quot;grid_file_path&quot;</span><span class="p">]</span>

        <span class="n">should_load_grid_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_from_grid_file</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span> <span class="k">if</span> <span class="n">should_load_grid_file</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupfile</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># the path of the recipe file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_filename</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_result_filename</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># str(gridn.getAttribute(&quot;grid_result&quot;))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timeUpDistLoopTotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hgrid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ongoing octree test, no need if openvdb wrapped to python</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Grid()  # the main grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encapsulatingGrid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">0</span>  <span class="c1"># Only override this with 0 for 2D packing- otherwise its very unsafe!</span>
        <span class="p">)</span>
        <span class="c1"># 0 is the exterior, 1 is compartment 1 surface, -1 is compartment 1 interior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbCompartments</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># TODO: call this &#39;id&#39; consistent with container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># give the order of drop ingredient by ptInd from molecules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastrank</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># smallest and largest protein radii across all recipes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span> <span class="o">=</span> <span class="mi">999</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleER</span> <span class="o">=</span> <span class="mf">2.5</span>  <span class="c1"># hack in case problem with encapsulating radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computeGridParams</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">EnviroOnly</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EnviroOnlyCompartiment</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># bounding box of the Environment</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fbox_bb</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># used for estimating the volume</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fbox</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Oct 20, 2012 Graham wonders if this is part of the problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillBB</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># bounding box for a given fill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillbb_insidepoint</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>  <span class="c1"># Oct 20, 2012 Graham wonders if this is part of the problem</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freePointMask</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">randomRot</span> <span class="o">=</span> <span class="n">RandomRot</span><span class="p">()</span>  <span class="c1"># the class used to generate random rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngre_saved</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freePtsUpdateThreshold</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># optionally can provide a host and a viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># option for packing using host dynamics capability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windowsSize</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windowsSize_overwrite</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orthogonalBoxType</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejection_threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># if use C4D RB dynamics, should be genralized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupRBOptions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulationTimes</span> <span class="o">=</span> <span class="mf">2.0</span>

        <span class="c1"># cancel dialog-&gt; need to be develop more</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cancelDialog</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grab_cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_set</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_used</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cFill</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FillName</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;F&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nFill</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># do we sort the ingredient or not see  getSortedActiveIngredients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currtId</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># gradient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_gradient</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gradients&quot;</span><span class="p">,</span> <span class="p">{}))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_halton</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># use halton for grid point distribution</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ingrLookForNeighbours</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Old Features to be test</span>

        <span class="c1"># debug with timer function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_ingredient</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totalNbIngr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treemode</span> <span class="o">=</span> <span class="s2">&quot;cKDTree&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>  <span class="c1"># RBHTree(a.tolist(),range(len(a)),10,10,10,10,10,9999)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span> <span class="o">=</span> <span class="n">PackedObjects</span><span class="p">()</span>

        <span class="c1"># should be part of an independent module</span>
        <span class="c1"># could be a problem here for pp</span>
        <span class="c1"># can&#39;t pickle this dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rb_func_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># need options for the save/server data etc....</span>
        <span class="c1"># should it be in __init__ like other general options ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_freq</span> <span class="o">=</span> <span class="mf">120.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jsondic</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">distancesAfterFill</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freePointsAfterFill</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbFreePointsAfterFill</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distanceAfterFill</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;composition&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root_compartment</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compartment_keys</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference_dict</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">referenced_objects</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">Recipe</span><span class="o">.</span><span class="n">resolve_composition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_objects</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gradient</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">gradient_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;gradients&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_gradient</span><span class="p">(</span><span class="n">gradient_data</span><span class="p">)</span>

<div class="viewcode-block" id="Environment.get_compartment_object_by_name">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_compartment_object_by_name">[docs]</a>
    <span class="k">def</span> <span class="nf">get_compartment_object_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns compartment object by name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">compartment_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">compartment</span></div>


<div class="viewcode-block" id="Environment.get_bounding_box_limits">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_bounding_box_limits">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bounding_box_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the min and max limits for the bounding box</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>
        <span class="n">min_bound</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_bound</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">min_bound</span><span class="p">,</span> <span class="n">max_bound</span></div>


<div class="viewcode-block" id="Environment.setSeed">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setSeed">[docs]</a>
    <span class="k">def</span> <span class="nf">setSeed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seedNum</span><span class="p">):</span>
        <span class="n">SEED</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seedNum</span><span class="p">)</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>  <span class="c1"># for gradient</span>
        <span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomRot</span><span class="o">.</span><span class="n">setSeed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_set</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_used</span> <span class="o">=</span> <span class="n">SEED</span></div>


    <span class="k">def</span> <span class="nf">_prep_ingredient_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition_info</span><span class="p">,</span> <span class="n">ingredient_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">objects_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span>
        <span class="n">object_key</span> <span class="o">=</span> <span class="n">composition_info</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>
        <span class="n">ingredient_info</span> <span class="o">=</span> <span class="n">expand_object_using_key</span><span class="p">(</span>
            <span class="n">composition_info</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">objects_dict</span>
        <span class="p">)</span>
        <span class="n">ingredient_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ingredient_name</span> <span class="k">if</span> <span class="n">ingredient_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">object_key</span>
        <span class="p">)</span>
        <span class="n">ingredient_info</span><span class="p">[</span><span class="s2">&quot;object_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_key</span>
        <span class="n">ingredient_info</span> <span class="o">=</span> <span class="n">ingredient</span><span class="o">.</span><span class="n">Ingredient</span><span class="o">.</span><span class="n">validate_ingredient_info</span><span class="p">(</span>
            <span class="n">ingredient_info</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ingredient_info</span>

    <span class="k">def</span> <span class="nf">_step_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment_key</span><span class="p">,</span> <span class="n">prev_compartment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">prev_compartment</span> <span class="k">if</span> <span class="n">prev_compartment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span>
        <span class="n">composition_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;composition&quot;</span><span class="p">]</span>
        <span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_compartment</span><span class="p">(</span><span class="n">compartment_key</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="n">compartment_info</span> <span class="o">=</span> <span class="n">composition_dict</span><span class="p">[</span><span class="n">compartment_key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">obj_keys</span> <span class="ow">in</span> <span class="n">compartment_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># check if entry in compositions has regions</span>
            <span class="n">recipe</span> <span class="o">=</span> <span class="n">Recipe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">compartment_key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key_or_dict</span> <span class="ow">in</span> <span class="n">obj_keys</span><span class="p">:</span>
                <span class="n">is_key</span><span class="p">,</span> <span class="n">composition_info</span> <span class="o">=</span> <span class="n">Recipe</span><span class="o">.</span><span class="n">is_key</span><span class="p">(</span><span class="n">key_or_dict</span><span class="p">,</span> <span class="n">composition_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_key</span> <span class="ow">and</span> <span class="n">key_or_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartment_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key_or_dict</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_step_down</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prev_compartment</span><span class="o">=</span><span class="n">compartment</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key_or_dict</span> <span class="k">if</span> <span class="n">is_key</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">ingredient_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_ingredient_info</span><span class="p">(</span><span class="n">composition_info</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_ingredient</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">ingredient_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">region_name</span> <span class="o">==</span> <span class="s2">&quot;surface&quot;</span><span class="p">:</span>
                <span class="n">compartment</span><span class="o">.</span><span class="n">setSurfaceRecipe</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">region_name</span> <span class="o">==</span> <span class="s2">&quot;interior&quot;</span><span class="p">:</span>
                <span class="n">compartment</span><span class="o">.</span><span class="n">setInnerRecipe</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span>

<div class="viewcode-block" id="Environment.create_objects">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.create_objects">[docs]</a>
    <span class="k">def</span> <span class="nf">create_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate compartments and ingredients contained within the recipe data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">composition_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;composition&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_compartment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_compartment</span> <span class="o">=</span> <span class="n">composition_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_compartment</span><span class="p">]</span>
            <span class="c1"># self.create_compartment(self.root_compartment)</span>
            <span class="n">external_recipe</span> <span class="o">=</span> <span class="n">Recipe</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">obj_keys</span> <span class="ow">in</span> <span class="n">root_compartment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="p">{}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># check if entry in compositions has regions</span>
                <span class="k">for</span> <span class="n">key_or_dict</span> <span class="ow">in</span> <span class="n">obj_keys</span><span class="p">:</span>
                    <span class="n">is_key</span><span class="p">,</span> <span class="n">composition_info</span> <span class="o">=</span> <span class="n">Recipe</span><span class="o">.</span><span class="n">is_key</span><span class="p">(</span>
                        <span class="n">key_or_dict</span><span class="p">,</span> <span class="n">composition_dict</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_key</span> <span class="ow">and</span> <span class="n">key_or_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartment_keys</span><span class="p">:</span>
                        <span class="c1"># key is pointing to another container</span>
                        <span class="c1"># make compartment and add ingredients inside it</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key_or_dict</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_step_down</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key_or_dict</span> <span class="k">if</span> <span class="n">is_key</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">ingredient_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_ingredient_info</span><span class="p">(</span>
                            <span class="n">composition_info</span><span class="p">,</span> <span class="n">key</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">create_ingredient</span><span class="p">(</span><span class="n">external_recipe</span><span class="p">,</span> <span class="n">ingredient_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setExteriorRecipe</span><span class="p">(</span><span class="n">external_recipe</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.reportprogress">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.reportprogress">[docs]</a>
    <span class="k">def</span> <span class="nf">reportprogress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span> <span class="s2">&quot;vi&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">progressBar</span><span class="p">(</span><span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.set_partners_ingredient">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.set_partners_ingredient">[docs]</a>
    <span class="k">def</span> <span class="nf">set_partners_ingredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">partners</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="n">ingr</span><span class="o">.</span><span class="n">partners</span><span class="o">.</span><span class="n">all_partners</span><span class="p">:</span>
                <span class="n">partner_ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ingredient_by_name</span><span class="p">(</span><span class="n">partner</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">partner</span><span class="o">.</span><span class="n">set_ingredient</span><span class="p">(</span><span class="n">partner_ingr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
            <span class="c1"># TODO: I don&#39;t think this code is needed,</span>
            <span class="c1"># but I haven&#39;t dug into it enough to delete it all yet</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">prepare_alternates</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.get_all_distances">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_all_distances">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">elif</span> <span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">positions</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.get_distances">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_distances">[docs]</a>
    <span class="k">def</span> <span class="nf">get_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingredient_name</span><span class="p">,</span> <span class="n">center</span><span class="p">):</span>

        <span class="n">ingredient_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_positions_for_ingredient</span><span class="p">(</span>
            <span class="n">ingredient_name</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingredient_positions</span><span class="p">):</span>
            <span class="n">distances_between_ingredients</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">ingredient_positions</span><span class="p">)</span>
            <span class="n">distances_from_center</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="n">ingredient_positions</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">distances_from_center</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">distances_between_ingredients</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">ingredient_positions</span><span class="p">,</span>
            <span class="n">distances_from_center</span><span class="p">,</span>
            <span class="n">distances_between_ingredients</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Environment.get_ingredient_angles">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_ingredient_angles">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ingredient_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingredient_name</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">ingredient_positions</span><span class="p">):</span>
        <span class="n">ingredient_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_rotations_for_ingredient</span><span class="p">(</span>
            <span class="n">ingredient_name</span><span class="o">=</span><span class="n">ingredient_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ingredient_position_vector</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ingredient_positions</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">center</span>
        <span class="p">)</span>

        <span class="n">anglesX</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">signed_angle_between_vectors</span><span class="p">(</span>
                <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingredient_positions</span><span class="p">),</span>
                <span class="n">ingredient_rotation</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
                <span class="o">-</span><span class="n">ingredient_position_vector</span><span class="p">,</span>
                <span class="n">directed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">anglesY</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">signed_angle_between_vectors</span><span class="p">(</span>
                <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingredient_positions</span><span class="p">),</span>
                <span class="n">ingredient_rotation</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
                <span class="o">-</span><span class="n">ingredient_position_vector</span><span class="p">,</span>
                <span class="n">directed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">anglesZ</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">signed_angle_between_vectors</span><span class="p">(</span>
                <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingredient_positions</span><span class="p">),</span>
                <span class="n">ingredient_rotation</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
                <span class="o">-</span><span class="n">ingredient_position_vector</span><span class="p">,</span>
                <span class="n">directed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">anglesX</span><span class="p">,</span> <span class="n">anglesY</span><span class="p">,</span> <span class="n">anglesZ</span><span class="p">]))</span></div>


<div class="viewcode-block" id="Environment.get_distances_and_angles">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_distances_and_angles">[docs]</a>
    <span class="k">def</span> <span class="nf">get_distances_and_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingredient_name</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">get_angles</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">ingredient_positions</span><span class="p">,</span>
            <span class="n">distances_from_center</span><span class="p">,</span>
            <span class="n">distances_between_ingredients</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distances</span><span class="p">(</span><span class="n">ingredient_name</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_angles</span><span class="p">:</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ingredient_angles</span><span class="p">(</span>
                <span class="n">ingredient_name</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">ingredient_positions</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">ingredient_positions</span><span class="p">,</span>
            <span class="n">distances_from_center</span><span class="p">,</span>
            <span class="n">distances_between_ingredients</span><span class="p">,</span>
            <span class="n">angles</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Environment.calc_pairwise_distances">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.calc_pairwise_distances">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_pairwise_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr1name</span><span class="p">,</span> <span class="n">ingr2name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns pairwise distances between ingredients of different types</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ingr_pos_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_positions_for_ingredient</span><span class="p">(</span>
            <span class="n">ingredient_name</span><span class="o">=</span><span class="n">ingr1name</span>
        <span class="p">)</span>
        <span class="n">ingr_pos_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_positions_for_ingredient</span><span class="p">(</span>
            <span class="n">ingredient_name</span><span class="o">=</span><span class="n">ingr2name</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">ingr_pos_1</span><span class="p">,</span> <span class="n">ingr_pos_2</span><span class="p">))</span></div>


<div class="viewcode-block" id="Environment.save_result">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.save_result">[docs]</a>
    <span class="k">def</span> <span class="nf">save_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">free_points</span><span class="p">,</span>
        <span class="n">distances</span><span class="p">,</span>
        <span class="n">all_objects</span><span class="p">,</span>
        <span class="n">save_grid_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_result_as_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[:]</span>
        <span class="c1"># should check extension filename for type of saved file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_from_grid_file</span><span class="p">:</span>
            <span class="c1"># do not overwrite if grid was loaded from file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">result_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saveGridToFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_grid_logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saveGridLogsAsJson</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_file</span> <span class="o">+</span> <span class="s2">&quot;_grid-data.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectResultPerIngredient</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save_result_as_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">Writer</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format_output</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">kwds</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;compartment_id&quot;</span><span class="p">],</span>
            <span class="n">result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">quaternion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">seed_to_results_map</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">all_objects</span><span class="p">},</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Environment.loadResult">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.loadResult">[docs]</a>
    <span class="k">def</span> <span class="nf">loadResult</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restore_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backward</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
            <span class="c1"># check the extension of the filename none, txt or json</span>
        <span class="n">fileName</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;can&#39;t read &quot;</span> <span class="o">+</span> <span class="n">resultfilename</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.apr&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_asTxt</span><span class="p">(</span><span class="n">resultfilename</span><span class="o">=</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.txt&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_asTxt</span><span class="p">(</span><span class="n">resultfilename</span><span class="o">=</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">backward</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_asJson</span><span class="p">(</span><span class="n">resultfilename</span><span class="o">=</span><span class="n">resultfilename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">IOutils</span><span class="o">.</span><span class="n">load_MixedasJson</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="n">resultfilename</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="n">transpose</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;can&#39;t read or recognize &quot;</span> <span class="o">+</span> <span class="n">resultfilename</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Environment.includeIngrRecipes">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.includeIngrRecipes">[docs]</a>
    <span class="k">def</span> <span class="nf">includeIngrRecipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Include or Exclude the given ingredient from the recipe.</span>
<span class="sd">        (similar to an active state toggle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeIngrRecipe</span><span class="p">(</span><span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeIngrRecipe</span><span class="p">(</span><span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">rs</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeIngrRecipe</span><span class="p">(</span><span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">ri</span><span class="p">):</span>
                <span class="k">return</span></div>


<div class="viewcode-block" id="Environment.includeIngrRecipe">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.includeIngrRecipe">[docs]</a>
    <span class="k">def</span> <span class="nf">includeIngrRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">rs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Include or Exclude the given ingredient from the given recipe.</span>
<span class="sd">        (similar to an active state toggle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ingrname</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">include</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rs</span><span class="o">.</span><span class="n">addIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ingrname</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">include</span><span class="p">:</span>
                    <span class="n">rs</span><span class="o">.</span><span class="n">delIngredients</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Environment.includeIngredientRecipe">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.includeIngredientRecipe">[docs]</a>
    <span class="k">def</span> <span class="nf">includeIngredientRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">include</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;lue</span>
<span class="sd">        Include or Exclude the given ingredient from the recipe.</span>
<span class="sd">        (similar to an active state toggle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">recipe</span>  <span class="c1"># ()</span>
        <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">addIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">delIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.sortIngredient">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.sortIngredient">[docs]</a>
    <span class="k">def</span> <span class="nf">sortIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># make sure all recipes are sorted from large to small radius</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.resolve_gradient_data_objects">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.resolve_gradient_data_objects">[docs]</a>
    <span class="k">def</span> <span class="nf">resolve_gradient_data_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradient_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolves gradient data objects for some modes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: check if other modes need to be resolved</span>
        <span class="k">if</span> <span class="n">gradient_data</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;surface&quot;</span><span class="p">:</span>
            <span class="n">gradient_data</span><span class="p">[</span><span class="s2">&quot;mode_settings&quot;</span><span class="p">][</span>
                <span class="s2">&quot;object&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compartment_object_by_name</span><span class="p">(</span>
                <span class="n">gradient_data</span><span class="p">[</span><span class="s2">&quot;mode_settings&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">gradient_data</span></div>


<div class="viewcode-block" id="Environment.set_gradient">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.set_gradient">[docs]</a>
    <span class="k">def</span> <span class="nf">set_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradient_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create a grdaient</span>
<span class="sd">        assign weight to point</span>
<span class="sd">        listorganelle influenced</span>
<span class="sd">        listingredient influenced</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gradient_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_gradient_data_objects</span><span class="p">(</span><span class="n">gradient_data</span><span class="p">)</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="n">Gradient</span><span class="p">(</span><span class="n">gradient_data</span><span class="p">)</span>
        <span class="c1"># default gradient 1-linear Decoy X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">gradient_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gradient</span></div>


<div class="viewcode-block" id="Environment.callFunction">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.callFunction">[docs]</a>
    <span class="k">def</span> <span class="nf">callFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kw</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        helper function to callback another function with the</span>
<span class="sd">        given arguments and keywords.</span>
<span class="sd">        Optionally time stamp it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Environment.is_two_d">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.is_two_d">[docs]</a>
    <span class="k">def</span> <span class="nf">is_two_d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">grid_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridSpacing</span>
        <span class="n">bounding_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span>
        <span class="n">box_size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">smallest_size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">box_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">smallest_size</span> <span class="o">&lt;=</span> <span class="n">grid_spacing</span></div>


<div class="viewcode-block" id="Environment.timeFunction">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.timeFunction">[docs]</a>
    <span class="k">def</span> <span class="nf">timeFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mesure the time for performing the provided function.</span>

<span class="sd">        @type  function: function</span>
<span class="sd">        @param function: the function to execute</span>
<span class="sd">        @type  args: liste</span>
<span class="sd">        @param args: the liste of arguments for the function</span>


<span class="sd">        @rtype:   list/array</span>
<span class="sd">        @return:  the center of mass of the coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;time &quot;</span> <span class="o">+</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Environment.SetRBOptions">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.SetRBOptions">[docs]</a>
    <span class="k">def</span> <span class="nf">SetRBOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="s2">&quot;moving&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the rigid body options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">,</span>
            <span class="s2">&quot;child&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dynamicsBody&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;massClamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rotMassClamp&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>


<div class="viewcode-block" id="Environment.SetSpringOptions">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.SetSpringOptions">[docs]</a>
    <span class="k">def</span> <span class="nf">SetSpringOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the spring options, mainly used by C4D.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stifness&quot;</span><span class="p">,</span> <span class="s2">&quot;rlength&quot;</span><span class="p">,</span> <span class="s2">&quot;damping&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>


<div class="viewcode-block" id="Environment.setupRBOptions">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setupRBOptions">[docs]</a>
    <span class="k">def</span> <span class="nf">setupRBOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set default value for rigid body options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span><span class="p">[</span><span class="s2">&quot;stifness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span><span class="p">[</span><span class="s2">&quot;rlength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springOptions</span><span class="p">[</span><span class="s2">&quot;damping&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsBody&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;massClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">][</span><span class="s2">&quot;rotMassClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsBody&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;massClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;moving&quot;</span><span class="p">][</span><span class="s2">&quot;rotMassClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsBody&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;massClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">][</span><span class="s2">&quot;rotMassClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsBody&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsLinearDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;dynamicsAngularDamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;massClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamicOptions</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">][</span><span class="s2">&quot;rotMassClamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Environment.writeArraysToFile">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.writeArraysToFile">[docs]</a>
    <span class="k">def</span> <span class="nf">writeArraysToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;write self.compartment_ids and self.distToClosestSurf to file. (pickle)&quot;&quot;&quot;</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.readArraysFromFile">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.readArraysFromFile">[docs]</a>
    <span class="k">def</span> <span class="nf">readArraysFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;write self.compartment_ids and self.distToClosestSurf to file. (pickle)&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span> <span class="o">=</span> <span class="n">pos</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span> <span class="o">=</span> <span class="n">dist</span>  <span class="c1"># grid+organelle+surf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">id</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Environment.saveGridToFile">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.saveGridToFile">[docs]</a>
    <span class="k">def</span> <span class="nf">saveGridToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current grid and the compartment grid information in a file. (pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">gridFileOut</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gridfilename path problem&quot;</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">gridFileOut</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>  <span class="c1"># &#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeArraysToFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">saveGridToFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SAVED GRID TO &quot;</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.saveGridLogsAsJson">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.saveGridLogsAsJson">[docs]</a>
    <span class="k">def</span> <span class="nf">saveGridLogsAsJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current grid and the compartment grid information in a file. (pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">gridFileOut</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gridfilename path problem&quot;</span><span class="p">,</span> <span class="n">gridFileOut</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
                <span class="p">],</span>
                <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="s2">&quot;compartment&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">}</span>
        <span class="c1"># data = {</span>
        <span class="c1">#     # &quot;gridPositions&quot;: json.loads(self.grid.masterGridPositions),</span>
        <span class="c1">#     &quot;distances&quot;: json.loads(self.grid.distToClosestSurf)</span>
        <span class="c1"># }</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gridFileOut</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.get_attributes_to_update">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_attributes_to_update">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_attributes_to_update</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;faces&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vertices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vnormals&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ref_obj&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="s2">&quot;encapsulating_radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;radius&quot;</span><span class="p">,</span>
            <span class="s2">&quot;insidePoints&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surfacePoints&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surfacePointsCoords&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surfacePointsNormals&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ogsurfacePoints&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ogsurfacePointsNormals&quot;</span><span class="p">,</span>
            <span class="s2">&quot;OGsrfPtsBht&quot;</span><span class="p">,</span>
            <span class="s2">&quot;closestId&quot;</span><span class="p">,</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="Environment.restore_grids_from_pickle">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.restore_grids_from_pickle">[docs]</a>
    <span class="k">def</span> <span class="nf">restore_grids_from_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and setup the grid from the given filename. (pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading grid from </span><span class="si">{</span><span class="n">grid_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">grid_file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_obj</span><span class="p">:</span>
            <span class="c1"># load env grid</span>
            <span class="n">grid_obj</span> <span class="o">=</span> <span class="n">load_object_from_pickle</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid_obj</span>

            <span class="c1"># load compartment grids</span>
            <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
                <span class="n">comp_obj</span> <span class="o">=</span> <span class="n">load_object_from_pickle</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">update_attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attributes_to_update</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">ct</span><span class="p">],</span>
                        <span class="n">update_attr</span><span class="p">,</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">comp_obj</span><span class="p">,</span> <span class="n">update_attr</span><span class="p">),</span>
                    <span class="p">)</span>

            <span class="c1"># load mesh store</span>
            <span class="n">mesh_store_obj</span> <span class="o">=</span> <span class="n">load_object_from_pickle</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span> <span class="o">=</span> <span class="n">mesh_store_obj</span>

            <span class="c1"># clear the triangles_tree cache</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">geom</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;triangles_tree&quot;</span><span class="p">)</span>

            <span class="c1"># reset grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.save_grids_to_pickle">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.save_grids_to_pickle">[docs]</a>
    <span class="k">def</span> <span class="nf">save_grids_to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current grid and compartment grids to file. (pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving grid to </span><span class="si">{</span><span class="n">grid_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">grid_file_path</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Check grid file path: </span><span class="si">{</span><span class="n">grid_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">grid_file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_obj</span><span class="p">:</span>
            <span class="c1"># dump env grid</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">)</span>

            <span class="c1"># dump compartment grids</span>
            <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">compartment</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">)</span>

            <span class="c1"># dump mesh store</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.restoreGridFromFile">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.restoreGridFromFile">[docs]</a>
    <span class="k">def</span> <span class="nf">restoreGridFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridFileName</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and setup the grid from the given filename. (pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading grid from </span><span class="si">{</span><span class="n">gridFileName</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">aInteriorGrids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aSurfaceGrids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">gridFileName</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readArraysFromFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">readGridFromFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">aInteriorGrids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compartment</span><span class="o">.</span><span class="n">insidePoints</span><span class="p">)</span>
            <span class="n">aSurfaceGrids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compartment</span><span class="o">.</span><span class="n">surfacePoints</span><span class="p">)</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">OGsrfPtsBht</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">compartment</span><span class="o">.</span><span class="n">vertices</span><span class="p">),</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">compute_volume_and_set_count</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfacePoints</span><span class="p">,</span> <span class="n">compartment</span><span class="o">.</span><span class="n">insidePoints</span><span class="p">,</span> <span class="n">areas</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">compartment</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># TODO: restore surface distances on loading from grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aInteriorGrids</span> <span class="o">=</span> <span class="n">aInteriorGrids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aSurfaceGrids</span> <span class="o">=</span> <span class="n">aSurfaceGrids</span></div>


<div class="viewcode-block" id="Environment.extractMeshComponent">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.extractMeshComponent">[docs]</a>
    <span class="k">def</span> <span class="nf">extractMeshComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Require host helper. Return the v,f,n of the given object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extractMeshComponent&quot;</span><span class="p">,</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">helper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no Helper found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">:</span>  <span class="c1"># compartment master parent?</span>
            <span class="n">childs</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getChilds</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">childs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">getChilds</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                    <span class="c1"># should be all polygon</span>
                    <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">vertices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">vnormals</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vn</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
                            <span class="n">pc</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="n">faces</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="n">vertices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">vnormals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">vnormals</span>
                <span class="k">elif</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">:</span>
                    <span class="n">faces</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">vnormals</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
                        <span class="n">ch</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">vnormals</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">:</span>
            <span class="n">faces</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">vnormals</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">DecomposeMesh</span><span class="p">(</span>
                <span class="n">obj</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">vnormals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;extractMeshComponent&quot;</span><span class="p">,</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">,</span>
                <span class="n">helper</span><span class="o">.</span><span class="n">getType</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">helper</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.update_largest_smallest_size">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.update_largest_smallest_size">[docs]</a>
    <span class="k">def</span> <span class="nf">update_largest_smallest_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">min_radius</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">min_radius</span></div>


<div class="viewcode-block" id="Environment.create_ingredient">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.create_ingredient">[docs]</a>
    <span class="k">def</span> <span class="nf">create_ingredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipe</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;place_method&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;place_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_method</span>
        <span class="n">ingredient_type</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">ingredient_class</span> <span class="o">=</span> <span class="n">ingredient</span><span class="o">.</span><span class="n">get_ingredient_class</span><span class="p">(</span><span class="n">ingredient_type</span><span class="p">)</span>
        <span class="n">ingr</span> <span class="o">=</span> <span class="n">ingredient_class</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;gradient&quot;</span> <span class="ow">in</span> <span class="n">arguments</span>
            <span class="ow">and</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;gradient&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
            <span class="ow">and</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;gradient&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span>
        <span class="p">):</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;gradient&quot;</span><span class="p">]</span>
            <span class="c1"># TODO: allow ingrdients to have multiple gradients</span>
        <span class="k">if</span> <span class="s2">&quot;results&quot;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span>
        <span class="n">ingr</span><span class="o">.</span><span class="n">initialize_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span><span class="p">)</span>
        <span class="n">recipe</span><span class="o">.</span><span class="n">addIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_largest_smallest_size</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.create_compartment">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.create_compartment">[docs]</a>
    <span class="k">def</span> <span class="nf">create_compartment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment_key</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="n">comp_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;composition&quot;</span><span class="p">]</span>
        <span class="n">obj_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_data</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;object&quot;</span> <span class="ow">in</span> <span class="n">comp_dic</span><span class="p">[</span><span class="n">compartment_key</span><span class="p">]:</span>
            <span class="c1"># create compartment using object</span>
            <span class="n">object_info</span> <span class="o">=</span> <span class="n">obj_dic</span><span class="p">[</span><span class="n">comp_dic</span><span class="p">[</span><span class="n">compartment_key</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use bounding box</span>
            <span class="n">object_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bounding_box&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">}</span>

        <span class="n">compartment</span> <span class="o">=</span> <span class="n">Compartment</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">compartment_key</span><span class="p">,</span>
            <span class="n">object_info</span><span class="o">=</span><span class="n">object_info</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_compartment</span><span class="p">(</span><span class="n">compartment</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compartment</span></div>


    <span class="k">def</span> <span class="nf">_add_compartment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the given compartment to the environment.</span>
<span class="sd">        Extend the main bounding box if needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compartment</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbCompartments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbCompartments</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compartment</span><span class="p">)</span>
        <span class="n">CompartmentList</span><span class="o">.</span><span class="n">add_compartment</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">compartment</span><span class="p">)</span>

<div class="viewcode-block" id="Environment.compartment_id_for_nearest_grid_point">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.compartment_id_for_nearest_grid_point">[docs]</a>
    <span class="k">def</span> <span class="nf">compartment_id_for_nearest_grid_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="c1"># check if point inside  of the compartments</span>
        <span class="c1"># closest grid point is</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getClosestGridPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">compartment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">compartment_id</span></div>


<div class="viewcode-block" id="Environment.loopThroughIngr">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.loopThroughIngr">[docs]</a>
    <span class="k">def</span> <span class="nf">loopThroughIngr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb_function</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function that loops through all ingredients of all recipes and applies the given</span>
<span class="sd">        callback function on each ingredients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="n">cb_function</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">surface_recipe</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">surface_recipe</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">surface_recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">cb_function</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">inner_recipe</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">inner_recipe</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">inner_recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">cb_function</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.getIngrFromNameInRecipe">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getIngrFromNameInRecipe">[docs]</a>
    <span class="k">def</span> <span class="nf">getIngrFromNameInRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an ingredient name and a recipe, retrieve the ingredient object instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="c1"># check if name start with comp name</span>
            <span class="c1"># backward compatibility</span>
            <span class="c1"># legacy code</span>
            <span class="c1"># Problem when ingredient in different compartments</span>
            <span class="c1"># compartments is in the first three caractet like int_2 or surf_1</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="c1">#                elif name.find(ingr.composition_name) != -1 :</span>
                <span class="c1">#                    #check for</span>
                <span class="c1">#                    return ingr</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="c1">#                elif name.find(ingr.composition_name) != -1 :</span>
                <span class="c1">#                    return ingr</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.get_ingredient_by_name">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_ingredient_by_name">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ingredient_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">compartment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an ingredient name and optionally the compartment number, retrieve the ingredient object instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compartment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ingr</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span>
                <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
                <span class="n">ri</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span>
                <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ri</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ingr</span>
        <span class="k">elif</span> <span class="n">compartment_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ingr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">compartment_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">compartment_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ingr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &lt;0</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[(</span><span class="n">compartment_id</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIngrFromNameInRecipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ri</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ingr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.get_ingredients_in_tree">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_ingredients_in_tree">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ingredients_in_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">closest_ingredients</span><span class="p">):</span>
        <span class="n">ingredients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">packed_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_ingredients</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">packed_objects</span><span class="p">):</span>
            <span class="n">nearby_packed_objects</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">packed_objects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">closest_ingredients</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">nearby_packed_objects</span><span class="p">:</span>
                <span class="n">ingredients</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">obj</span><span class="p">,</span> <span class="n">closest_ingredients</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">ingredients</span></div>


<div class="viewcode-block" id="Environment.get_closest_ingredients">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_closest_ingredients">[docs]</a>
    <span class="k">def</span> <span class="nf">get_closest_ingredients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;indices&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;distances&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalNbIngr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">number_packed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_ingredients</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">number_packed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">to_return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># request kdtree</span>
            <span class="n">nb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;finding partners&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">number_packed</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">distance</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_ingr_bhtree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="n">point</span><span class="p">,</span> <span class="n">number_packed</span><span class="p">,</span> <span class="n">distance_upper_bound</span><span class="o">=</span><span class="n">cutoff</span>
                <span class="p">)</span>  <span class="c1"># len of ingr posed so far</span>
                <span class="k">if</span> <span class="n">number_packed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="p">[</span><span class="n">distance</span><span class="p">]</span>
                    <span class="n">nb</span> <span class="o">=</span> <span class="p">[</span><span class="n">nb</span><span class="p">]</span>
                <span class="n">to_return</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
                <span class="n">to_return</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span>  <span class="c1"># sorted by distance short -&gt; long</span>
            <span class="k">return</span> <span class="n">to_return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">to_return</span></div>


<div class="viewcode-block" id="Environment.setExteriorRecipe">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setExteriorRecipe">[docs]</a>
    <span class="k">def</span> <span class="nf">setExteriorRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipe</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the exterior recipe with the given one. Create the weakref.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span> <span class="o">=</span> <span class="n">recipe</span>
        <span class="n">recipe</span><span class="o">.</span><span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># weakref.ref(self)</span>
        <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">compartment_id</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="Environment.BuildCompartmentsGrids">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.BuildCompartmentsGrids">[docs]</a>
    <span class="k">def</span> <span class="nf">BuildCompartmentsGrids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the compartments grid (interior and surface points) to be merged with the main grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aInteriorGrids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aSurfaceGrids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># thread ?</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">initialize_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;in Environment, compartment.is_orthogonal_bounding_box=</span><span class="si">{</span><span class="n">compartment</span><span class="o">.</span><span class="n">is_orthogonal_bounding_box</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="p">(</span>
                <span class="n">points_inside_compartments</span><span class="p">,</span>
                <span class="n">points_on_compartment_surfaces</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">BuildGrid</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span>
            <span class="p">)</span>  <span class="c1"># return inside and surface point</span>
            <span class="n">aInteriorGrids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points_inside_compartments</span><span class="p">)</span>
            <span class="n">aSurfaceGrids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points_on_compartment_surfaces</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aInteriorGrids</span> <span class="o">=</span> <span class="n">aInteriorGrids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aSurfaceGrids</span> <span class="o">=</span> <span class="n">aSurfaceGrids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;I&#39;m out of the loop and have build my grid with inside points&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;build Grids </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">innerGridMethod</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">aSurfaceGrids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Environment.build_compartment_grids">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.build_compartment_grids">[docs]</a>
    <span class="k">def</span> <span class="nf">build_compartment_grids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;file is None thus re/building grid distance&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BuildCompartmentsGrids</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="n">verts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">surfacePointsCoords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)):</span>
                <span class="n">verts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">verts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">surfacePointsCoords</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">set_surfPtsBht</span><span class="p">(</span>
                <span class="n">verts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">)</span>  <span class="c1"># should do it only on inside grid point</span></div>


<div class="viewcode-block" id="Environment.extend_bounding_box_for_compartments">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.extend_bounding_box_for_compartments">[docs]</a>
    <span class="k">def</span> <span class="nf">extend_bounding_box_for_compartments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spacing</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="n">fits</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">inBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">,</span> <span class="n">spacing</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fits</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span> <span class="o">=</span> <span class="n">bb</span></div>


<div class="viewcode-block" id="Environment.get_size_of_bounding_box">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_size_of_bounding_box">[docs]</a>
    <span class="k">def</span> <span class="nf">get_size_of_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">box_boundary</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">box_boundary</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box_boundary</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="Environment.buildGrid">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.buildGrid">[docs]</a>
    <span class="k">def</span> <span class="nf">buildGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rebuild</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main build grid function. Setup the main grid and merge the</span>
<span class="sd">        compartment grid. The setup is de novo or using previously built grid</span>
<span class="sd">        or restored using given file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend_bounding_box_for_compartments</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>

        <span class="n">boundingBox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_halton</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cellpack.autopack.BaseGrid</span> <span class="kn">import</span> <span class="n">HaltonGrid</span> <span class="k">as</span> <span class="n">Grid</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">innerGridMethod</span> <span class="o">==</span> <span class="s2">&quot;floodfill&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cellpack.autopack.Environment</span> <span class="kn">import</span> <span class="n">Grid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cellpack.autopack.BaseGrid</span> <span class="kn">import</span> <span class="n">BaseGrid</span> <span class="k">as</span> <span class="n">Grid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sortIngredient</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;####BUILD GRID - step </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fillBB</span> <span class="o">=</span> <span class="n">boundingBox</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">boundingBox</span><span class="o">=</span><span class="n">boundingBox</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">)</span>
            <span class="n">nbPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridVolume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;new Grid with </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">boundingBox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridVolume</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[:]</span>
                <span class="n">nbPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gridVolume</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;$$$$$$$$  reset the grid&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">nbPoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;$$$$$$$$  reset the grid&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first fill, after we can just reset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;restore from file&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore_grids_from_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_compartment_grids</span><span class="p">()</span>

            <span class="c1"># save grids to pickle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_grid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_grids_to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_file_out</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exteriorVolume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">computeExteriorVolume</span><span class="p">(</span>
            <span class="n">compartments</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">,</span>
            <span class="n">space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span><span class="p">,</span>
            <span class="n">fbox_bb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fbox_bb</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exteriorVolume</span><span class="p">)</span>  <span class="c1"># should actually use the fillBB</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rebuild</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setCount</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[:]</span>

        <span class="c1"># distance = self.grid.distToClosestSurf  # [:]</span>
        <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">nbPoints</span>  <span class="c1"># -1</span>
        <span class="c1"># TODO: refactor this to work with new placed_objects data structure</span>
        <span class="c1"># for i, mingrs in enumerate(self.molecules):  # ( jtrans, rotMatj, self, ptInd )</span>
        <span class="c1">#     nbFreePoints = self.onePrevIngredient(</span>
        <span class="c1">#         i, mingrs, distance, nbFreePoints, self.molecules</span>
        <span class="c1">#     )</span>
        <span class="c1"># for organelle in self.compartments:</span>
        <span class="c1">#     for i, mingrs in enumerate(</span>
        <span class="c1">#         organelle.molecules</span>
        <span class="c1">#     ):  # ( jtrans, rotMatj, self, ptInd )</span>
        <span class="c1">#         nbFreePoints = self.onePrevIngredient(</span>
        <span class="c1">#             i, mingrs, distance, nbFreePoints, organelle.molecules</span>
        <span class="c1">#         )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">nbFreePoints</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gradient</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rebuild</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">:</span>
                <span class="n">gradient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">gradient</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;surface&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span>
                        <span class="n">gradient</span><span class="o">.</span><span class="n">mode_settings</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">],</span> <span class="s2">&quot;surface_distances&quot;</span>
                    <span class="p">):</span>
                        <span class="n">gradient</span><span class="o">.</span><span class="n">mode_settings</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_surface_distances</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">,</span>
                            <span class="n">gradient</span><span class="o">.</span><span class="n">mode_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale_to_next_surface&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                        <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">build_weight_map</span><span class="p">(</span>
                    <span class="n">boundingBox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="Environment.onePrevIngredient">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.onePrevIngredient">[docs]</a>
    <span class="k">def</span> <span class="nf">onePrevIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mingrs</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">marray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unused</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mingrs</span>
        <span class="n">centT</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">transformPoints</span><span class="p">(</span><span class="n">jtrans</span><span class="p">,</span> <span class="n">rotMatj</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">insidePoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">newDistPoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dpad</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">compartment_id</span><span class="p">)</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">getMaxJitter</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>
        <span class="n">dpad</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">min_radius</span> <span class="o">+</span> <span class="n">mr</span> <span class="o">+</span> <span class="n">jitter</span>
        <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">get_new_distance_values</span><span class="p">(</span>
            <span class="n">jtrans</span><span class="o">=</span><span class="n">jtrans</span><span class="p">,</span>
            <span class="n">rotMatj</span><span class="o">=</span><span class="n">rotMatj</span><span class="p">,</span>
            <span class="n">gridPointsCoords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">,</span>
            <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
            <span class="n">dpad</span><span class="o">=</span><span class="n">dpad</span><span class="p">,</span>
            <span class="n">centT</span><span class="o">=</span><span class="n">centT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">marray</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ptInd</span>  <span class="c1"># uniq Id ?</span>
        <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">BaseGrid</span><span class="o">.</span><span class="n">updateDistances</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">insidePoints</span><span class="p">,</span>
            <span class="n">newDistPoints</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span><span class="p">,</span>
            <span class="n">nbFreePoints</span><span class="p">,</span>
            <span class="n">distance</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># should we reset the ingredient ? completion ?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ingr</span><span class="o">.</span><span class="n">is_previous</span><span class="p">:</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">firstTimeUpdate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># should actually count it</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;allIngrPts&quot;</span>
            <span class="p">):</span>  <span class="c1"># Graham here on 5/16/12 are these two lines safe?</span>
                <span class="k">del</span> <span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span>  <span class="c1"># Graham here on 5/16/12 are these two lines safe?</span>
        <span class="k">return</span> <span class="n">nbFreePoints</span></div>


<div class="viewcode-block" id="Environment.getSortedActiveIngredients">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getSortedActiveIngredients">[docs]</a>
    <span class="k">def</span> <span class="nf">getSortedActiveIngredients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allIngredients</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort the active ingredient according their pirority and radius.</span>
<span class="sd">        # first get the ones with a packing priority</span>
<span class="sd">        # Graham- This now works in concert with ingredient picking</span>

<span class="sd">        # Graham here- In the new setup, priority is infinite with abs[priority] increasing (+)</span>
<span class="sd">        # An ingredients with (-) priority will pack from greatest abs[-priority] one at a time</span>
<span class="sd">        #     to lease abs[-priority]... each ingredient will attempt to reach its molarity</span>
<span class="sd">        #     before moving on to the next ingredient, and all (-) ingredients will try to</span>
<span class="sd">        #     deposit before other ingredients are tested.</span>
<span class="sd">        # An ingredient with (+) priority will recieve a weighted value based on its abs[priority]</span>
<span class="sd">        #     e.g. an ingredient with a priority=10 will be 10x more likely to be picked than</span>
<span class="sd">        #     an ingredient with a priority=1.</span>
<span class="sd">        # An ingredient with the default priority=0 will recieve a weighted value based on its</span>
<span class="sd">        #     complexity. (currently complexity = min_radius), thus a more &#39;complex&#39; ingredient</span>
<span class="sd">        #     will more likely try to pack before a less &#39;complex&#39; ingredient.</span>
<span class="sd">        #     IMPORTANT: the +priority list does not fully mix with the priority=0 list, but this</span>
<span class="sd">        #     should be an option... currently, the priority=0 list is normalized against a range</span>
<span class="sd">        #     up to the smallest +priority ingredient and appended to the (+) list</span>
<span class="sd">        # TODO: Add an option to allow + ingredients to be weighted by assigned priority AND complexity</span>
<span class="sd">        #     Add an option to allow priority=0 ingredients to fit into the (+) ingredient list</span>
<span class="sd">        #       rather than appending to the end.</span>
<span class="sd">        #     Even better, add an option to set the max priority for the 0list and then plug the results</span>
<span class="sd">        #       into the (+) ingredient list.</span>
<span class="sd">        #     Get rid of the (-), 0, (+) system and recreate this as a new flag and a class function</span>
<span class="sd">        #        so we can add multiple styles of sorting and weighting systems.</span>
<span class="sd">        #     Make normalizedPriorities and thresholdPriorities members of Ingredient class to avoid</span>
<span class="sd">        #        building these arrays.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ingr1</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># given priorities</span>
        <span class="n">priorities1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ingr2</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># priority = 0 or none and will be assigned based on complexity</span>
        <span class="n">priorities2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ingr0</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># negative values will pack first in order of abs[priority]</span>
        <span class="n">priorities0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ing</span> <span class="ow">in</span> <span class="n">allIngredients</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ing</span><span class="o">.</span><span class="n">completion</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># ignore completed ingredients</span>
            <span class="k">if</span> <span class="n">ing</span><span class="o">.</span><span class="n">priority</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ing</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ingr2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="p">)</span>
                <span class="n">priorities2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ing</span><span class="o">.</span><span class="n">priority</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ingr1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="p">)</span>
                <span class="n">priorities1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ing.priority    = -ing.priority</span>
                <span class="n">ingr0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="p">)</span>
                <span class="n">priorities0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ing</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ingr1</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">ingredient_compare1</span><span class="p">))</span>
                <span class="n">ingr2</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">ingredient_compare2</span><span class="p">))</span>
                <span class="n">ingr0</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">ingredient_compare0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ATTENTION INGR NOT SORTED&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="c1"># GrahamAdded this stuff in summer 2011, beware!</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lowestIng</span> <span class="o">=</span> <span class="n">ingr1</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ingr1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowestPriority</span> <span class="o">=</span> <span class="n">lowestIng</span><span class="o">.</span><span class="n">priority</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowestPriority</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.lowestPriority for Ing1 = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowestPriority</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">radii</span> <span class="ow">in</span> <span class="n">ingr2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">radii</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Cylinders&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radii</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">radii</span><span class="o">.</span><span class="n">min_radius</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">radii</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Spheres&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">radii</span><span class="o">.</span><span class="n">min_radius</span>
            <span class="k">elif</span> <span class="n">radii</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Cube&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">radii</span><span class="o">.</span><span class="n">min_radius</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">+</span> <span class="n">r</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.totalRadii += </span><span class="si">%d</span><span class="s2"> = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># safety</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span> <span class="o">+</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">priors2</span> <span class="ow">in</span> <span class="n">ingr2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">priors2</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Cylinders&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">priors2</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">priors2</span><span class="o">.</span><span class="n">min_radius</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">priors2</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;Spheres&quot;</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">priors2</span><span class="o">.</span><span class="n">min_radius</span>
            <span class="n">np</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalRadii</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowestPriority</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">)</span>
            <span class="n">priors2</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">np</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;self.normalizedPriorities0 = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities0</span><span class="p">)</span>
        <span class="n">activeIngr0</span> <span class="o">=</span> <span class="n">ingr0</span>  <span class="c1"># +ingr1+ingr2  #cropped to 0 on 7/20/10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(activeIngr0) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">activeIngr0</span><span class="p">))</span>
        <span class="n">activeIngr12</span> <span class="o">=</span> <span class="n">ingr1</span> <span class="o">+</span> <span class="n">ingr2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(activeIngr12) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">activeIngr12</span><span class="p">))</span>
        <span class="n">packingPriorities</span> <span class="o">=</span> <span class="n">priorities0</span> <span class="o">+</span> <span class="n">priorities1</span> <span class="o">+</span> <span class="n">priorities2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;packingPriorities </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">packingPriorities</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">activeIngr0</span><span class="p">,</span> <span class="n">activeIngr12</span></div>


<div class="viewcode-block" id="Environment.clearRBingredient">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.clearRBingredient">[docs]</a>
    <span class="k">def</span> <span class="nf">clearRBingredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delRB</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delRB</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">bullet_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="Environment.clear">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># before closing remoeall rigidbody</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loopThroughIngr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clearRBingredient</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.reset">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.reset">[docs]</a>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset everything to empty and not done&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fbox_bb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totnbJitter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jitterLength</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetIngrRecip</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span> <span class="o">=</span> <span class="n">PackedObjects</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">orga</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">orga</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetIngrRecip</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetIngrRecip</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">octree</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="o">=</span> <span class="kc">None</span></div>

            <span class="c1"># the reset doesnt touch the grid...</span>
        <span class="c1"># rapid node ?</span>

<div class="viewcode-block" id="Environment.resetIngrRecip">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.resetIngrRecip">[docs]</a>
    <span class="k">def</span> <span class="nf">resetIngrRecip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recip</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all ingredient of the given recipe&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">recip</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recip</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="c1"># ingr.results = []</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">firstTimeUpdate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">prev_alt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">start_positions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;isph&quot;</span><span class="p">):</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">isph</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;icyl&quot;</span><span class="p">):</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">icyl</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recip</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">firstTimeUpdate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">prev_alt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">start_positions</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;isph&quot;</span><span class="p">):</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">isph</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;icyl&quot;</span><span class="p">):</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">icyl</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">allIngrPts</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Environment.getActiveIng">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getActiveIng">[docs]</a>
    <span class="k">def</span> <span class="nf">getActiveIng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all remaining active ingredients&quot;&quot;&quot;</span>
        <span class="n">allIngredients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># counter of placed molecules</span>
                <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># I DONT GET IT !</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">allIngredients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">recipe</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># counter of placed molecules</span>
                    <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">allIngredients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">recipe</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># counter of placed molecules</span>
                    <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">allIngredients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">allIngredients</span></div>


<div class="viewcode-block" id="Environment.pickIngredient">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.pickIngredient">[docs]</a>
    <span class="k">def</span> <span class="nf">pickIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vThreshStart</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main function that decide the next ingredient the packing will try to</span>
<span class="sd">        drop. The picking is weighted or random</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Graham here: Walk through -priorities first</span>
                <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># prob = uniform(vRangeStart,1.0)</span>
                <span class="c1"># #Graham 9/21/11 This is wrong...</span>
                <span class="c1"># vRangeStart is the point index, need active list</span>
                <span class="c1"># i.e. thresholdPriority to be limited</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">ingrInd</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">threshProb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prob</span> <span class="o">&lt;=</span> <span class="n">threshProb</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">ingrInd</span> <span class="o">=</span> <span class="n">ingrInd</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">ingrInd</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">):</span>
                    <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="n">ingrInd</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error in Environment pick Ingredient&quot;</span><span class="p">,</span> <span class="n">ingrInd</span><span class="p">)</span>
                    <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;weighted&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">vThreshStart</span><span class="p">,</span> <span class="n">ingrInd</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span>  <span class="c1"># randint(0, len(self.activeIngr)-1)#random()</span>
            <span class="c1"># n=int(r*(len(self.activeIngr)-1))</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">))</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="c1">#            print (r,n,ingr.name,len(self.activeIngr)) #Graham turned back on 5/16/12, but may be costly</span>
        <span class="k">return</span> <span class="n">ingr</span></div>


<div class="viewcode-block" id="Environment.get_dpad">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.get_dpad">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dpad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the largest encapsulating_radius and use it for padding&quot;&quot;&quot;</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">compartment_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># cytoplasm -&gt; use cyto and all surfaces</span>
            <span class="k">for</span> <span class="n">ingr1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">compartment_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr1</span><span class="p">,</span> <span class="s2">&quot;max_radius&quot;</span><span class="p">):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">max_radius</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">encapsulating_radius</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">mr</span><span class="p">:</span>
                        <span class="n">mr</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">ingr1</span><span class="o">.</span><span class="n">compartment_id</span> <span class="o">==</span> <span class="n">compartment_id</span>
                    <span class="ow">or</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">compartment_id</span> <span class="o">==</span> <span class="o">-</span><span class="n">compartment_id</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr1</span><span class="p">,</span> <span class="s2">&quot;max_radius&quot;</span><span class="p">):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">max_radius</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">ingr1</span><span class="o">.</span><span class="n">encapsulating_radius</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">mr</span><span class="p">:</span>
                        <span class="n">mr</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">mr</span></div>


<div class="viewcode-block" id="Environment.getPointToDrop">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getPointToDrop">[docs]</a>
    <span class="k">def</span> <span class="nf">getPointToDrop</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ingr</span><span class="p">,</span>
        <span class="n">free_points</span><span class="p">,</span>
        <span class="n">nbFreePoints</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">,</span>
        <span class="n">spacing</span><span class="p">,</span>
        <span class="n">compId</span><span class="p">,</span>
        <span class="n">vRangeStart</span><span class="p">,</span>
        <span class="n">vThreshStart</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decide next point to use for dropping a given ingredent. The picking can be</span>
<span class="sd">        random, based on closest distance, based on gradients, ordered.</span>
<span class="sd">        This function also update the available free point except when hack is on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allIngrPts</span><span class="p">,</span> <span class="n">allIngrDist</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">get_list_of_free_indices</span><span class="p">(</span>
            <span class="n">distance</span><span class="p">,</span>
            <span class="n">free_points</span><span class="p">,</span>
            <span class="n">nbFreePoints</span><span class="p">,</span>
            <span class="n">spacing</span><span class="p">,</span>
            <span class="n">compId</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freePtsUpdateThreshold</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
            <span class="c1"># if ind == 0:</span>
            <span class="n">vRangeStart</span> <span class="o">=</span> <span class="n">vRangeStart</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># j = 0</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="c1"># Start of massive overruling section from corrected thesis file of Sept. 25, 2012</span>
            <span class="c1"># this function also depend on the ingr.completiion that can be restored ?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getSortedActiveIngredients</span><span class="p">,</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No point left for ingredient </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(allIngredients </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(self.activeIngr0) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(self.activeIngr12) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">activeIngre_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0.00001</span>
            <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">+</span> <span class="n">pp</span>
            <span class="n">previousThresh</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Graham- Once negatives are used, if picked random#</span>
            <span class="c1"># is below a number in this list, that item becomes</span>
            <span class="c1"># the active ingredient in the while loop below</span>
            <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
                <span class="c1"># pp1 = 0</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">np</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">np</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;np is &quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="s2">&quot; pp is &quot;</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="s2">&quot; tp is &quot;</span><span class="p">,</span> <span class="n">np</span> <span class="o">+</span> <span class="n">previousThresh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="n">previousThresh</span><span class="p">)</span>
                <span class="n">previousThresh</span> <span class="o">=</span> <span class="n">np</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">previousThresh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;time to reject the picking </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vRangeStart</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickRandPt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;picking random point&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">packing_mode</span> <span class="o">==</span> <span class="s2">&quot;close&quot;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">allIngrDist</span><span class="p">)</span>
                <span class="c1"># pick point with closest distance</span>
                <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                    <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ptIndr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">))</span>
                    <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="n">ptIndr</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">ingr</span><span class="o">.</span><span class="n">packing_mode</span> <span class="o">==</span> <span class="s2">&quot;gradient&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gradient</span><span class="p">:</span>
                <span class="c1"># get the most probable point using the gradient</span>
                <span class="c1"># use the gradient weighted map and get mot probabl point</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pick point from gradients </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">)))</span>
                <span class="n">ptInd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">gradient</span><span class="p">]</span><span class="o">.</span><span class="n">pickPoint</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># pick a point randomly among free points</span>
                <span class="c1"># random or uniform?</span>
                <span class="n">ptIndr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">allIngrPts</span><span class="p">))</span>
                <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="n">ptIndr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ptInd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No point left for ingredient </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
                <span class="c1"># if ind == 0:</span>
                <span class="n">vRangeStart</span> <span class="o">=</span> <span class="n">vRangeStart</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># j = 0</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;popping this gradient ingredient array must be redone using Sept 25,&quot;</span><span class="p">,</span>
                        <span class="s2">&quot; 2011 thesis version as above for nongradient ingredients, TODO: July 5, 2012&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;time to reject the picking&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;vRangeStart&quot;</span><span class="p">,</span> <span class="n">vRangeStart</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vRangeStart</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sorting index&quot;</span><span class="p">)</span>
            <span class="n">allIngrPts</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">ptInd</span> <span class="o">=</span> <span class="n">allIngrPts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ptInd</span></div>


<div class="viewcode-block" id="Environment.removeOnePoint">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.removeOnePoint">[docs]</a>
    <span class="k">def</span> <span class="nf">removeOnePoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">free_points</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># New system replaced by Graham on Aug 18, 2012</span>
            <span class="n">nbFreePoints</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">vKill</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
            <span class="n">vLastFree</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[</span><span class="n">nbFreePoints</span><span class="p">]</span>
            <span class="n">free_points</span><span class="p">[</span><span class="n">vKill</span><span class="p">]</span> <span class="o">=</span> <span class="n">vLastFree</span>
            <span class="n">free_points</span><span class="p">[</span><span class="n">vLastFree</span><span class="p">]</span> <span class="o">=</span> <span class="n">vKill</span>
            <span class="c1"># End New replaced by Graham on Aug 18, 2012</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">nbFreePoints</span></div>


<div class="viewcode-block" id="Environment.getTotalNbObject">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getTotalNbObject">[docs]</a>
    <span class="k">def</span> <span class="nf">getTotalNbObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allIngredients</span><span class="p">,</span> <span class="n">update_partner</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">totalNbIngr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">allIngredients</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Grow&quot;</span><span class="p">:</span>
                <span class="n">totalNbIngr</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span> <span class="o">*</span> <span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">ingr</span><span class="o">.</span><span class="n">unit_length</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">totalNbIngr</span> <span class="o">+=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span>
            <span class="k">if</span> <span class="n">update_partner</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_partners_ingredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">totalNbIngr</span></div>


<div class="viewcode-block" id="Environment.prep_molecules_for_save">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.prep_molecules_for_save">[docs]</a>
    <span class="k">def</span> <span class="nf">prep_molecules_for_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">free_points</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distancesAfterFill</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freePointsAfterFill</span> <span class="o">=</span> <span class="n">free_points</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbFreePointsAfterFill</span> <span class="o">=</span> <span class="n">nbFreePoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distanceAfterFill</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runTimeDisplay</span> <span class="ow">and</span> <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;simularium&quot;</span><span class="p">:</span>
            <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">writeToFile</span><span class="p">(</span><span class="s2">&quot;./realtime&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_all</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.check_new_placement">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.check_new_placement">[docs]</a>
    <span class="k">def</span> <span class="nf">check_new_placement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_position</span><span class="p">):</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_distances</span><span class="p">(</span><span class="n">new_position</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># nothing has been packed yet</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">min_distance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
        <span class="n">expected_min_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">min_distance</span> <span class="o">&lt;</span> <span class="n">expected_min_distance</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">expected_min_distance</span> <span class="o">-</span> <span class="n">min_distance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">min_distance</span> <span class="o">&lt;</span> <span class="n">expected_min_distance</span></div>


<div class="viewcode-block" id="Environment.distance_check_failed">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.distance_check_failed">[docs]</a>
    <span class="k">def</span> <span class="nf">distance_check_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_distances</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># nothing has been packed yet</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">min_distance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
        <span class="n">expected_min_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">min_distance</span> <span class="o">&lt;</span> <span class="n">expected_min_distance</span> <span class="o">+</span> <span class="mf">0.001</span></div>


<div class="viewcode-block" id="Environment.update_variable_ingredient_attributes">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.update_variable_ingredient_attributes">[docs]</a>
    <span class="k">def</span> <span class="nf">update_variable_ingredient_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allIngredients</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        updates variable attributes for all ingredients based on input options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">allIngredients</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;count_options&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ingr</span><span class="o">.</span><span class="n">count_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">count</span> <span class="o">=</span> <span class="n">get_value_from_distribution</span><span class="p">(</span>
                    <span class="n">distribution_options</span><span class="o">=</span><span class="n">ingr</span><span class="o">.</span><span class="n">count_options</span><span class="p">,</span>
                    <span class="n">return_int</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span> <span class="o">=</span> <span class="n">count</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="s2">&quot;size_options&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ingr</span><span class="o">.</span><span class="n">size_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">max_radius</span> <span class="o">=</span> <span class="n">get_max_value_from_distribution</span><span class="p">(</span>
                    <span class="n">distribution_options</span><span class="o">=</span><span class="n">ingr</span><span class="o">.</span><span class="n">size_options</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">max_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">max_radius</span> <span class="o">=</span> <span class="n">max_radius</span>

                <span class="n">min_radius</span> <span class="o">=</span> <span class="n">get_min_value_from_distribution</span><span class="p">(</span>
                    <span class="n">distribution_options</span><span class="o">=</span><span class="n">ingr</span><span class="o">.</span><span class="n">size_options</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">min_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">min_radius</span> <span class="o">=</span> <span class="n">min_radius</span></div>


<div class="viewcode-block" id="Environment.add_seed_number_to_base_name">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.add_seed_number_to_base_name">[docs]</a>
    <span class="k">def</span> <span class="nf">add_seed_number_to_base_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed_number</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_seed_</span><span class="si">{</span><span class="n">seed_number</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="Environment.set_result_file_name">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.set_result_file_name">[docs]</a>
    <span class="k">def</span> <span class="nf">set_result_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed_basename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the result file name using the output folder path and a given seed basename</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;results_</span><span class="si">{</span><span class="n">seed_basename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.update_after_place">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.update_after_place">[docs]</a>
    <span class="k">def</span> <span class="nf">update_after_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_point_index</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="n">grid_point_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastrank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastrank</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_ingredient</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Environment.pack_grid">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.pack_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">pack_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">seedNum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vTestid</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ## Fill the grid by picking an ingredient first and then</span>
<span class="sd">        ## find a suitable point using the ingredient&#39;s placer object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set periodicity</span>
        <span class="n">autopack</span><span class="o">.</span><span class="n">testPeriodicity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_periodicity</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">seed_base_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_seed_number_to_base_name</span><span class="p">(</span><span class="n">seedNum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_result_file_name</span><span class="p">(</span><span class="n">seed_base_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeUpDistLoopTotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no grid setup&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># create a list of active ingredients indices in all recipes to allow</span>
        <span class="c1"># removing inactive ingredients when molarity is reached</span>
        <span class="n">allIngredients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getActiveIng</span><span class="p">)</span>

        <span class="c1"># set the number of ingredients to pack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_variable_ingredient_attributes</span><span class="p">(</span><span class="n">allIngredients</span><span class="p">)</span>

        <span class="c1"># verify partner</span>
        <span class="n">usePP</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;usePP&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">usePP</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;usePP&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cFill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nFill</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FillName</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># seed random number generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSeed</span><span class="p">(</span><span class="n">seedNum</span><span class="p">)</span>
        <span class="c1"># create copies of the distance array as they change when molecules</span>
        <span class="c1"># are added, this array can be restored/saved before filling</span>
        <span class="n">free_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_points</span><span class="p">)</span>  <span class="c1"># -1</span>
        <span class="k">if</span> <span class="s2">&quot;fbox&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fbox</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;fbox&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">EnviroOnly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freePointMask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
            <span class="n">bb_insidepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getPointsInCube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fbox</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)[:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freePointMask</span><span class="p">[</span><span class="n">bb_insidepoint</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bb_outside</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freePointMask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span><span class="p">[</span><span class="n">bb_outside</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99999</span>
        <span class="n">compartment_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compartment_ids</span>

        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">compartment</span><span class="o">.</span><span class="n">store_packed_object</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># why a copy? --&gt; can we split ?</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span><span class="p">[:]</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallestProteinSize</span>

        <span class="c1"># DEBUG stuff, should be removed later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jitterVectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jitterLength</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totnbJitter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxColl</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">successfullJitter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failedJitter</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># this function also depend on the ingr.completiion that can be restored ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getSortedActiveIngredients</span><span class="p">,</span> <span class="p">([</span><span class="n">allIngredients</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(allIngredients </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">allIngredients</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(self.activeIngr0) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;len(self.activeIngr12) </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngre_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0.00001</span>
        <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">+</span> <span class="n">pp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;totalPriorities = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span><span class="p">)</span>
        <span class="n">previousThresh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Graham- Once negatives are used, if picked random#</span>
        <span class="c1"># is below a number in this list, that item becomes</span>
        <span class="c1"># the active ingredient in the while loop below</span>
        <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>  <span class="c1"># why ?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
            <span class="c1"># pp1 = 0</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">np</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">np</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="n">previousThresh</span><span class="p">)</span>
            <span class="n">previousThresh</span> <span class="o">=</span> <span class="n">np</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">previousThresh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span>

        <span class="n">nls</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">totalNumMols</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totalNbIngr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTotalNbObject</span><span class="p">(</span><span class="n">allIngredients</span><span class="p">,</span> <span class="n">update_partner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">allIngredients</span><span class="p">:</span>
                <span class="n">totalNumMols</span> <span class="o">+=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">left_to_place</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;totalNumMols pack_grid if = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">totalNumMols</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threshProb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">:</span>
                <span class="n">nameMe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[</span><span class="n">nls</span><span class="p">]</span>
                <span class="n">totalNumMols</span> <span class="o">+=</span> <span class="n">nameMe</span><span class="o">.</span><span class="n">left_to_place</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;threshprop pack_grid else is </span><span class="si">%f</span><span class="s2"> for ingredient: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">threshProb</span><span class="p">,</span>
                    <span class="n">nameMe</span><span class="p">,</span>
                    <span class="n">nameMe</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">nameMe</span><span class="o">.</span><span class="n">left_to_place</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;totalNumMols pack_grid else = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">totalNumMols</span><span class="p">)</span>
                <span class="n">nls</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">vRangeStart</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tCancelPrev</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">ptInd</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">PlacedMols</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vThreshStart</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Added back by Graham on July 5, 2012 from Sept 25, 2011 thesis version</span>

        <span class="c1"># ==============================================================================</span>
        <span class="c1">#         #the big loop</span>
        <span class="c1"># ==============================================================================</span>
        <span class="n">dump_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_freq</span>  <span class="c1"># 120.0#every minute</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progress_bar</span><span class="p">:</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">totalNumMols</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Packing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">nbFreePoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;.........At start of while loop, with vRangeStart = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vRangeStart</span>
            <span class="p">)</span>

            <span class="c1"># breakin test</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;exit packing loop because of len****&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;afviewer&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span> <span class="s2">&quot;vi&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">resetProgressBar</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">progressBar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filling Complete&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">vRangeStart</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exit packing loop because vRange and hence Done!!!****&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancelDialog</span><span class="p">:</span>
                <span class="n">tCancel</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tCancel</span> <span class="o">-</span> <span class="n">tCancelPrev</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="p">:</span>
                    <span class="n">cancel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayCancelDialog</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cancel</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;canceled by user: we&#39;ll fill with current objects up to time </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E510</span>
                            <span class="n">tCancel</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                    <span class="c1"># if OK, do nothing, i.e., continue loop</span>
                    <span class="c1"># (but not the function continue)</span>
                    <span class="n">tCancelPrev</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># pick an ingredient</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickIngredient</span><span class="p">(</span><span class="n">vThreshStart</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;afviewer&quot;</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">PlacedMols</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">totalNumMols</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>  <span class="c1"># This code shows 100% of ingredients all the time</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="p">,</span> <span class="s2">&quot;vi&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">progressBar</span><span class="p">(</span>
                        <span class="n">progress</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">completion</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">renderDistance</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">afviewer</span><span class="o">.</span><span class="n">vi</span><span class="o">.</span><span class="n">displayParticleVolumeDistance</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">current_ingr_compartment</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compartment_id</span>
            <span class="c1"># compute dpad which is the distance at which we need to update</span>
            <span class="c1"># distances after the drop is successfull</span>
            <span class="n">max_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dpad</span><span class="p">(</span><span class="n">current_ingr_compartment</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;picked Ingr radius </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">min_radius</span><span class="si">}</span><span class="s2">, compartment_id </span><span class="si">{</span><span class="n">current_ingr_compartment</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># find the points that can be used for this ingredient</span>
            <span class="c1">##</span>

            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compartment_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">ingr</span><span class="o">.</span><span class="n">compartment_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">surface_points</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">surfacePoints</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">surface_points</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">surface_points</span><span class="p">))]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPointToDrop</span><span class="p">(</span>
                    <span class="n">ingr</span><span class="p">,</span>
                    <span class="n">free_points</span><span class="p">,</span>
                    <span class="n">nbFreePoints</span><span class="p">,</span>
                    <span class="n">distances</span><span class="p">,</span>
                    <span class="n">spacing</span><span class="p">,</span>
                    <span class="n">compartment_ids</span><span class="p">,</span>
                    <span class="n">vRangeStart</span><span class="p">,</span>
                    <span class="n">vThreshStart</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># (Bool, ptInd)</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ptInd</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ptInd</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;point index outside of grid length, should never be true &quot;</span><span class="p">,</span>
                        <span class="n">ptInd</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;vRangeStart coninue &quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
                <span class="n">vRangeStart</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="c1"># NOTE: should we do the close partner check here instead of in the place functions?</span>
            <span class="c1"># place the ingredient</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_place_method</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">place_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_method</span>

            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;attempting to place near </span><span class="si">%d</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">ptInd</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">masterGridPositions</span><span class="p">[</span><span class="n">ptInd</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">collision_possible</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># if distances[ptInd] &gt;= ingr.encapsulating_radius + ingr.getMaxJitter(</span>
            <span class="c1">#     spacing</span>
            <span class="c1"># ):</span>
            <span class="c1">#     # there is no possible collision here</span>
            <span class="c1">#     collision_possible = False</span>
            <span class="p">(</span>
                <span class="n">success</span><span class="p">,</span>
                <span class="n">insidePoints</span><span class="p">,</span>
                <span class="n">newDistPoints</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">attempt_to_pack_at_grid_location</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">usePP</span><span class="p">,</span> <span class="n">collision_possible</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;after place attempt, placed: </span><span class="si">%r</span><span class="s2">, number of free points:</span><span class="si">%d</span><span class="s2">, length of free points=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">success</span><span class="p">,</span>
                <span class="n">nbFreePoints</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">free_points</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="n">BaseGrid</span><span class="o">.</span><span class="n">updateDistances</span><span class="p">(</span>
                    <span class="n">insidePoints</span><span class="p">,</span> <span class="n">newDistPoints</span><span class="p">,</span> <span class="n">free_points</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">,</span> <span class="n">distances</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances</span><span class="p">[:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">free_points</span><span class="p">[:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">nbFreePoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_points</span><span class="p">)</span>  <span class="c1"># -1</span>
                <span class="c1"># update largest protein size</span>
                <span class="c1"># problem when the encapsulating_radius is actually wrong</span>
                <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">largestProteinSize</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span>

                <span class="n">PlacedMols</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># if self.stop_on_collision:</span>
                <span class="c1"># ingredient_too_close = self.distance_check_failed()</span>
                <span class="c1"># if ingredient_too_close:</span>
                <span class="c1">#     print(&quot;GOT A FAIL&quot;, self.grid.masterGridPositions[ptInd])</span>
                <span class="c1">#     nbFreePoints = 0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progress_bar</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rejected </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ingr</span><span class="o">.</span><span class="n">rejectionCounter</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ingr</span><span class="o">.</span><span class="n">completion</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;completed*************** </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PlacedMols = </span><span class="si">{</span><span class="n">PlacedMols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;activeIngr index of </span><span class="si">{</span><span class="n">ingr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;threshold p len </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># j = 0</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">)</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span>
                        <span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callFunction</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">getSortedActiveIngredients</span><span class="p">,</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len(self.activeIngr0) </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len(self.activeIngr12) </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngre_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span><span class="p">[:]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0.00001</span>
                <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
                    <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">+</span> <span class="n">pp</span>
                <span class="c1">#                    print (&#39;totalPriorities = &#39;, self.totalPriorities)</span>
                <span class="n">previousThresh</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># Graham- Once negatives are used, if picked random#</span>
                <span class="c1"># is below a number in this list, that item becomes</span>
                <span class="c1"># the active ingredient in the while loop below</span>
                <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickWeightedIngr</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">priors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span><span class="p">:</span>
                    <span class="c1"># pp1 = 0</span>
                    <span class="n">pp</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">priority</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">np</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalPriorities</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">np</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">normalizedPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">)</span>
                    <span class="c1">#                    print (&#39;np is &#39;, np, &#39; pp is &#39;, pp, &#39; tp is &#39;, np + previousThresh)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thresholdPriorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="n">previousThresh</span><span class="p">)</span>
                    <span class="n">previousThresh</span> <span class="o">=</span> <span class="n">np</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">previousThresh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeIngr12</span>

            <span class="k">if</span> <span class="n">dump</span> <span class="ow">and</span> <span class="p">((</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">stime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dump_freq</span><span class="p">):</span>
                <span class="n">all_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_molecules_for_save</span><span class="p">(</span>
                    <span class="n">distances</span><span class="p">,</span>
                    <span class="n">free_points</span><span class="p">,</span>
                    <span class="n">nbFreePoints</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;placed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_ingredients</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveResult</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_result</span><span class="p">(</span>
                        <span class="n">free_points</span><span class="p">,</span>
                        <span class="n">distances</span><span class="o">=</span><span class="n">distances</span><span class="p">,</span>
                        <span class="n">all_objects</span><span class="o">=</span><span class="n">all_objects</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progress_bar</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;time to fill </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">all_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_molecules_for_save</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">free_points</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveResult</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_result</span><span class="p">(</span>
                <span class="n">free_points</span><span class="p">,</span>
                <span class="n">distances</span><span class="o">=</span><span class="n">distances</span><span class="p">,</span>
                <span class="n">all_objects</span><span class="o">=</span><span class="n">all_objects</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">all_objects</span></div>


<div class="viewcode-block" id="Environment.restore_molecules_array">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.restore_molecules_array">[docs]</a>
    <span class="k">def</span> <span class="nf">restore_molecules_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">):</span>
        <span class="k">pass</span></div>

        <span class="c1"># if len(ingr.results):</span>
        <span class="c1">#     for elem in ingr.results:</span>
        <span class="c1"># TODO: fix this to reset ingredients from results</span>
        <span class="c1"># if ingr.compartment_id == 0:</span>
        <span class="c1">#     self.molecules.append(</span>
        <span class="c1">#         [elem[0], numpy.array(elem[1]), ingr, 0, ingr.radius]</span>
        <span class="c1">#     )</span>
        <span class="c1"># else:</span>
        <span class="c1">#     ingr.recipe.compartment.molecules.append(</span>
        <span class="c1">#         [elem[0], numpy.array(elem[1]), ingr, 0, ingr.radius]</span>
        <span class="c1">#     )</span>

<div class="viewcode-block" id="Environment.restore">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.restore">[docs]</a>
    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">orgaresult</span><span class="p">,</span> <span class="n">freePoint</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># should we used the grid ? the freePoint can be computed</span>
        <span class="c1"># result is [pos,rot,ingr.name,ingr.compartment_id,ptInd]</span>
        <span class="c1"># orgaresult is [[pos,rot,ingr.name,ingr.compartment_id,ptInd],[pos,rot,ingr.name,ingr.compartment_id,ptInd]...]</span>
        <span class="c1"># after restore we can build the grid and fill!</span>
        <span class="c1"># ingredient based dictionary</span>
        <span class="c1"># TODO: refactor with new packed_objects</span>

        <span class="n">ingredients</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">,</span> <span class="n">ptInd</span> <span class="o">=</span> <span class="n">elem</span>
            <span class="c1"># needto check the name if it got the comp rule</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ingredient_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">),</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ingr</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
                <span class="n">mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">))</span>
                <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">molecules</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orgaresult</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
                <span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">orgaresult</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">,</span> <span class="n">ptInd</span> <span class="o">=</span> <span class="n">elem</span>
                    <span class="n">ingr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ingredient_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ingr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">),</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ingredients</span><span class="p">:</span>
                            <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ingr</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>
                        <span class="n">mat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
                        <span class="n">mat</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
                        <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                        <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">))</span>
                        <span class="n">ingredients</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">])</span>
                <span class="n">o</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">molecules</span>
        <span class="c1"># consider that one filling have occured</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_ingredients</span><span class="p">())</span> <span class="ow">and</span> <span class="n">tree</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_ingr_bhtree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(),</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cFill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ingr_result</span> <span class="o">=</span> <span class="n">ingredients</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freePoint</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restoreFreePoints</span><span class="p">(</span><span class="n">freePoint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ingredients</span></div>


<div class="viewcode-block" id="Environment.restoreFreePoints">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.restoreFreePoints">[docs]</a>
    <span class="k">def</span> <span class="nf">restoreFreePoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freePoint</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freePointsAfterFill</span> <span class="o">=</span> <span class="n">freePoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbFreePointsAfterFill</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freePoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distanceAfterFill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distancesAfterFill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">distToClosestSurf</span></div>


<div class="viewcode-block" id="Environment.loadFreePoint">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.loadFreePoint">[docs]</a>
    <span class="k">def</span> <span class="nf">loadFreePoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="p">):</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="n">freePoint</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">freePoint</span></div>


<div class="viewcode-block" id="Environment.store">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.store">[docs]</a>
    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="n">resultfilename</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">fixOnePath</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rfile</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_ingredients</span><span class="p">(),</span> <span class="n">rfile</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rfile</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">free_points</span><span class="p">,</span> <span class="n">rfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.dropOneIngr">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.dropOneIngr">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">dropOneIngr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">&gt;,&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;&lt;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">&gt;,&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;&lt;</span><span class="si">%f</span><span class="s2">&gt;,&lt;</span><span class="si">%s</span><span class="s2">&gt;,&lt;</span><span class="si">%d</span><span class="s2">&gt;,&lt;</span><span class="si">%d</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span></div>


<div class="viewcode-block" id="Environment.getOneIngr">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getOneIngr">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getOneIngr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">3</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ingrname</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">4</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ingrcompNum</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">5</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ptInd</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">rad</span></div>


    <span class="c1">#    @classmethod</span>
<div class="viewcode-block" id="Environment.getOneIngrJson">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getOneIngrJson">[docs]</a>
    <span class="k">def</span> <span class="nf">getOneIngrJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">ingrdic</span><span class="p">):</span>
        <span class="c1">#        name_ingr = ingr.name</span>
        <span class="c1">#        if name_ingr not in ingrdic:</span>
        <span class="c1">#            name_ingr = ingr.composition_name</span>
        <span class="c1">#        for r in ingr.results:</span>
        <span class="c1">#            ingrdic[name_ingr][&quot;results&quot;].append([r[0]],r[1],)</span>
        <span class="c1">#        print (&quot;growingr?&quot;,ingr,ingr.name,isinstance(ingr, GrowIngredient))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">GrowIngredient</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">ActinIngredient</span><span class="p">):</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">nbCurve</span> <span class="o">=</span> <span class="n">ingrdic</span><span class="p">[</span><span class="s2">&quot;nbCurve&quot;</span><span class="p">]</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">nbCurve</span><span class="p">):</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingrdic</span><span class="p">[</span><span class="s2">&quot;curve&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
            <span class="c1">#            print (&quot;nbCurve?&quot;,ingr.nbCurve,ingrdic[&quot;nbCurve&quot;])</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">ingrdic</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">],</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span><span class="p">,</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">compartment_id</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ingrdic[&quot;compartment_id&quot;],1,ingrdic[&quot;encapsulating_radius&quot;]</span></div>


<div class="viewcode-block" id="Environment.load_asTxt">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.load_asTxt">[docs]</a>
    <span class="k">def</span> <span class="nf">load_asTxt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="c1"># needto parse</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">orgaresult</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># [[],]*len(self.compartments)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)):</span>
            <span class="n">orgaresult</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="c1">#        mry90 = helper.rotation_matrix(-math.pi/2.0, [0.0,1.0,0.0])</span>
        <span class="c1">#        numpy.array([[0.0, 1.0, 0.0, 0.0],</span>
        <span class="c1">#                 [-1., 0.0, 0.0, 0.0],</span>
        <span class="c1">#                 [0.0, 0.0, 1.0, 0.0],</span>
        <span class="c1">#                 [0.0, 0.0, 0.0, 1.0]])</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOneIngr</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="c1"># should I multiply here</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
            <span class="p">)</span>  <span class="c1"># numpy.matrix(mry90)*numpy.matrix(numpy.array(rot).reshape(4,4))</span>
            <span class="k">if</span> <span class="n">ingrcompNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orgaresult</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ingrcompNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="c1">#        for i, orga in enumerate(self.compartments):</span>
            <span class="c1">#            orfile = open(resultfilename+&quot;ogra&quot;+str(i),&#39;rb&#39;)</span>
            <span class="c1">#            orgaresult.append(pickle.load(orfile))</span>
            <span class="c1">#            orfile.close()</span>
            <span class="c1">#        rfile.close()</span>
            <span class="c1">#        rfile = open(resultfilename+&quot;free_points&quot;,&#39;rb&#39;)</span>
        <span class="n">freePoint</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># pickle.load(rfile)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">freePoint</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
            <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">orgaresult</span><span class="p">,</span> <span class="n">freePoint</span></div>


<div class="viewcode-block" id="Environment.collectResultPerIngredient">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.collectResultPerIngredient">[docs]</a>
    <span class="k">def</span> <span class="nf">collectResultPerIngredient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">ingr</span><span class="p">):</span>
            <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loopThroughIngr</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_ingredients</span><span class="p">():</span>
            <span class="n">ingr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">ingredient</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">GrowIngredient</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">ActinIngredient</span><span class="p">):</span>
                <span class="k">pass</span>  <span class="c1"># already store</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">obj</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">rotation</span><span class="p">])</span></div>


<div class="viewcode-block" id="Environment.load_asJson">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.load_asJson">[docs]</a>
    <span class="k">def</span> <span class="nf">load_asJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>  <span class="c1"># doesnt work with symbol link ?</span>
            <span class="k">if</span> <span class="n">autopack</span><span class="o">.</span><span class="n">use_json_hook</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">fp</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span>
                <span class="p">)</span>  <span class="c1"># ,indent=4, separators=(&#39;,&#39;, &#39;: &#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="c1"># needto parse</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">orgaresult</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;exteriorRecipe&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">name_ingr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">]:</span>
                        <span class="c1"># backward compatiblity</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                            <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                    <span class="n">iresults</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">,</span> <span class="n">rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOneIngrJson</span><span class="p">(</span>
                        <span class="n">ingr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">][</span><span class="n">name_ingr</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">iresults</span><span class="p">:</span>
                        <span class="n">rot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                            <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
                        <span class="p">)</span>  <span class="c1"># numpy.matrix(mry90)*numpy.matrix(numpy.array(rot).reshape(4,4))</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">])</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># organelle ingr</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">orga</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
            <span class="n">orgaresult</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="c1"># organelle surface ingr</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">rs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                        <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span>
                        <span class="c1"># replace number by name ?</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surf_&quot;</span> <span class="o">+</span> <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surf_&quot;</span> <span class="o">+</span> <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">name_ingr</span>
                            <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="c1"># backward compatiblity</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                                <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span>
                            <span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                        <span class="p">(</span>
                            <span class="n">iresults</span><span class="p">,</span>
                            <span class="n">ingrname</span><span class="p">,</span>
                            <span class="n">ingrcompNum</span><span class="p">,</span>
                            <span class="n">ptInd</span><span class="p">,</span>
                            <span class="n">rad</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOneIngrJson</span><span class="p">(</span>
                            <span class="n">ingr</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">][</span><span class="n">name_ingr</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">iresults</span><span class="p">:</span>
                            <span class="n">rot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
                            <span class="p">)</span>  <span class="c1"># numpy.matrix(mry90)*numpy.matrix(numpy.array(rot).reshape(4,4))</span>
                            <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">])</span>
                            <span class="n">orgaresult</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ingrcompNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="p">)</span>
            <span class="c1"># organelle matrix ingr</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">ri</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                        <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_int_&quot;</span> <span class="o">+</span> <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_int_&quot;</span> <span class="o">+</span> <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">name_ingr</span>
                            <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="c1"># backward compatiblity</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                                <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span>
                            <span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">name_ingr</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                        <span class="p">(</span>
                            <span class="n">iresults</span><span class="p">,</span>
                            <span class="n">ingrname</span><span class="p">,</span>
                            <span class="n">ingrcompNum</span><span class="p">,</span>
                            <span class="n">ptInd</span><span class="p">,</span>
                            <span class="n">rad</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOneIngrJson</span><span class="p">(</span>
                            <span class="n">ingr</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">][</span><span class="n">name_ingr</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">iresults</span><span class="p">:</span>
                            <span class="n">rot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
                            <span class="p">)</span>  <span class="c1"># numpy.matrix(mry90)*numpy.matrix(numpy.array(rot).reshape(4,4))</span>
                            <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">])</span>
                            <span class="n">orgaresult</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ingrcompNum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrname</span><span class="p">,</span> <span class="n">ingrcompNum</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="p">)</span>
        <span class="n">freePoint</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># pickle.load(rfile)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">freePoint</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
            <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">orgaresult</span><span class="p">,</span> <span class="n">freePoint</span></div>


<div class="viewcode-block" id="Environment.dropOneIngrJson">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.dropOneIngrJson">[docs]</a>
    <span class="k">def</span> <span class="nf">dropOneIngrJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">rdic</span><span class="p">):</span>
        <span class="n">adic</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># [ingr.name]</span>
        <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;compartment_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">compartment_id</span>
        <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;encapsulating_radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">encapsulating_radius</span><span class="p">)</span>
        <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ingr</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;tolist&quot;</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;tolist&quot;</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">GrowIngredient</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="n">ActinIngredient</span><span class="p">):</span>
            <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;nbCurve&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">nbCurve</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">nbCurve</span><span class="p">):</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">adic</span><span class="p">[</span><span class="s2">&quot;curve&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ingr</span><span class="o">.</span><span class="n">listePtLinear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1">#        print adic</span>
        <span class="k">return</span> <span class="n">adic</span></div>


<div class="viewcode-block" id="Environment.store_asJson">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.store_asJson">[docs]</a>
    <span class="k">def</span> <span class="nf">store_asJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="n">autopack</span><span class="o">.</span><span class="n">fixOnePath</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">)</span>  <span class="c1"># retireve?</span>
        <span class="c1"># if result file_name start with http?</span>
        <span class="k">if</span> <span class="n">resultfilename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">resultfilename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ftp&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;please provide a correct file name for the result file &quot;</span><span class="p">,</span>
                <span class="n">resultfilename</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectResultPerIngredient</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;recipe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupfile</span>  <span class="c1"># replace server?</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">][</span>
                    <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngrJson</span><span class="p">(</span><span class="n">ingr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="s2">&quot;exteriorRecipe&quot;</span><span class="p">])</span>

        <span class="c1"># compartment ingr</span>
        <span class="k">for</span> <span class="n">orga</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="c1"># compartment surface ingr</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">rs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">][</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngrJson</span><span class="p">(</span>
                        <span class="n">ingr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_surfaceRecipe&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="c1"># compartment matrix ingr</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">ri</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">][</span>
                        <span class="n">ingr</span><span class="o">.</span><span class="n">composition_name</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngrJson</span><span class="p">(</span>
                        <span class="n">ingr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">[</span><span class="n">orga</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_innerRecipe&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>  <span class="c1"># doesnt work with symbol link ?</span>
            <span class="k">if</span> <span class="n">indent</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># ,indent=4, separators=(&#39;,&#39;, &#39;: &#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result_json</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># ,indent=4, separators=(&#39;,&#39;, &#39;: &#39;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok dump&quot;</span><span class="p">,</span> <span class="n">resultfilename</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.convertPickleToText">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.convertPickleToText">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">convertPickleToText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norga</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resultfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resultfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
        <span class="n">orgaresult</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norga</span><span class="p">):</span>
            <span class="n">orfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_organelle_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">orgaresult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">orfile</span><span class="p">))</span>
            <span class="n">orfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_free_points&quot;</span><span class="p">)</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">rfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrName</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrName</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">)</span>
            <span class="c1"># result.append([pos,rot,ingr.name,ingr.compartment_id,ptInd])</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norga</span><span class="p">):</span>
            <span class="n">orfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilename</span> <span class="o">+</span> <span class="s2">&quot;_organelle_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrName</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">,</span> <span class="n">ptInd</span> <span class="ow">in</span> <span class="n">orgaresult</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropOneIngr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ingrName</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">,</span> <span class="n">ptInd</span><span class="p">)</span>
            <span class="n">orfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">orfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

            <span class="c1"># freepoint</span>

<div class="viewcode-block" id="Environment.printFillInfo">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.printFillInfo">[docs]</a>
    <span class="k">def</span> <span class="nf">printFillInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Environment exterior recipe:&quot;</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">printFillInfo</span><span class="p">(</span><span class="s2">&quot;        &quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">printFillInfo</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.finishWithWater">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.finishWithWater">[docs]</a>
    <span class="k">def</span> <span class="nf">finishWithWater</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">free_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbFreePoints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># self.freePointsAfterFill[:self.nbFreePointsAfterFill]</span>
        <span class="c1"># sphere sphere of 2.9A</span>
        <span class="k">if</span> <span class="n">free_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freePointsAfterFill</span>
        <span class="k">if</span> <span class="n">nbFreePoints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nbFreePoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbFreePointsAfterFill</span></div>

        <span class="c1"># a freepoint is a voxel, how many water in the voxel</span>
        <span class="c1"># coords masterGridPositions</span>

    <span class="c1"># ==============================================================================</span>
    <span class="c1"># AFter this point, features development around physics engine and algo</span>
    <span class="c1"># octree</span>
    <span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="Environment.setupOctree">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setupOctree">[docs]</a>
    <span class="k">def</span> <span class="nf">setupOctree</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">octree</span> <span class="o">=</span> <span class="n">Octree</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getRadius</span><span class="p">(),</span> <span class="n">helper</span><span class="o">=</span><span class="n">helper</span>
            <span class="p">)</span>  <span class="c1"># Octree((0,0,0),self.grid.getRadius())   #0,0,0 or center of grid?</span></div>


<div class="viewcode-block" id="Environment.delRB">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.delRB">[docs]</a>
    <span class="k">def</span> <span class="nf">delRB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.setGeomFaces">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.setGeomFaces">[docs]</a>
    <span class="k">def</span> <span class="nf">setGeomFaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tris</span><span class="p">,</span> <span class="n">face</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.addMeshRBOrganelle">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.addMeshRBOrganelle">[docs]</a>
    <span class="k">def</span> <span class="nf">addMeshRBOrganelle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.addRB">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.addRB">[docs]</a>
    <span class="k">def</span> <span class="nf">addRB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s2">&quot;single_sphere&quot;</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.moveRBnode">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.moveRBnode">[docs]</a>
    <span class="k">def</span> <span class="nf">moveRBnode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.getRotTransRB">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.getRotTransRB">[docs]</a>
    <span class="k">def</span> <span class="nf">getRotTransRB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.runBullet">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.runBullet">[docs]</a>
    <span class="k">def</span> <span class="nf">runBullet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ingr</span><span class="p">,</span> <span class="n">simulationTimes</span><span class="p">,</span> <span class="n">runTimeDisplay</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.exportToBD_BOX">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.exportToBD_BOX">[docs]</a>
    <span class="k">def</span> <span class="nf">exportToBD_BOX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bd_type</span><span class="o">=</span><span class="s2">&quot;flex&quot;</span><span class="p">):</span>
        <span class="c1"># , call the BD_BOX exporter, plugin ? better if result store somewhere.</span>
        <span class="c1"># only sphere + boudary ?</span>
        <span class="c1"># sub ATM 216 225.0000 150.0000 525.0000 25.0000 -5.0000 50.0000 0.5922 1</span>
        <span class="k">if</span> <span class="n">bd_type</span> <span class="o">==</span> <span class="s2">&quot;flex&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">bd_box</span> <span class="kn">import</span> <span class="n">flex_box</span> <span class="k">as</span> <span class="n">bd_box</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">bd_box</span> <span class="kn">import</span> <span class="n">rigid_box</span> <span class="k">as</span> <span class="n">bd_box</span>
        <span class="k">if</span> <span class="n">res_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bd</span> <span class="o">=</span> <span class="n">bd_box</span><span class="p">(</span><span class="n">res_filename</span><span class="p">,</span> <span class="n">bounding_box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">makePrmFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectResultPerIngredient</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>

        <span class="c1"># compartment ingr</span>
        <span class="k">for</span> <span class="n">orga</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="c1"># compartment surface ingr</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">rs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
            <span class="c1"># compartment matrix ingr</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">ri</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.exportToTEM_SIM">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.exportToTEM_SIM">[docs]</a>
    <span class="k">def</span> <span class="nf">exportToTEM_SIM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">tem_sim</span> <span class="kn">import</span> <span class="n">tem_sim</span>

        <span class="k">if</span> <span class="n">res_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tem</span> <span class="o">=</span> <span class="n">tem_sim</span><span class="p">(</span><span class="n">res_filename</span><span class="p">,</span> <span class="n">bounding_box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectResultPerIngredient</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exteriorRecipe</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>

        <span class="c1"># compartment ingr</span>
        <span class="k">for</span> <span class="n">orga</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
            <span class="c1"># compartment surface ingr</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">surfaceRecipe</span>
            <span class="k">if</span> <span class="n">rs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
            <span class="c1"># compartment matrix ingr</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">orga</span><span class="o">.</span><span class="n">innerRecipe</span>
            <span class="k">if</span> <span class="n">ri</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ingr</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">ingredients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">addAutoPackIngredient</span><span class="p">(</span><span class="n">ingr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tem</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.exportToTEM">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.exportToTEM">[docs]</a>
    <span class="k">def</span> <span class="nf">exportToTEM</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># limited to 20 ingredients, call the TEM exporter plugin ?</span>
        <span class="c1"># ingredient -&gt; PDB file or mrc volume file</span>
        <span class="c1"># ingredient -&gt; coordinate.txt file</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># *0.05</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;iSutm_coordinate.txt&quot;</span>  <span class="c1"># ingrname_.txt</span>
        <span class="n">aStr</span> <span class="o">=</span> <span class="s2">&quot;# File created for TEM-simulator, version 1.3.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">aStr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; 6</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">aStr</span> <span class="o">+=</span> <span class="s2">&quot;#            x             y             z           phi         theta           psi</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
            <span class="n">aStr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0:14.4f}{1:14.4f}{2:14.4f}{3:14.4f}{4:14.4f}{5:14.4f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">rr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">aStr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.exportToReaDDy">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.exportToReaDDy">[docs]</a>
    <span class="k">def</span> <span class="nf">exportToReaDDy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># wehn I will get it running ... plugin ?</span>
        <span class="k">return</span></div>


        <span class="c1"># ==============================================================================</span>

    <span class="c1">#         Animate</span>
    <span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="Environment.linkTraj">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.linkTraj">[docs]</a>
    <span class="k">def</span> <span class="nf">linkTraj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># link the traj usin upy for creating a new synchronized calleback?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span><span class="p">:</span>
            <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">synchronize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">applyStep</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Environment.unlinkTraj">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.unlinkTraj">[docs]</a>
    <span class="k">def</span> <span class="nf">unlinkTraj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># link the traj usin upy for creating a new synchronized calleback?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span><span class="p">:</span>
            <span class="n">autopack</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">unsynchronize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">applyStep</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj_linked</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Environment.applyStep">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.applyStep">[docs]</a>
    <span class="k">def</span> <span class="nf">applyStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="c1"># apply the coordinate from a trajectory at step step.</span>
        <span class="c1"># correspondance ingredients instance &lt;-&gt; coordinates file</span>
        <span class="c1"># trajectory class to handle</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>
        <span class="c1"># if self.traj.traj_type==&quot;dcd&quot; or self.traj.traj_type==&quot;xyz&quot;:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">applyState_primitive_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></div>

        <span class="c1"># ho can we apply to parent instance the rotatiotn?</span>

<div class="viewcode-block" id="Environment.create_voxelization">
<a class="viewcode-back" href="../../../cellpack.autopack.html#cellpack.autopack.Environment.Environment.create_voxelization">[docs]</a>
    <span class="k">def</span> <span class="nf">create_voxelization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_writer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the image data for all molecules in the recipe by creating voxelized</span>
<span class="sd">        representations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image_writer: ImageWriter</span>
<span class="sd">            The image writer to use for writing the voxelized representations.</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        image_data: numpy.ndarray</span>
<span class="sd">            The updated image data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">channel_colors</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed_objects</span><span class="o">.</span><span class="n">get_all</span><span class="p">():</span>
            <span class="n">mesh_store</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image_writer</span><span class="o">.</span><span class="n">image_data</span><span class="p">:</span>
                <span class="n">image_writer</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="n">image_writer</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">color</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">color</span><span class="p">]):</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">color</span><span class="p">]</span>
                    <span class="n">channel_colors</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_compartment</span><span class="p">:</span>
                <span class="n">mesh_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_store</span>

            <span class="n">image_writer</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">ingredient</span><span class="o">.</span><span class="n">create_voxelization</span><span class="p">(</span>
                <span class="n">image_data</span><span class="o">=</span><span class="n">image_writer</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">,</span>
                <span class="n">voxel_size</span><span class="o">=</span><span class="n">image_writer</span><span class="o">.</span><span class="n">voxel_size</span><span class="p">,</span>
                <span class="n">image_size</span><span class="o">=</span><span class="n">image_writer</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span>
                <span class="n">position</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
                <span class="n">rotation</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">rotation</span><span class="p">,</span>
                <span class="n">hollow</span><span class="o">=</span><span class="n">image_writer</span><span class="o">.</span><span class="n">hollow</span><span class="p">,</span>
                <span class="n">mesh_store</span><span class="o">=</span><span class="n">mesh_store</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">image_writer</span><span class="o">.</span><span class="n">channel_colors</span> <span class="o">=</span> <span class="n">channel_colors</span>

        <span class="k">return</span> <span class="n">image_writer</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">cellPack 1.0.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../cellpack.html" >cellpack</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../autopack.html" >cellpack.autopack</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">cellpack.autopack.Environment</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2021, Megan Riel-Mehan.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>