name: Analyze

on:
    push:
        branches:
            - main
    pull_request:

jobs:
    Analyze:
        if: ${{ !contains(github.event.head_commit.message, 'Bump version') }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                python-version: [3.11]
                os: [ubuntu-latest]
        steps:
            - uses: actions/checkout@v4.2.2
            - uses: ./.github/actions/dependencies
            - name: Pack test recipe
              run: |
                  uv run pack -r cellpack/tests/recipes/v2/test_spheres.json -c cellpack/tests/packing-configs/test_config.json
            - name: Modify JSON with PR sub_directory path
              run: |
                  jq --arg branch_name "${{  github.ref_name  }}" '.create_report.output_image_location |= "https://cellpack-results.s3.us-west-2.amazonaws.com/\($branch_name)/spheresSST/figures"' cellpack/tests/analysis-configs/PR_analysis_config.json > cellpack/tests/analysis-configs/PR_analysis_config_temp.json
                  mv cellpack/tests/analysis-configs/PR_analysis_config_temp.json cellpack/tests/analysis-configs/PR_analysis_config.json
            - name: Run analysis code
              run: uv run analyze -r cellpack/tests/recipes/v2/test_spheres.json -a cellpack/tests/analysis-configs/PR_analysis_config.json -p cellpack/tests/outputs/test_spheres/spheresSST
            - name: Upload results
              uses: actions/upload-artifact@v4
              with:
                  name: results
                  path: cellpack/tests/outputs/test_spheres/
    Comment:
        runs-on: ubuntu-latest
        needs: [Analyze]
        steps:
            - uses: actions/checkout@v4.2.2
            - name: Configure AWS credentials for dependabot
              if: ${{ github.actor == 'dependabot[bot]' }}
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.DEPENDABOT_AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.DEPENDABOT_AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-west-2
            - name: Configure AWS credentials
              if: ${{ github.actor != 'dependabot[bot]' }}
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-west-2
            - uses: actions/download-artifact@v5
              with:
                  name: results
                  path: ./results
            - name: Copy files to results bucket
              run: aws s3 cp ./results s3://cellpack-results/${{  github.ref_name  }}/ --recursive --acl public-read
            - name: Update or create PR comment
              if: ${{ github.event_name == 'pull_request' }}
              env:
                  GH_TOKEN: ${{ github.actor == 'dependabot[bot]' && secrets.DEPENDABOT_TOKEN || secrets.GITHUB_TOKEN }}
              run: |
                  # Create comment body with watermark
                  echo "<!-- Analyze workflow report -->" > comment.md
                  echo "## Analyze Workflow Report" >> comment.md
                  cat ./results/analysis_report.md >> comment.md
                  
                  # Try to find existing comment with watermark and update it
                  COMMENT_ID=$(gh pr view ${{ github.event.pull_request.number }} --json comments --jq '.comments[] | select(.body | contains("<!-- Analyze workflow report -->")) | .id' | head -n1)
                  
                  if [ -n "$COMMENT_ID" ]; then
                    echo "Updating existing comment ID: $COMMENT_ID"
                    gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID -X PATCH -f body="$(cat comment.md)"
                  else
                    echo "Creating new comment"
                    gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
                  fi
                  
                  cat ./results/analysis_report.md
